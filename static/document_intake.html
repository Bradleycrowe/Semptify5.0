<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semptify - Document Intake</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        /* Auth Banner */
        .auth-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .auth-banner.not-authenticated {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
        }
        
        .auth-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .auth-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .auth-details h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .auth-details p {
            font-size: 13px;
            opacity: 0.85;
        }
        
        .auth-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .role-badge {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .provider-icon {
            width: 24px;
            height: 24px;
        }
        
        .btn-auth {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-auth:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .storage-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .storage-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .storage-indicator .dot.disconnected {
            background: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .card-header {
            background: var(--gray-50);
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .card-header .icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-50);
        }
        
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary);
            background: #eff6ff;
        }
        
        .upload-zone .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .upload-zone h3 {
            color: var(--gray-700);
            margin-bottom: 8px;
        }
        
        .upload-zone p {
            color: var(--gray-500);
            font-size: 14px;
        }
        
        .upload-zone input[type="file"] {
            display: none;
        }
        
        .file-types {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .file-type-badge {
            padding: 4px 10px;
            background: var(--gray-200);
            border-radius: 20px;
            font-size: 12px;
            color: var(--gray-600);
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-primary:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        /* Progress */
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #7c3aed);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 14px;
            color: var(--gray-600);
        }
        
        /* Status */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .status-original { background: #d1fae5; color: #065f46; }
        .status-copy { background: #fef3c7; color: #92400e; }
        .status-flagged { background: #fee2e2; color: #991b1b; }
        
        /* Results Section */
        .results-section {
            margin-top: 20px;
        }
        
        .result-card {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--gray-200);
        }
        
        .result-card h4 {
            font-size: 15px;
            color: var(--gray-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .result-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }
        
        .result-item .label {
            font-size: 12px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .result-item .value {
            font-size: 14px;
            color: var(--gray-800);
            font-weight: 500;
            word-break: break-all;
        }
        
        .result-item .value.mono {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        
        /* Extracted Data */
        .extracted-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .extracted-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--gray-200);
        }
        
        .extracted-item .main {
            flex: 1;
        }
        
        .extracted-item .title {
            font-weight: 500;
            color: var(--gray-800);
        }
        
        .extracted-item .subtitle {
            font-size: 13px;
            color: var(--gray-500);
        }
        
        .confidence-bar {
            width: 60px;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
        }
        
        /* Issues */
        .issue-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .issue-high {
            background: #fef2f2;
            border-color: #ef4444;
        }
        
        .issue-medium {
            background: #fffbeb;
            border-color: #f59e0b;
        }
        
        .issue-low {
            background: #eff6ff;
            border-color: #3b82f6;
        }
        
        .issue-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .issue-desc {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        /* Chain of Custody */
        .custody-timeline {
            position: relative;
            padding-left: 24px;
        }
        
        .custody-timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-300);
        }
        
        .custody-event {
            position: relative;
            margin-bottom: 16px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }
        
        .custody-event::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 16px;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--gray-300);
        }
        
        .custody-event .time {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .custody-event .action {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .custody-event .actor {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Recognition Engine Styles */
        .reasoning-chain {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reasoning-step {
            padding: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .reasoning-step strong {
            color: var(--primary);
        }

        .reasoning-step p {
            margin: 8px 0;
            color: var(--gray-700);
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 11px;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--secondary);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .forgery-indicators {
            margin-top: 12px;
            padding: 12px;
            background: #fef2f2;
            border-radius: 8px;
            border-left: 3px solid var(--danger);
        }

        .forgery-indicators ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .loading-state, .error-state {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Forgery Alerts */
        .forgery-alert {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: #fef2f2;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #fecaca;
        }
        
        .forgery-alert .icon {
            font-size: 20px;
        }
        
        .forgery-alert .content {
            flex: 1;
        }
        
        .forgery-alert .indicator {
            font-weight: 600;
            color: #991b1b;
        }
        
        .forgery-alert .description {
            font-size: 14px;
            color: #7f1d1d;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-500);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab:hover {
            color: var(--gray-700);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Document Queue */
        .document-queue {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .queue-item:hover {
            background: var(--gray-100);
        }
        
        .queue-item.selected {
            background: #eff6ff;
            border: 1px solid var(--primary);
        }
        
        .queue-item .file-icon {
            font-size: 24px;
        }
        
        .queue-item .info {
            flex: 1;
            min-width: 0;
        }
        
        .queue-item .filename {
            font-weight: 500;
            color: var(--gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .queue-item .meta {
            font-size: 13px;
            color: var(--gray-500);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
        }
        
        .toast-success {
            background: var(--success);
            color: white;
        }
        
        .toast-error {
            background: var(--danger);
            color: white;
        }
        
        .toast-warning {
            background: var(--warning);
            color: white;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray-500);
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* Hash Display */
        .hash-display {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            background: var(--gray-100);
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            margin-top: 4px;
        }
        
        /* Integrity Indicator */
        .integrity-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .integrity-verified {
            background: #d1fae5;
            color: #065f46;
        }
        
        .integrity-tampered {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .integrity-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* Score Display */
        .score-meter {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .score-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .score-fill.low { background: var(--success); }
        .score-fill.medium { background: var(--warning); }
        .score-fill.high { background: var(--danger); }

        .score-value {
            font-weight: 600;
            min-width: 40px;
        }

        /* ================================================================
           HELP TOOLTIP SYSTEM
           ================================================================ */
        
        /* Help Toggle Button */
        .help-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: all 0.3s;
        }

        .help-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .help-toggle.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .help-toggle .toggle-icon {
            font-size: 18px;
        }

        /* Tooltip Container - wraps elements that need help */
        .has-help {
            position: relative;
        }

        /* The tooltip itself */
        .help-tooltip {
            position: fixed;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            width: max-content;
            max-width: 320px;
            display: none;
            z-index: 99999;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        .help-tooltip::after {
            content: '';
            position: absolute;
            border: 8px solid transparent;
        }
        
        .help-tooltip.arrow-down::after {
            top: 100%;
            left: 20px;
            border-top-color: #111827;
        }
        
        .help-tooltip.arrow-up::after {
            bottom: 100%;
            left: 20px;
            border-bottom-color: #111827;
        }

        /* Highlight elements with help in help mode */
        body.help-mode .has-help {
            outline: 2px dashed #3b82f6;
            outline-offset: 2px;
        }

        /* Tooltip styling variations */
        .help-tooltip .tooltip-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            color: #60a5fa;
        }

        .help-tooltip .tooltip-when {
            color: #fbbf24;
            font-size: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .help-tooltip .tooltip-when::before {
            content: '‚è∞ When to use: ';
            font-weight: 600;
        }

        /* Pulsing indicator when help mode is on */
        body.help-mode .has-help::before {
            content: '?';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: #2563eb;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            animation: pulse-help 2s infinite;
        }

        @keyframes pulse-help {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Card-level help indicator */
        .card-help {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #1e40af;
        }

        body.help-mode .card-help {
            display: flex;
        }

        .card-help .help-icon {
            font-size: 16px;
        }

        /* Form Field Extraction Review Styles */
        .form-fields-section {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .form-fields-section.needs-review {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .form-fields-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
        }

        .form-fields-header:hover {
            background: var(--gray-200);
        }

        .form-fields-header h5 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-fields-body {
            padding: 16px;
            background: white;
        }

        .form-field-row {
            display: grid;
            grid-template-columns: 140px 1fr auto auto;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            margin: -4px -12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .form-field-row:hover {
            background: var(--gray-50);
        }

        .form-field-row + .form-field-row {
            border-top: 1px solid var(--gray-100);
            margin-top: 4px;
            padding-top: 14px;
        }

        .field-label {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .field-value {
            font-size: 14px;
            color: var(--gray-900);
        }

        .field-value input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .field-value input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .field-value input.needs-review {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .field-value input.confirmed {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .confidence-high {
            background: #d1fae5;
            color: #065f46;
        }

        .confidence-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .confidence-guess {
            background: #e0e7ff;
            color: #3730a3;
        }

        .field-actions {
            display: flex;
            gap: 4px;
        }

        .field-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .field-action-btn.confirm {
            background: #d1fae5;
            color: #065f46;
        }

        .field-action-btn.confirm:hover {
            background: #a7f3d0;
        }

        .field-action-btn.edit {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .field-action-btn.edit:hover {
            background: var(--gray-200);
        }

        .review-stats {
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .review-stat {
            text-align: center;
        }

        .review-stat .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .review-stat .stat-label {
            font-size: 11px;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .review-stat.needs-review .stat-value {
            color: #f59e0b;
        }

        .review-stat.confirmed .stat-value {
            color: #10b981;
        }

        .extract-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .extract-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .extract-btn.primary {
            background: var(--primary);
            color: white;
        }

        .extract-btn.primary:hover {
            background: var(--primary-dark);
        }

        .extract-btn.secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .extract-btn.secondary:hover {
            background: var(--gray-200);
        }

        .extract-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alternatives-dropdown {
            position: relative;
        }

        .alternatives-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .alternatives-list.show {
            display: block;
        }

        .alternative-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--gray-100);
        }

        .alternative-item:last-child {
            border-bottom: none;
        }

        .alternative-item:hover {
            background: var(--gray-50);
        }

        .section-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Site-wide header -->
    <script src="/static/js/header.js"></script>

    <div class="container">
        <!-- Auth Banner -->
        <div class="auth-banner" id="authBanner">
            <div class="auth-info">
                <div class="auth-avatar" id="authAvatar">üë§</div>
                <div class="auth-details">
                    <h3 id="authUserName">Loading...</h3>
                    <p id="authUserInfo">Checking authentication...</p>
                </div>
            </div>
            <div class="auth-actions">
                <div class="storage-indicator" id="storageIndicator">
                    <span class="dot" id="storageDot"></span>
                    <span id="storageStatus">Checking storage...</span>
                </div>
                <span class="role-badge" id="roleBadge">-</span>
                <button class="btn-auth" id="authButton" onclick="handleAuthAction()">Sign In</button>
            </div>
        </div>
        
        <header class="header">
            <h1>üìÑ Document Intake System</h1>
            <p>Upload, process, and securely register legal documents with tamper-proof verification</p>
        </header>
        
        <div class="main-grid">
            <!-- Left Column - Upload & Queue -->
            <div>
                <!-- Upload Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="icon">üì§</div>
                        <h2>Upload Documents</h2>
                    </div>
                    <div class="card-body">
                        <!-- Card-level help -->
                        <div class="card-help">
                            <span class="help-icon">üí°</span>
                            <span><strong>Upload Card:</strong> This is where you add new documents to the system. Upload legal documents like eviction notices, leases, or court papers to have them analyzed and securely registered.</span>
                        </div>

                        <!-- User info is now from session -->
                        <input type="hidden" id="userId" value="">

                        <div class="form-group has-help">
                            <label for="caseNumber">Case Number (Optional)</label>
                            <input type="text" id="caseNumber" placeholder="e.g., CASE-2024-001">
                            <div class="help-tooltip">
                                <div class="tooltip-title">üìã Case Number</div>
                                Link documents to a specific legal case. This helps organize all related documents together.
                                <div class="tooltip-when">Enter this if you have a court case number or want to group documents.</div>
                            </div>
                        </div>

                        <div class="upload-zone has-help" id="uploadZone">
                            <div class="icon">üìÅ</div>
                            <h3>Drop files here or click to upload</h3>
                            <p>Supports PDF, DOCX, JPEG, PNG, TIFF up to 25MB</p>
                            <div class="file-types">
                                <span class="file-type-badge">PDF</span>
                                <span class="file-type-badge">DOCX</span>
                                <span class="file-type-badge">JPEG</span>
                                <span class="file-type-badge">PNG</span>
                                <span class="file-type-badge">TIFF</span>
                            </div>
                            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.tiff,.tif">
                            <div class="help-tooltip tooltip-bottom">
                                <div class="tooltip-title">üì§ Upload Zone</div>
                                Drag and drop files here OR click to browse your computer. You can upload multiple files at once.
                                <div class="tooltip-when">Use this to add any legal document you've received (eviction notice, lease, court summons, etc.)</div>
                            </div>
                        </div>

                        <div class="progress-container" id="uploadProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progressStatus">Uploading...</span>
                                <span id="progressPercent">0%</span>
                            </div>
                        </div>
                    </div>
                </div>                <!-- Document Queue -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="icon">üìã</div>
                        <h2>Document Queue</h2>
                    </div>
                    <div class="card-body">
                        <!-- Card-level help -->
                        <div class="card-help">
                            <span class="help-icon">üí°</span>
                            <span><strong>Document Queue:</strong> Shows documents you've uploaded that are waiting to be processed or registered. Click any document to select it and see its analysis results on the right.</span>
                        </div>
                        <div class="document-queue" id="documentQueue">
                            <div class="empty-state">
                                <div class="icon">üì≠</div>
                                <p>No documents uploaded yet</p>
                            </div>
                        </div>

                        <div class="button-group">
                            <div class="has-help" style="display: inline-block;">
                                <button class="btn btn-primary" id="processAllBtn" disabled>
                                    ‚öôÔ∏è Process All
                                </button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">‚öôÔ∏è Process All Documents</div>
                                    <strong>What:</strong> Analyzes all uploaded documents using AI to extract dates, parties, deadlines, and legal issues.<br><br>
                                    <strong>Why:</strong> Processing identifies key information and potential problems in your documents automatically.<br><br>
                                    <strong>When:</strong> Click after uploading documents. Button is disabled until you have unprocessed documents.
                                    <div class="tooltip-when">Tip: Processing takes a few seconds per document.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="btn btn-success" id="registerAllBtn" disabled>
                                    ‚úì Register All
                                </button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">‚úì Register All Documents</div>
                                    <strong>What:</strong> Creates a tamper-proof record of each document with cryptographic hash verification.<br><br>
                                    <strong>Why:</strong> Registration proves the document existed at this time and hasn't been altered - critical for court evidence.<br><br>
                                    <strong>When:</strong> Click after processing to permanently register documents. Cannot be undone.
                                    <div class="tooltip-when">Tip: Registered documents get a unique ID like SEM-2025-000001.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="btn btn-outline" id="clearQueueBtn" disabled>
                                    üóëÔ∏è Clear
                                </button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üóëÔ∏è Clear Upload Queue</div>
                                    <strong>What:</strong> Removes all documents from the current upload queue (NOT registered documents).<br><br>
                                    <strong>Why:</strong> Start fresh if you uploaded wrong files or want to begin a new batch.<br><br>
                                    <strong>When:</strong> Click to clear the queue. Already registered documents are NOT affected.
                                    <div class="tooltip-when">Tip: Use "Clear All" in Registered Documents to delete from database.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Registered Documents List -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="icon">üìö</div>
                        <h2>Registered Documents</h2>
                        <div class="has-help" style="display: inline-block; margin-left: auto;">
                            <button class="btn btn-outline" onclick="loadRegisteredDocuments()" style="padding: 6px 12px; font-size: 12px;">
                                üîÑ Refresh
                            </button>
                            <div class="help-tooltip tooltip-bottom">
                                <div class="tooltip-title">üîÑ Refresh List</div>
                                <strong>What:</strong> Reloads the list of registered documents from the server.<br><br>
                                <strong>When:</strong> Click if you registered documents in another tab or want to see the latest status.
                            </div>
                        </div>
                        <div class="has-help" style="display: inline-block;">
                            <button class="btn btn-outline" onclick="clearAllRegisteredDocuments()" style="padding: 6px 12px; font-size: 12px; margin-left: 8px; color: #dc2626; border-color: #dc2626;">
                                üóëÔ∏è Clear All
                            </button>
                            <div class="help-tooltip tooltip-bottom">
                                <div class="tooltip-title">üóëÔ∏è Clear ALL Registered Documents</div>
                                <strong>What:</strong> PERMANENTLY deletes ALL registered documents from the database.<br><br>
                                <strong>Why:</strong> Use to start completely fresh with a clean slate.<br><br>
                                <strong>When:</strong> Only when you want to remove ALL documents. This cannot be undone!
                                <div class="tooltip-when">‚ö†Ô∏è WARNING: This action is irreversible!</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Card-level help -->
                        <div class="card-help">
                            <span class="help-icon">üí°</span>
                            <span><strong>Registered Documents:</strong> Shows ALL documents that have been officially registered. Click any document to view its details, verify integrity, or see chain of custody.</span>
                        </div>
                        <div id="registeredDocsList" class="document-queue" style="max-height: 400px;">
                            <div class="empty-state">
                                <div class="icon">üì≠</div>
                                <p>Loading registered documents...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Results -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="icon">üìä</div>
                        <h2>Analysis Results</h2>
                    </div>
                    <div class="card-body">
                        <!-- Card-level help -->
                        <div class="card-help">
                            <span class="help-icon">üí°</span>
                            <span><strong>Analysis Results:</strong> View extracted data from your documents. Use the tabs to see different types of information: Overview, Extracted Data, Issues, Registry details, and Chain of Custody.</span>
                        </div>
                        <div class="tabs">
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab active" data-tab="overview">Overview</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üìÑ Overview Tab</div>
                                    Shows a summary of the selected document: filename, type, size, and processing status.
                                    <div class="tooltip-when">Click to see basic document info at a glance.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab" data-tab="extraction">Extracted Data</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üîç Extracted Data Tab</div>
                                    Shows all data extracted from the document: dates, deadlines, monetary amounts, and parties mentioned.
                                    <div class="tooltip-when">Click to see what information was found in your document.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab" data-tab="issues">Issues</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">‚ö†Ô∏è Issues Tab</div>
                                    Shows any problems or concerns detected: illegal clauses, missing deadlines, or potential tenant rights violations.
                                    <div class="tooltip-when">Click to see warnings that need your attention.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab" data-tab="formfields">Form Fields</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üìù Form Fields Tab</div>
                                    Review and confirm data extracted for court forms. Verify tenant info, landlord info, property details, and amounts before generating forms.
                                    <div class="tooltip-when">Click to review all form-ready data before filling out court documents.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab" data-tab="registry">Registry</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üîê Registry Tab</div>
                                    Shows the official registration: unique document ID, content hash, forgery analysis, and verification status.
                                    <div class="tooltip-when">Click to see proof that your document is securely registered.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab" data-tab="custody">Chain of Custody</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üîó Chain of Custody Tab</div>
                                    Shows complete history: when the document was uploaded, processed, registered, accessed, and by whom.
                                    <div class="tooltip-when">Click to see the full audit trail - useful for legal evidence.</div>
                                </div>
                            </div>
                            <div class="has-help" style="display: inline-block;">
                                <button class="tab" data-tab="recognition">üîç Recognition</button>
                                <div class="help-tooltip tooltip-bottom">
                                    <div class="tooltip-title">üîç AI Recognition Tab</div>
                                    Advanced AI-powered document analysis with multi-pass reasoning, legal domain expertise, handwriting analysis, and forgery detection.
                                    <div class="tooltip-when">Click to run deep analysis with confidence scoring and relationship mapping.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Overview Tab -->
                        <div class="tab-content active" id="tab-overview">
                            <div id="overviewContent">
                                <div class="empty-state">
                                    <div class="icon">üìÑ</div>
                                    <p>Select a document to view details</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Extraction Tab -->
                        <div class="tab-content" id="tab-extraction">
                            <div id="extractionContent">
                                <div class="empty-state">
                                    <div class="icon">üîç</div>
                                    <p>Process a document to see extracted data</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Issues Tab -->
                        <div class="tab-content" id="tab-issues">
                            <div id="issuesContent">
                                <div class="empty-state">
                                    <div class="icon">‚ö†Ô∏è</div>
                                    <p>No issues detected yet</p>
                                </div>
                            </div>
                        </div>

                        <!-- Form Fields Tab -->
                        <div class="tab-content" id="tab-formfields">
                            <div id="formFieldsContent">
                                <div class="empty-state">
                                    <div class="icon">üìù</div>
                                    <p>Extract form fields from your documents to prepare for court form filling</p>
                                    <button class="btn btn-primary" onclick="extractFormFields()" style="margin-top: 12px;">
                                        üîç Extract Form Fields
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Registry Tab -->
                        <div class="tab-content" id="tab-registry">
                            <div id="registryContent">
                                <div class="empty-state">
                                    <div class="icon">üîê</div>
                                    <p>Register a document to view security details</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custody Tab -->
                        <div class="tab-content" id="tab-custody">
                            <div id="custodyContent">
                                <div class="empty-state">
                                    <div class="icon">üîó</div>
                                    <p>Chain of custody will appear here</p>
                                </div>
                            </div>
                        </div>

                        <!-- Recognition Tab -->
                        <div class="tab-content" id="tab-recognition">
                            <div id="recognitionContent">
                                <div class="empty-state">
                                    <div class="icon">üîç</div>
                                    <p>Select a document and click "Run Recognition" to analyze</p>
                                    <button class="btn btn-primary" onclick="runRecognitionAnalysis()" id="runRecognitionBtn" disabled>
                                        üß† Run Recognition Analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Help Toggle Button -->
    <button class="help-toggle" id="helpToggle" onclick="toggleHelpMode()">
        <span class="toggle-icon">‚ùì</span>
        <span id="helpToggleText">Show Help</span>
    </button>

    <!-- Celebration Libraries -->
    <script src="/static/js/notification-toast.js"></script>
    <script src="/static/js/confetti.js"></script>
    <script src="/static/js/emotion-integration.js"></script>

    <script>
        // =====================================================================
        // Configuration
        // =====================================================================
        const API_BASE = window.location.origin;

        // =====================================================================
        // Help Mode System
        // =====================================================================
        let helpModeEnabled = localStorage.getItem('helpMode') === 'true';

        function toggleHelpMode() {
            helpModeEnabled = !helpModeEnabled;
            localStorage.setItem('helpMode', helpModeEnabled);
            updateHelpMode();
        }

        function updateHelpMode() {
            const toggle = document.getElementById('helpToggle');
            const toggleText = document.getElementById('helpToggleText');
            
            if (helpModeEnabled) {
                document.body.classList.add('help-mode');
                toggle.classList.add('active');
                toggleText.textContent = 'Hide Help';
            } else {
                document.body.classList.remove('help-mode');
                toggle.classList.remove('active');
                toggleText.textContent = 'Show Help';
            }
        }

        // Initialize help mode on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateHelpMode();
            setupTooltipPositioning();
        });
        
        // Setup tooltip positioning for .has-help elements
        function setupTooltipPositioning() {
            document.querySelectorAll('.has-help').forEach(el => {
                const tooltip = el.querySelector('.help-tooltip');
                if (!tooltip) return;
                
                // Move tooltip to body for proper z-index and overflow handling
                document.body.appendChild(tooltip);
                
                el.addEventListener('mouseenter', () => {
                    if (!document.body.classList.contains('help-mode')) return;
                    positionTooltip(el, tooltip);
                    tooltip.style.display = 'block';
                });
                
                el.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }
        
        // Position tooltip toward center of card
        function positionTooltip(element, tooltip) {
            tooltip.style.visibility = 'hidden';
            tooltip.style.display = 'block';
            
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Find parent card
            const card = element.closest('.card, .intake-section, .tab-content');
            const cardRect = card ? card.getBoundingClientRect() : { left: 0, right: viewportWidth, top: 0, bottom: viewportHeight };
            
            const cardCenterY = (cardRect.top + cardRect.bottom) / 2;
            const elemCenterY = rect.top + rect.height / 2;
            const inTopHalf = elemCenterY < cardCenterY;
            
            // Reset arrows
            tooltip.classList.remove('arrow-up', 'arrow-down');
            
            let top, left;
            
            // Position toward card center vertically
            if (inTopHalf) {
                top = rect.bottom + 12;
                tooltip.classList.add('arrow-up');
            } else {
                top = rect.top - tooltipRect.height - 12;
                tooltip.classList.add('arrow-down');
            }
            
            // Position horizontally - align left edge with element, shift toward center
            left = rect.left;
            
            // Keep within viewport
            if (left + tooltipRect.width > viewportWidth - 20) {
                left = viewportWidth - tooltipRect.width - 20;
            }
            if (left < 20) left = 20;
            if (top < 10) top = rect.bottom + 12;
            if (top + tooltipRect.height > viewportHeight - 10) {
                top = rect.top - tooltipRect.height - 12;
            }
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.style.visibility = 'visible';
        }

        // =====================================================================
        // State
        // =====================================================================
        let documents = [];
        let selectedDocId = null;
        let currentUser = null;
        let accessToken = null;
        let isAuthenticated = false;
        
        // =====================================================================
        // DOM Elements
        // =====================================================================
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const documentQueue = document.getElementById('documentQueue');
        const progressContainer = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        const progressPercent = document.getElementById('progressPercent');
        const processAllBtn = document.getElementById('processAllBtn');
        const registerAllBtn = document.getElementById('registerAllBtn');
        const clearQueueBtn = document.getElementById('clearQueueBtn');
        const toastContainer = document.getElementById('toastContainer');
        
        // Auth Elements
        const authBanner = document.getElementById('authBanner');
        const authAvatar = document.getElementById('authAvatar');
        const authUserName = document.getElementById('authUserName');
        const authUserInfo = document.getElementById('authUserInfo');
        const authButton = document.getElementById('authButton');
        const roleBadge = document.getElementById('roleBadge');
        const storageDot = document.getElementById('storageDot');
        const storageStatus = document.getElementById('storageStatus');
        
        // =====================================================================
        // Authentication & Session Management
        // =====================================================================
        
        // User ID Format: <provider><role><8-char-random>
        // Provider: G=Google Drive, D=Dropbox, O=OneDrive
        // Role: U=User, M=Manager, V=Advocate, L=Legal, A=Admin
        // Example: GU7x9kM2pQ = Google Drive + User + 7x9kM2pQ
        
        const PROVIDER_CODES = {
            'G': { id: 'google_drive', name: 'Google Drive', icon: 'üîµ' },
            'D': { id: 'dropbox', name: 'Dropbox', icon: 'üíß' },
            'O': { id: 'onedrive', name: 'OneDrive', icon: '‚òÅÔ∏è' }
        };
        
        const ROLE_CODES = {
            'U': { id: 'user', name: 'User' },
            'M': { id: 'manager', name: 'Manager' },
            'V': { id: 'advocate', name: 'Advocate' },
            'L': { id: 'legal', name: 'Legal' },
            'A': { id: 'admin', name: 'Admin' }
        };

        function parseUserId(userId) {
            if (!userId || userId.length < 3) return null;
            
            const providerChar = userId[0].toUpperCase();
            const roleChar = userId[1].toUpperCase();
            const uniquePart = userId.substring(2);
            
            const provider = PROVIDER_CODES[providerChar];
            const role = ROLE_CODES[roleChar];
            
            if (!provider || !role) return null;
            
            return {
                userId: userId,
                provider: provider.id,
                providerName: provider.name,
                providerIcon: provider.icon,
                role: role.id,
                roleName: role.name,
                uniquePart: uniquePart
            };
        }
        
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        async function checkAuthStatus(retryCount = 0) {
            try {
                // Check cookie for user ID
                let semptifyUid = getCookie('semptify_uid');

                // If coming from welcome page and no cookie yet, wait and retry
                const fromWelcome = new URLSearchParams(window.location.search).get('from') === 'welcome';

                if (!semptifyUid && fromWelcome && retryCount < 3) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    return checkAuthStatus(retryCount + 1);
                }

                // If no cookie, auto-create a session user (allow immediate use)
                if (!semptifyUid) {
                    const uniquePart = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                    semptifyUid = 'SU' + uniquePart; // S = Session, U = User
                    const maxAge = 24 * 60 * 60; // 24 hours for session user
                    document.cookie = `semptify_uid=${semptifyUid}; path=/; max-age=${maxAge}; SameSite=Lax`;
                    console.log('Session user created:', semptifyUid);
                }

                // Parse user ID to get provider
                let parsed = parseUserId(semptifyUid);

                // If parsing fails, create a session user context
                if (!parsed) {
                    parsed = {
                        provider: 'S',
                        providerName: 'Session',
                        providerIcon: 'üîê',
                        role: 'U',
                        roleName: 'User',
                        uniquePart: semptifyUid.substring(2)
                    };
                }
                
                // Clear URL parameters after reading them (clean URL)
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('type') || urlParams.has('from')) {
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }

                // Valid cookie - set up user context
                currentUser = {
                    id: semptifyUid,
                    provider: parsed.provider,
                    providerName: parsed.providerName,
                    providerIcon: parsed.providerIcon,
                    role: parsed.role,
                    roleName: parsed.roleName,
                    uniquePart: parsed.uniquePart
                };

                // Update hidden user ID field
                document.getElementById('userId').value = currentUser.id;

                // Check server session status
                const statusResponse = await fetch(`${API_BASE}/storage/status`, {
                    credentials: 'include'
                });
                const statusData = await statusResponse.json();

                if (statusData.authenticated && statusData.access_token) {
                    // Full session with access token
                    accessToken = statusData.access_token;
                    isAuthenticated = true;
                    updateAuthUI(true);
                    showToast(`Welcome back! Connected as ${currentUser.roleName}`, 'success');
                } else {
                    // Have cookie - user is "signed in" but may need OAuth for cloud storage
                    isAuthenticated = true;  // User is signed in with cookie
                    accessToken = null;      // Just no cloud storage token yet
                    updateAuthUI(true, false);
                    showToast(`Signed in as ${currentUser.roleName} (${currentUser.providerName})`, 'success');
                }

            } catch (error) {
                console.error('Auth check failed:', error);
                // On error, check if we at least have a valid cookie
                const semptifyUid = getCookie('semptify_uid');
                if (semptifyUid) {
                    const parsed = parseUserId(semptifyUid);
                    if (parsed) {
                        currentUser = {
                            id: semptifyUid,
                            provider: parsed.provider,
                            providerName: parsed.providerName,
                            providerIcon: parsed.providerIcon,
                            role: parsed.role,
                            roleName: parsed.roleName,
                            uniquePart: parsed.uniquePart
                        };
                        document.getElementById('userId').value = currentUser.id;
                        isAuthenticated = true;
                        updateAuthUI(true, false);
                        return;
                    }
                }
                // No valid session at all - continue anyway with limited functionality
                console.log('No valid session - continuing in session mode');
            }
        }

        function updateAuthUI(authenticated, needsReauth = false) {
            if (authenticated && currentUser) {
                authBanner.classList.remove('not-authenticated');
                authAvatar.textContent = currentUser.providerIcon || getProviderIcon(currentUser.provider);
                authUserName.textContent = `${currentUser.roleName} ‚Ä¢ ${currentUser.id}`;
                authUserInfo.textContent = `Storage: ${currentUser.providerName}`;
                authButton.textContent = 'Sign Out';
                authButton.onclick = handleLogout;
                roleBadge.textContent = currentUser.roleName;
                storageDot.classList.remove('disconnected');
                storageStatus.textContent = `${currentUser.providerName} connected`;
                
                // Enable upload
                uploadZone.style.opacity = '1';
                uploadZone.style.pointerEvents = 'auto';
                
            } else if (needsReauth && currentUser) {
                // Have user ID but need to re-authenticate
                authBanner.classList.add('not-authenticated');
                authAvatar.textContent = currentUser.providerIcon || 'üîí';
                authUserName.textContent = `${currentUser.roleName} ‚Ä¢ Session Expired`;
                authUserInfo.textContent = `Re-authenticate with ${currentUser.providerName}`;
                authButton.textContent = 'Sign In';
                authButton.onclick = () => {
                    // Redirect to specific provider auth
                    window.location.href = `${API_BASE}/storage/auth/${currentUser.provider}?existing_uid=${currentUser.id}`;
                };
                roleBadge.textContent = currentUser.roleName;
                storageDot.classList.add('disconnected');
                storageStatus.textContent = 'Reconnect needed';
                
                // Disable upload
                uploadZone.style.opacity = '0.5';
                uploadZone.style.pointerEvents = 'none';
                
            } else {
                authBanner.classList.add('not-authenticated');
                authAvatar.textContent = 'üîí';
                authUserName.textContent = 'Not Signed In';
                authUserInfo.textContent = 'Connect your cloud storage to upload documents';
                authButton.textContent = 'Sign In';
                authButton.onclick = handleAuthAction;
                roleBadge.textContent = '-';
                storageDot.classList.add('disconnected');
                storageStatus.textContent = 'Not connected';
                
                // Disable upload
                uploadZone.style.opacity = '0.5';
                uploadZone.style.pointerEvents = 'none';
            }
        }
        
        function getProviderIcon(provider) {
            const icons = {
                'google_drive': 'üîµ',
                'dropbox': 'üíß',
                'onedrive': '‚òÅÔ∏è'
            };
            return icons[provider] || 'üìÅ';
        }
        
        function handleAuthAction() {
            // Redirect to storage providers page
            window.location.href = `${API_BASE}/storage/providers`;
        }
        
        async function handleLogout() {
            try {
                await fetch(`${API_BASE}/storage/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                // Clear cookie
                document.cookie = 'semptify_uid=; path=/; max-age=0';

                currentUser = null;
                accessToken = null;
                isAuthenticated = false;
                documents = [];
                selectedDocId = null;

                showToast('Signed out successfully', 'success');
                
                // Redirect to welcome page after short delay
                setTimeout(() => {
                    window.location.href = '/static/welcome.html';
                }, 1000);

            } catch (error) {
                showToast('Logout failed', 'error');
            }
        }
        
        function clearAllTabs() {
            document.getElementById('overviewContent').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üìÑ</div>
                    <p>Select a document to view details</p>
                </div>
            `;
            document.getElementById('extractionContent').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üîç</div>
                    <p>Process a document to see extracted data</p>
                </div>
            `;
            document.getElementById('issuesContent').innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚ö†Ô∏è</div>
                    <p>No issues detected yet</p>
                </div>
            `;
            document.getElementById('registryContent').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üîê</div>
                    <p>Register a document to view security details</p>
                </div>
            `;
            document.getElementById('custodyContent').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üîó</div>
                    <p>Chain of custody will appear here</p>
                </div>
            `;
        }
        
        // =====================================================================
        // Upload Handling
        // =====================================================================
        uploadZone.addEventListener('click', () => {
            if (!isAuthenticated) {
                showToast('Please sign in first to upload documents', 'warning');
                return;
            }
            fileInput.click();
        });
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (isAuthenticated) {
                uploadZone.classList.add('dragover');
            }
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            if (!isAuthenticated) {
                showToast('Please sign in first to upload documents', 'warning');
                return;
            }
            
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            if (!isAuthenticated) {
                showToast('Please sign in first to upload documents', 'warning');
                fileInput.value = '';
                return;
            }
            handleFiles(e.target.files);
            fileInput.value = '';
        });
        
        async function handleFiles(files) {
            if (!isAuthenticated || !currentUser) {
                showToast('Please sign in first', 'warning');
                return;
            }
            
            const userId = currentUser.id;
            
            for (const file of files) {
                if (file.size > 25 * 1024 * 1024) {
                    showToast(`${file.name} exceeds 25MB limit`, 'error');
                    continue;
                }
                await uploadFile(file, userId);
            }
        }
        
        async function uploadFile(file, userId) {
            showProgress(true);
            updateProgress(10, 'Uploading...');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', userId);
            
            try {
                const response = await fetch(`${API_BASE}/api/intake/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const data = await response.json();
                updateProgress(100, 'Upload complete!');
                
                documents.push({
                    id: data.id,
                    filename: data.filename,
                    status: data.status,
                    file: file,
                    processed: false,
                    registered: false,
                    extraction: null,
                    registration: null,
                    userId: userId
                });
                
                renderQueue();
                showToast(`${file.name} uploaded successfully`, 'success');
                
                // Celebrate document upload with emotion engine
                if (typeof EmotionEngine !== 'undefined') {
                    EmotionEngine.trigger('document_uploaded');
                }
                if (typeof SemptifyConfetti !== 'undefined') {
                    SemptifyConfetti.burst();
                }

            } catch (error) {
                showToast(`Upload failed: ${error.message}`, 'error');
            } finally {
                setTimeout(() => showProgress(false), 1000);
            }
        }
        
        // =====================================================================
        // Document Processing
        // =====================================================================
        async function processDocument(doc) {
            updateProgress(30, `Processing ${doc.filename}...`);
            showProgress(true);
            
            try {
                // Start processing
                const processResponse = await fetch(`${API_BASE}/api/intake/process/${doc.id}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!processResponse.ok) {
                    throw new Error('Processing failed');
                }
                
                updateProgress(60, 'Analyzing document...');
                
                // Poll for status
                let status = 'PROCESSING';
                let attempts = 0;
                
                while (status === 'PROCESSING' && attempts < 30) {
                    await new Promise(r => setTimeout(r, 1000));
                    
                    const statusResponse = await fetch(`${API_BASE}/api/intake/status/${doc.id}`, {
                        credentials: 'include'
                    });
                    const statusData = await statusResponse.json();
                    status = statusData.status;
                    
                    updateProgress(60 + (attempts * 2), statusData.status_message);
                    attempts++;
                }
                
                // Get full document data
                const docResponse = await fetch(`${API_BASE}/api/intake/documents/${doc.id}`, {
                    credentials: 'include'
                });
                const docData = await docResponse.json();
                
                doc.processed = true;
                doc.status = docData.status;
                doc.extraction = docData.extraction;
                
                updateProgress(100, 'Processing complete!');
                renderQueue();
                
                if (selectedDocId === doc.id) {
                    showDocumentDetails(doc);
                }
                
                showToast(`${doc.filename} processed`, 'success');
                
            } catch (error) {
                showToast(`Processing failed: ${error.message}`, 'error');
            } finally {
                setTimeout(() => showProgress(false), 1000);
            }
        }
        
        // =====================================================================
        // Document Registration
        // =====================================================================
        async function registerDocument(doc) {
            updateProgress(30, `Registering ${doc.filename}...`);
            showProgress(true);
            
            const caseNumber = document.getElementById('caseNumber').value.trim();
            const userId = currentUser?.id || doc.userId;
            
            const formData = new FormData();
            formData.append('file', doc.file);
            formData.append('user_id', userId);
            if (caseNumber) {
                formData.append('case_number', caseNumber);
            }
            if (doc.id) {
                formData.append('intake_document_id', doc.id);
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/registry/register`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Registration failed');
                }
                
                const data = await response.json();
                updateProgress(100, 'Registration complete!');
                
                doc.registered = true;
                doc.registration = data;
                doc.documentId = data.document_id;
                
                renderQueue();
                
                if (selectedDocId === doc.id) {
                    showDocumentDetails(doc);
                }

                showToast(`${doc.filename} registered: ${data.document_id}`, 'success');
                
                // üéâ Major milestone: Document registered! Big celebration
                if (typeof EmotionEngine !== 'undefined') {
                    EmotionEngine.trigger('task_completed');
                }
                if (typeof SemptifyConfetti !== 'undefined') {
                    SemptifyConfetti.celebrate(); // Full celebration for registration
                }
                if (typeof SemptifyToast !== 'undefined') {
                    SemptifyToast.milestone('Document Registered!', 'Your document is now officially in the system.', 5000);
                }

                if (data.requires_review) {
                    showToast('‚ö†Ô∏è Document requires manual review', 'warning');
                }
                
            } catch (error) {
                showToast(`Registration failed: ${error.message}`, 'error');
            } finally {
                setTimeout(() => showProgress(false), 1000);
            }
        }
        
        // =====================================================================
        // Save to Vault (Cloud Storage)
        // =====================================================================
        async function saveToVault(doc) {
            if (!isAuthenticated || !accessToken) {
                showToast('Please sign in to save to vault', 'warning');
                return;
            }
            
            updateProgress(30, `Saving ${doc.filename} to vault...`);
            showProgress(true);
            
            const formData = new FormData();
            formData.append('file', doc.file);
            formData.append('access_token', accessToken);
            
            // Add document type if extracted
            if (doc.extraction?.doc_type) {
                formData.append('document_type', doc.extraction.doc_type);
            }
            
            // Add description with document ID and case number
            let description = `Registered Document: ${doc.documentId || doc.id}`;
            const caseNumber = document.getElementById('caseNumber').value.trim();
            if (caseNumber) {
                description += ` | Case: ${caseNumber}`;
            }
            formData.append('description', description);
            
            // Add tags
            const tags = [];
            if (doc.registered) tags.push('registered');
            if (doc.processed) tags.push('processed');
            if (doc.registration?.status) tags.push(doc.registration.status.toLowerCase());
            formData.append('tags', tags.join(','));
            
            try {
                const response = await fetch(`${API_BASE}/api/vault/upload`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Vault upload failed');
                }
                
                const data = await response.json();
                updateProgress(100, 'Saved to vault!');
                
                doc.savedToVault = true;
                doc.vaultInfo = data;

                renderQueue();
                showToast(`${doc.filename} saved to ${currentUser.providerName}`, 'success');
                
                // Celebrate vault save
                if (typeof EmotionEngine !== 'undefined') {
                    EmotionEngine.trigger('evidence_saved');
                }
                if (typeof SemptifyConfetti !== 'undefined') {
                    SemptifyConfetti.burst();
                }

            } catch (error) {
                showToast(`Vault save failed: ${error.message}`, 'error');
            } finally {
                setTimeout(() => showProgress(false), 1000);
            }
        }
        
        // =====================================================================
        // Fetch Chain of Custody
        // =====================================================================
        async function fetchCustodyChain(documentId) {
            try {
                const response = await fetch(`${API_BASE}/api/registry/documents/${documentId}/custody`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to fetch custody chain');
                return await response.json();
            } catch (error) {
                console.error('Custody fetch error:', error);
                return [];
            }
        }
        
        // =====================================================================
        // Verify Integrity
        // =====================================================================
        async function verifyIntegrity(documentId) {
            try {
                const response = await fetch(`${API_BASE}/api/registry/documents/${documentId}/verify`, {
                    method: 'GET',
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Verification failed');
                return await response.json();
            } catch (error) {
                showToast(`Verification failed: ${error.message}`, 'error');
                return null;
            }
        }

        // =====================================================================
        // Registered Documents List
        // =====================================================================
        let registeredDocs = [];

        async function loadRegisteredDocuments() {
            const listContainer = document.getElementById('registeredDocsList');
            listContainer.innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <p>Loading...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/api/registry/documents`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load documents');
                
                registeredDocs = await response.json();
                renderRegisteredDocuments();
            } catch (error) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <p>Failed to load documents: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function clearAllRegisteredDocuments() {
            const count = registeredDocs ? registeredDocs.length : 0;
            
            if (count === 0) {
                showToast('No documents to clear', 'info');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è WARNING: This will permanently delete ${count} registered document(s).\n\nThis action cannot be undone!\n\nAre you sure you want to continue?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/registry/documents?confirm=true`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to clear documents');
                }
                
                const result = await response.json();
                showToast(`‚úÖ ${result.message}`, 'success');
                
                // Clear local state and reload
                registeredDocs = [];
                renderRegisteredDocuments();
                
            } catch (error) {
                showToast(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function renderRegisteredDocuments() {
            const listContainer = document.getElementById('registeredDocsList');
            
            if (!registeredDocs || registeredDocs.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>No registered documents yet</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = registeredDocs.map(doc => {
                const filename = doc.original_filename || doc.filename || 'Unknown';
                const status = doc.integrity_status || doc.status || 'unknown';
                const forgeryScore = doc.forgery_score || 0;
                const isDuplicate = doc.is_duplicate || false;
                const registeredAt = doc.registered_at ? new Date(doc.registered_at).toLocaleDateString() : 'N/A';
                
                return `
                <div class="queue-item" onclick="viewRegisteredDoc('${doc.document_id}')" style="cursor: pointer;">
                    <div class="file-icon">${getFileIcon(filename)}</div>
                    <div class="info" style="flex: 1;">
                        <div class="filename" style="font-weight: 600;">${filename}</div>
                        <div class="meta" style="font-size: 12px; color: #666;">
                            <span style="font-family: monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${doc.document_id}</span>
                        </div>
                        <div class="meta" style="font-size: 11px; margin-top: 4px;">
                            ${status === 'verified' || status === 'registered' ? '‚úÖ' : status === 'quarantined' ? '‚ö†Ô∏è' : 'üìã'} ${status}
                            ${forgeryScore > 0.3 ? `<span style="color: #dc2626;">| ‚ö†Ô∏è Forgery: ${Math.round(forgeryScore * 100)}%</span>` : ''}
                            ${isDuplicate ? '<span style="color: #f59e0b;">| üìã Duplicate</span>' : ''}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 11px; color: #888;">
                        ${registeredAt}
                    </div>
                </div>
            `}).join('');
        }

        async function viewRegisteredDoc(docId) {
            try {
                // Fetch full document details
                const response = await fetch(`${API_BASE}/api/registry/documents/${docId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load document');
                
                const doc = await response.json();
                
                // Show in the registry tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="registry"]').classList.add('active');
                document.getElementById('tab-registry').classList.add('active');
                
                // Display document info
                const registryContent = document.getElementById('registryContent');
                registryContent.innerHTML = `
                    <div class="integrity-indicator ${doc.integrity_status === 'verified' ? 'integrity-verified' : 'integrity-tampered'}">
                        <span>${doc.integrity_status === 'verified' ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <span><strong>${doc.integrity_status.toUpperCase()}</strong></span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="label">Document ID:</span>
                        <span class="value" style="font-family: monospace;">${doc.document_id}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Filename:</span>
                        <span class="value">${doc.filename}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Status:</span>
                        <span class="value">${doc.status}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Registered:</span>
                        <span class="value">${new Date(doc.registered_at).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Forgery Score:</span>
                        <span class="value" style="color: ${doc.forgery_score > 0.3 ? '#dc2626' : '#10b981'}">
                            ${Math.round(doc.forgery_score * 100)}%
                        </span>
                    </div>
                    ${doc.is_duplicate ? `
                        <div class="detail-row">
                            <span class="label">Original Document:</span>
                            <span class="value" style="font-family: monospace;">${doc.original_document_id || 'N/A'}</span>
                        </div>
                    ` : ''}
                    
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Content Hash</h4>
                    <div class="hash-display">${doc.content_hash}</div>
                    
                    ${doc.forgery_alerts && doc.forgery_alerts.length > 0 ? `
                        <h4 style="margin-top: 20px; margin-bottom: 10px;">‚ö†Ô∏è Forgery Alerts</h4>
                        ${doc.forgery_alerts.map(alert => `
                            <div class="forgery-alert">
                                <div class="content">
                                    <div class="indicator">${alert.indicator}</div>
                                    <div class="description">${alert.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    ` : ''}
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-outline" onclick="viewRegisteredDocCustody('${docId}')">
                            üîó View Chain of Custody
                        </button>
                        <button class="btn btn-outline" onclick="verifyAndUpdate('${docId}')">
                            üîç Verify Integrity
                        </button>
                    </div>
                `;
                
                showToast(`Loaded document ${docId}`, 'success');
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function viewRegisteredDocCustody(docId) {
            try {
                const response = await fetch(`${API_BASE}/api/registry/documents/${docId}/custody`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load custody chain');
                
                const custody = await response.json();
                
                // Switch to custody tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="custody"]').classList.add('active');
                document.getElementById('tab-custody').classList.add('active');
                
                const custodyContent = document.getElementById('custodyContent');
                custodyContent.innerHTML = `
                    <h4 style="margin-bottom: 15px;">Chain of Custody for ${docId}</h4>
                    <div class="custody-chain">
                        ${custody.map((record, i) => `
                            <div class="custody-record" style="padding: 12px; background: ${i % 2 === 0 ? '#f9fafb' : '#fff'}; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #2563eb;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong>${record.action}</strong>
                                    <span style="font-size: 12px; color: #666;">${new Date(record.timestamp).toLocaleString()}</span>
                                </div>
                                <div style="font-size: 13px; color: #444;">${record.details || 'No details'}</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">
                                    Actor: ${record.actor} ${record.ip_address ? `| IP: ${record.ip_address}` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // =====================================================================
        // Queue Rendering
        // =====================================================================
        function renderQueue() {
            if (documents.length === 0) {
                documentQueue.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>No documents uploaded yet</p>
                    </div>
                `;
                processAllBtn.disabled = true;
                registerAllBtn.disabled = true;
                clearQueueBtn.disabled = true;
                return;
            }
            
            documentQueue.innerHTML = documents.map(doc => `
                <div class="queue-item ${selectedDocId === doc.id ? 'selected' : ''}" onclick="selectDocument('${doc.id}')">
                    <div class="file-icon">${getFileIcon(doc.filename)}</div>
                    <div class="info">
                        <div class="filename">${doc.filename}</div>
                        <div class="meta">
                            ${doc.documentId || doc.id.substring(0, 12)}...
                            ${doc.savedToVault ? '‚Ä¢ ‚òÅÔ∏è Vault' : doc.registered ? '‚Ä¢ üîê Registered' : doc.processed ? '‚Ä¢ ‚úì Processed' : ''}
                        </div>
                    </div>
                    <span class="status-badge status-${doc.savedToVault ? 'original' : doc.registered ? 'original' : doc.processed ? 'completed' : 'pending'}">
                        ${doc.savedToVault ? 'In Vault' : doc.registered ? 'Registered' : doc.processed ? 'Processed' : 'Pending'}
                    </span>
                </div>
            `).join('');
            
            processAllBtn.disabled = !documents.some(d => !d.processed);
            registerAllBtn.disabled = !documents.some(d => !d.registered);
            clearQueueBtn.disabled = false;
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                pdf: 'üìï',
                doc: 'üìò',
                docx: 'üìò',
                jpg: 'üñºÔ∏è',
                jpeg: 'üñºÔ∏è',
                png: 'üñºÔ∏è',
                tiff: 'üñºÔ∏è',
                tif: 'üñºÔ∏è'
            };
            return icons[ext] || 'üìÑ';
        }
        
        // =====================================================================
        // Document Selection & Details
        // =====================================================================
        function selectDocument(id) {
            selectedDocId = id;
            renderQueue();
            const doc = documents.find(d => d.id === id);
            if (doc) {
                showDocumentDetails(doc);
            }
        }
        
        function showDocumentDetails(doc) {
            showOverview(doc);
            showExtraction(doc);
            showIssues(doc);
            showFormFields(doc);
            showRegistry(doc);
            showCustody(doc);
            showRecognition(doc);
        }
        
        function showOverview(doc) {
            const container = document.getElementById('overviewContent');
            
            container.innerHTML = `
                <div class="result-card">
                    <h4>üìÑ Document Information</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Filename</div>
                            <div class="value">${doc.filename}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Intake ID</div>
                            <div class="value mono">${doc.id}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Status</div>
                            <div class="value">
                                <span class="status-badge status-${doc.registered ? 'original' : doc.processed ? 'completed' : 'pending'}">
                                    ${doc.registered ? 'Registered' : doc.processed ? 'Processed' : 'Pending'}
                                </span>
                            </div>
                        </div>
                        ${doc.documentId ? `
                        <div class="result-item">
                            <div class="label">Document ID</div>
                            <div class="value mono">${doc.documentId}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${doc.extraction ? `
                <div class="result-card">
                    <h4>üè∑Ô∏è Classification</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Document Type</div>
                            <div class="value">${formatDocType(doc.extraction.doc_type)}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Confidence</div>
                            <div class="value">${(doc.extraction.doc_type_confidence * 100).toFixed(1)}%</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Language</div>
                            <div class="value">${doc.extraction.language.toUpperCase()}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Pages</div>
                            <div class="value">${doc.extraction.page_count}</div>
                        </div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h4>üìù Summary</h4>
                    <p style="color: var(--gray-700); line-height: 1.6;">${doc.extraction.summary}</p>
                    ${doc.extraction.key_points?.length ? `
                        <ul style="margin-top: 12px; padding-left: 20px; color: var(--gray-600);">
                            ${doc.extraction.key_points.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
                ` : `
                <div class="button-group" style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="processDocument(documents.find(d => d.id === '${doc.id}'))">
                        ‚öôÔ∏è Process Document
                    </button>
                </div>
                `}
                
                ${doc.processed && !doc.registered ? `
                <div class="button-group" style="margin-top: 16px;">
                    <button class="btn btn-success" onclick="registerDocument(documents.find(d => d.id === '${doc.id}'))">
                        üîê Register Document
                    </button>
                </div>
                ` : ''}
                
                ${doc.registered && !doc.savedToVault && isAuthenticated ? `
                <div class="button-group" style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="saveToVault(documents.find(d => d.id === '${doc.id}'))">
                        ‚òÅÔ∏è Save to ${currentUser?.providerName || 'Cloud Storage'}
                    </button>
                </div>
                ` : ''}
                
                ${doc.savedToVault ? `
                <div class="result-card" style="margin-top: 16px; background: #d1fae5; border-color: #10b981;">
                    <h4>‚òÅÔ∏è Saved to Cloud Storage</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Storage Provider</div>
                            <div class="value">${currentUser?.providerName || 'Cloud'}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Vault Path</div>
                            <div class="value mono">${doc.vaultInfo?.storage_path || '.semptify/vault/'}</div>
                        </div>
                        ${doc.vaultInfo?.certificate_id ? `
                        <div class="result-item">
                            <div class="label">Certificate ID</div>
                            <div class="value mono">${doc.vaultInfo.certificate_id}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        function showExtraction(doc) {
            const container = document.getElementById('extractionContent');
            
            if (!doc.extraction) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <p>Process the document to see extracted data</p>
                    </div>
                `;
                return;
            }
            
            const { dates, parties, amounts } = doc.extraction;
            
            container.innerHTML = `
                <div class="result-card">
                    <h4>üìÖ Extracted Dates (${dates?.length || 0})</h4>
                    <div class="extracted-list">
                        ${dates?.length ? dates.map(d => `
                            <div class="extracted-item">
                                <div class="main">
                                    <div class="title">${d.date}</div>
                                    <div class="subtitle">${d.label} ${d.is_deadline ? '‚è∞ Deadline' : ''}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${d.confidence * 100}%"></div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--gray-500);">${(d.confidence * 100).toFixed(0)}%</div>
                                </div>
                            </div>
                        `).join('') : '<p style="color: var(--gray-500); padding: 12px;">No dates extracted</p>'}
                    </div>
                </div>
                
                <div class="result-card">
                    <h4>üë• Extracted Parties (${parties?.length || 0})</h4>
                    <div class="extracted-list">
                        ${parties?.length ? parties.map(p => `
                            <div class="extracted-item">
                                <div class="main">
                                    <div class="title">${p.name}</div>
                                    <div class="subtitle">${p.role}${p.address ? ' ‚Ä¢ ' + p.address : ''}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${p.confidence * 100}%"></div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--gray-500);">${(p.confidence * 100).toFixed(0)}%</div>
                                </div>
                            </div>
                        `).join('') : '<p style="color: var(--gray-500); padding: 12px;">No parties extracted</p>'}
                    </div>
                </div>
                
                <div class="result-card">
                    <h4>üí∞ Extracted Amounts (${amounts?.length || 0})</h4>
                    <div class="extracted-list">
                        ${amounts?.length ? amounts.map(a => `
                            <div class="extracted-item">
                                <div class="main">
                                    <div class="title">${a.currency} ${a.amount.toLocaleString()}</div>
                                    <div class="subtitle">${a.label}${a.period ? ' ‚Ä¢ ' + a.period : ''}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${a.confidence * 100}%"></div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--gray-500);">${(a.confidence * 100).toFixed(0)}%</div>
                                </div>
                            </div>
                        `).join('') : '<p style="color: var(--gray-500); padding: 12px;">No amounts extracted</p>'}
                    </div>
                </div>
            `;
        }
        
        function showIssues(doc) {
            const container = document.getElementById('issuesContent');
            
            if (!doc.extraction?.issues?.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <p>No issues detected</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = doc.extraction.issues.map(issue => `
                <div class="issue-item issue-${issue.severity.toLowerCase()}">
                    <div class="issue-title">${getSeverityIcon(issue.severity)} ${issue.title}</div>
                    <div class="issue-desc">${issue.description}</div>
                    ${issue.recommended_action ? `
                        <div style="margin-top: 8px; font-size: 13px;">
                            <strong>Recommended Action:</strong> ${issue.recommended_action}
                        </div>
                    ` : ''}
                    ${issue.deadline ? `
                        <div style="margin-top: 4px; font-size: 13px; color: #991b1b;">
                            <strong>‚è∞ Deadline:</strong> ${issue.deadline}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // =====================================================================
        // Form Field Extraction Functions
        // =====================================================================
        
        let extractedFormFields = null;
        let confirmedFields = new Set();
        
        function showFormFields(doc) {
            const container = document.getElementById('formFieldsContent');
            
            if (!doc.extraction && !extractedFormFields) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <p>Extract form fields from your documents to prepare for court form filling</p>
                        <button class="btn btn-primary" onclick="extractFormFields()" style="margin-top: 12px;">
                            üîç Extract Form Fields
                        </button>
                    </div>
                `;
                return;
            }
            
            // If we have extraction results, show the form field review UI
            if (extractedFormFields) {
                renderFormFieldsReview(container, extractedFormFields);
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <p>Document processed. Click below to extract form fields for court documents.</p>
                        <button class="btn btn-primary" onclick="extractFormFields()" style="margin-top: 12px;">
                            üîç Extract Form Fields
                        </button>
                    </div>
                `;
            }
        }
        
        async function extractFormFields() {
            const container = document.getElementById('formFieldsContent');
            
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <p>Extracting form fields from all vault documents...</p>
                    <div class="loading-spinner" style="margin-top: 12px;"></div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/api/extraction/extract-from-vault`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to extract form fields');
                }
                
                const data = await response.json();
                extractedFormFields = data;
                confirmedFields = new Set();
                
                renderFormFieldsReview(container, data);
                showToast('Form fields extracted successfully', 'success');
                
            } catch (error) {
                console.error('Error extracting form fields:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ùå</div>
                        <p>Error extracting form fields: ${error.message}</p>
                        <button class="btn btn-primary" onclick="extractFormFields()" style="margin-top: 12px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
                showToast('Error extracting form fields', 'error');
            }
        }
        
        function renderFormFieldsReview(container, data) {
            const fields = data.fields || data;
            
            // Count stats
            let totalFields = 0;
            let needsReview = 0;
            let confirmed = confirmedFields.size;
            
            const categories = ['case_info', 'tenant', 'landlord', 'property', 'lease', 'dates', 'amounts'];
            categories.forEach(cat => {
                if (fields[cat]) {
                    Object.keys(fields[cat]).forEach(key => {
                        const field = fields[cat][key];
                        if (field && (field.value || field.value === 0)) {
                            totalFields++;
                            if (field.needs_review) needsReview++;
                        }
                    });
                }
            });
            
            container.innerHTML = `
                <!-- Stats -->
                <div class="review-stats">
                    <div class="review-stat">
                        <div class="stat-value">${totalFields}</div>
                        <div class="stat-label">Total Fields</div>
                    </div>
                    <div class="review-stat needs-review">
                        <div class="stat-value">${needsReview}</div>
                        <div class="stat-label">Needs Review</div>
                    </div>
                    <div class="review-stat confirmed">
                        <div class="stat-value">${confirmed}</div>
                        <div class="stat-label">Confirmed</div>
                    </div>
                </div>
                
                <!-- Case Information -->
                ${renderFieldSection('case_info', 'üìã Case Information', fields.case_info, {
                    case_number: 'Case Number',
                    court_name: 'Court Name',
                    county: 'County',
                    judicial_district: 'Judicial District'
                })}
                
                <!-- Tenant Information -->
                ${renderFieldSection('tenant', 'üë§ Tenant Information', fields.tenant, {
                    name: 'Full Name',
                    address: 'Street Address',
                    unit: 'Unit/Apt',
                    city: 'City',
                    state: 'State',
                    zip_code: 'ZIP Code',
                    phone: 'Phone',
                    email: 'Email'
                })}
                
                <!-- Landlord Information -->
                ${renderFieldSection('landlord', 'üè¢ Landlord Information', fields.landlord, {
                    name: 'Full Name / Company',
                    address: 'Street Address',
                    city: 'City',
                    state: 'State',
                    zip_code: 'ZIP Code',
                    phone: 'Phone',
                    email: 'Email'
                })}
                
                <!-- Property Information -->
                ${renderFieldSection('property', 'üè† Property Details', fields.property, {
                    address: 'Property Address',
                    unit: 'Unit/Apt',
                    city: 'City',
                    state: 'State',
                    zip_code: 'ZIP Code'
                })}
                
                <!-- Lease Information -->
                ${renderFieldSection('lease', 'üìù Lease Details', fields.lease, {
                    monthly_rent: 'Monthly Rent',
                    security_deposit: 'Security Deposit',
                    lease_start: 'Lease Start Date',
                    lease_end: 'Lease End Date'
                })}
                
                <!-- Important Dates -->
                ${renderFieldSection('dates', 'üìÖ Important Dates', fields.dates, {
                    summons_date: 'Summons Date',
                    hearing_date: 'Hearing Date',
                    hearing_time: 'Hearing Time',
                    answer_deadline: 'Answer Deadline',
                    notice_date: 'Notice Date'
                })}
                
                <!-- Amounts Claimed -->
                ${renderFieldSection('amounts', 'üí∞ Amounts Claimed', fields.amounts, {
                    rent_claimed: 'Rent Claimed',
                    late_fees: 'Late Fees',
                    damages_claimed: 'Damages',
                    total_claimed: 'Total Claimed'
                })}
                
                <!-- Actions -->
                <div class="extract-actions">
                    <button class="extract-btn secondary" onclick="extractFormFields()">
                        üîÑ Re-Extract
                    </button>
                    <button class="extract-btn primary" onclick="applyToFormData()" ${needsReview > 0 && confirmed < needsReview ? 'disabled title="Please review flagged fields first"' : ''}>
                        ‚úÖ Apply to Forms
                    </button>
                </div>
            `;
            
            // Attach event listeners to field inputs
            container.querySelectorAll('.field-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    updateFieldValue(e.target.dataset.category, e.target.dataset.field, e.target.value);
                });
            });
        }
        
        function renderFieldSection(category, title, fields, fieldDefs) {
            if (!fields) return '';
            
            const hasNeedsReview = Object.values(fields).some(f => f && f.needs_review);
            const entries = Object.entries(fieldDefs).filter(([key]) => fields[key]);
            
            if (entries.length === 0) return '';
            
            return `
                <div class="form-fields-section ${hasNeedsReview ? 'needs-review' : ''}">
                    <div class="form-fields-header" onclick="toggleSection(this)">
                        <h5>
                            <span>${title}</span>
                            ${hasNeedsReview ? '<span style="color: #f59e0b; font-size: 12px;">‚ö†Ô∏è Review needed</span>' : ''}
                        </h5>
                        <div class="section-toggle">‚ñº</div>
                    </div>
                    <div class="form-fields-body">
                        ${entries.map(([key, label]) => renderField(category, key, label, fields[key])).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderField(category, fieldKey, label, field) {
            if (!field) return '';
            
            const fieldId = `${category}_${fieldKey}`;
            const isConfirmed = confirmedFields.has(fieldId);
            const confidenceClass = getConfidenceClass(field.confidence);
            const needsReviewClass = field.needs_review ? 'needs-review' : '';
            const confirmedClass = isConfirmed ? 'confirmed' : '';
            
            return `
                <div class="form-field-row">
                    <div class="field-label">${label}</div>
                    <div class="field-value">
                        <input type="text" 
                               class="field-input ${needsReviewClass} ${confirmedClass}"
                               data-category="${category}"
                               data-field="${fieldKey}"
                               value="${escapeHtml(field.value || '')}"
                               placeholder="Not found">
                    </div>
                    <div class="confidence-badge ${confidenceClass}">
                        ${getConfidenceIcon(field.confidence)} ${field.confidence || 'EMPTY'}
                    </div>
                    <div class="field-actions">
                        <button class="field-action-btn confirm" 
                                onclick="confirmField('${category}', '${fieldKey}')"
                                title="Confirm this value">
                            ‚úì
                        </button>
                        ${field.alternatives && field.alternatives.length > 0 ? `
                            <button class="field-action-btn edit" 
                                    onclick="showAlternatives('${category}', '${fieldKey}')"
                                    title="Show alternatives">
                                ‚ñº
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function getConfidenceClass(confidence) {
            if (!confidence) return 'confidence-low';
            const c = confidence.toUpperCase();
            if (c === 'HIGH') return 'confidence-high';
            if (c === 'MEDIUM') return 'confidence-medium';
            if (c === 'LOW') return 'confidence-low';
            if (c === 'GUESS') return 'confidence-guess';
            return 'confidence-low';
        }
        
        function getConfidenceIcon(confidence) {
            if (!confidence) return '‚ùì';
            const c = confidence.toUpperCase();
            if (c === 'HIGH') return '‚úÖ';
            if (c === 'MEDIUM') return '‚ö†Ô∏è';
            if (c === 'LOW') return 'üî¥';
            if (c === 'GUESS') return 'ü§î';
            return '‚ùì';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            return text.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function toggleSection(header) {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.section-toggle');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.classList.remove('collapsed');
            } else {
                body.style.display = 'none';
                toggle.classList.add('collapsed');
            }
        }
        
        function confirmField(category, fieldKey) {
            const fieldId = `${category}_${fieldKey}`;
            confirmedFields.add(fieldId);
            
            // Update the input styling
            const input = document.querySelector(`input[data-category="${category}"][data-field="${fieldKey}"]`);
            if (input) {
                input.classList.remove('needs-review');
                input.classList.add('confirmed');
            }
            
            // Update stats
            updateReviewStats();
            showToast('Field confirmed', 'success');
        }
        
        function updateFieldValue(category, fieldKey, newValue) {
            if (extractedFormFields && extractedFormFields.fields) {
                if (extractedFormFields.fields[category] && extractedFormFields.fields[category][fieldKey]) {
                    extractedFormFields.fields[category][fieldKey].value = newValue;
                    // Auto-confirm when user edits a field
                    confirmField(category, fieldKey);
                }
            }
        }
        
        function updateReviewStats() {
            const statsContainer = document.querySelector('.review-stats');
            if (!statsContainer || !extractedFormFields) return;
            
            const fields = extractedFormFields.fields || extractedFormFields;
            let needsReview = 0;
            
            const categories = ['case_info', 'tenant', 'landlord', 'property', 'lease', 'dates', 'amounts'];
            categories.forEach(cat => {
                if (fields[cat]) {
                    Object.keys(fields[cat]).forEach(key => {
                        const field = fields[cat][key];
                        const fieldId = `${cat}_${key}`;
                        if (field && field.needs_review && !confirmedFields.has(fieldId)) {
                            needsReview++;
                        }
                    });
                }
            });
            
            const needsReviewStat = statsContainer.querySelector('.needs-review .stat-value');
            const confirmedStat = statsContainer.querySelector('.confirmed .stat-value');
            
            if (needsReviewStat) needsReviewStat.textContent = needsReview;
            if (confirmedStat) confirmedStat.textContent = confirmedFields.size;
            
            // Enable/disable apply button
            const applyBtn = document.querySelector('.extract-btn.primary');
            if (applyBtn) {
                if (needsReview === 0) {
                    applyBtn.disabled = false;
                    applyBtn.removeAttribute('title');
                }
            }
        }
        
        function showAlternatives(category, fieldKey) {
            const fields = extractedFormFields?.fields || extractedFormFields;
            const field = fields?.[category]?.[fieldKey];
            
            if (!field || !field.alternatives || field.alternatives.length === 0) {
                showToast('No alternatives found', 'info');
                return;
            }
            
            const input = document.querySelector(`input[data-category="${category}"][data-field="${fieldKey}"]`);
            if (!input) return;
            
            // Create dropdown
            let dropdown = input.parentElement.querySelector('.alternatives-list');
            if (dropdown) {
                dropdown.classList.toggle('show');
                return;
            }
            
            dropdown = document.createElement('div');
            dropdown.className = 'alternatives-list show';
            dropdown.innerHTML = field.alternatives.map(alt => 
                `<div class="alternative-item" onclick="selectAlternative('${category}', '${fieldKey}', '${escapeHtml(alt)}')">${escapeHtml(alt)}</div>`
            ).join('');
            
            input.parentElement.style.position = 'relative';
            input.parentElement.appendChild(dropdown);
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 0);
        }
        
        function selectAlternative(category, fieldKey, value) {
            const input = document.querySelector(`input[data-category="${category}"][data-field="${fieldKey}"]`);
            if (input) {
                input.value = value;
                updateFieldValue(category, fieldKey, value);
            }
            
            // Remove dropdown
            const dropdown = input?.parentElement?.querySelector('.alternatives-list');
            if (dropdown) dropdown.remove();
        }
        
        async function applyToFormData() {
            if (!extractedFormFields) {
                showToast('No form fields to apply', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/extraction/apply-to-forms`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: extractedFormFields.fields || extractedFormFields
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to apply form data');
                }
                
                const result = await response.json();
                showToast('Form data applied successfully! Ready for form filling.', 'success');
                
                // Optionally navigate to form filler or show success state
                const container = document.getElementById('formFieldsContent');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state" style="background: #d1fae5; border-radius: 12px; padding: 24px;">
                            <div class="icon">‚úÖ</div>
                            <p style="color: #065f46; font-weight: 600;">Form data applied successfully!</p>
                            <p style="color: #047857; font-size: 14px;">Your extracted data is now ready to be used in court form filling.</p>
                            <div class="button-group" style="margin-top: 16px;">
                                <button class="btn btn-primary" onclick="window.location.href='/static/form_filler.html'">
                                    üìù Go to Form Filler
                                </button>
                                <button class="btn btn-outline" onclick="extractFormFields()">
                                    üîÑ Extract Again
                                </button>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error applying form data:', error);
                showToast('Error applying form data: ' + error.message, 'error');
            }
        }
        
        async function showRegistry(doc) {
            const container = document.getElementById('registryContent');
            
            if (!doc.registration) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîê</div>
                        <p>Register the document to view security details</p>
                    </div>
                `;
                return;
            }
            
            const reg = doc.registration;
            
            container.innerHTML = `
                <div class="integrity-indicator ${reg.integrity_status === 'VERIFIED' ? 'integrity-verified' : 'integrity-pending'}">
                    ${reg.integrity_status === 'VERIFIED' ? '‚úÖ' : '‚è≥'} 
                    Integrity Status: <strong>${reg.integrity_status}</strong>
                </div>
                
                <div class="result-card">
                    <h4>üÜî Document Identity</h4>
                    <div class="result-grid">
                        <div class="result-item" style="grid-column: span 2;">
                            <div class="label">Document ID</div>
                            <div class="value mono">${reg.document_id}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Status</div>
                            <div class="value">
                                <span class="status-badge status-${reg.status.toLowerCase()}">${reg.status}</span>
                            </div>
                        </div>
                        <div class="result-item">
                            <div class="label">Duplicate?</div>
                            <div class="value">${reg.is_duplicate ? '‚ö†Ô∏è Yes' : '‚úì Original'}</div>
                        </div>
                        ${reg.original_document_id ? `
                        <div class="result-item" style="grid-column: span 2;">
                            <div class="label">Original Document ID</div>
                            <div class="value mono">${reg.original_document_id}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="result-card">
                    <h4>üîí Cryptographic Hashes</h4>
                    <div class="result-item" style="margin-bottom: 8px;">
                        <div class="label">Content Hash (SHA-256)</div>
                        <div class="hash-display">${reg.content_hash}</div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h4>üîç Forgery Detection</h4>
                    <div class="score-meter" style="margin-bottom: 16px;">
                        <span>Forgery Risk Score:</span>
                        <div class="score-bar">
                            <div class="score-fill ${reg.forgery_score < 0.3 ? 'low' : reg.forgery_score < 0.7 ? 'medium' : 'high'}" 
                                 style="width: ${reg.forgery_score * 100}%"></div>
                        </div>
                        <span class="score-value">${(reg.forgery_score * 100).toFixed(0)}%</span>
                    </div>
                    
                    ${reg.forgery_alerts?.length ? `
                        <div style="margin-top: 12px;">
                            <strong style="color: #991b1b;">‚ö†Ô∏è Alerts Detected:</strong>
                            ${reg.forgery_alerts.map(alert => `
                                <div class="forgery-alert">
                                    <div class="icon">üö®</div>
                                    <div class="content">
                                        <div class="indicator">${alert.indicator}</div>
                                        <div class="description">${alert.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <p style="color: var(--success);">‚úì No forgery indicators detected</p>
                    `}
                </div>
                
                ${reg.requires_review ? `
                <div class="forgery-alert" style="margin-top: 16px;">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div class="content">
                        <div class="indicator">Manual Review Required</div>
                        <div class="description">This document has been flagged for manual review due to detected anomalies.</div>
                    </div>
                </div>
                ` : ''}
                
                <div class="button-group">
                    <button class="btn btn-outline" onclick="verifyAndUpdate('${reg.document_id}')">
                        üîç Verify Integrity
                    </button>
                </div>
            `;
        }
        
        async function showCustody(doc) {
            const container = document.getElementById('custodyContent');
            
            if (!doc.registration?.document_id) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <p>Chain of custody will appear after registration</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `<p>Loading custody chain...</p>`;
            
            const custody = await fetchCustodyChain(doc.registration.document_id);
            
            if (!custody?.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <p>No custody events recorded yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="custody-timeline">
                    ${custody.map(event => `
                        <div class="custody-event">
                            <div class="time">${formatDateTime(event.timestamp)}</div>
                            <div class="action">${formatAction(event.action)}</div>
                            <div class="actor">By: ${event.actor}</div>
                            ${event.details ? `<div style="font-size: 13px; color: var(--gray-500); margin-top: 4px;">${event.details}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function verifyAndUpdate(documentId) {
            const result = await verifyIntegrity(documentId);
            if (result) {
                showToast(`Integrity: ${result.is_valid ? '‚úÖ Verified' : '‚ùå Tampered'}`, result.is_valid ? 'success' : 'error');

                // Refresh document data
                const doc = documents.find(d => d.registration?.document_id === documentId);
                if (doc) {
                    doc.registration.integrity_status = result.integrity_status;
                    showRegistry(doc);
                    showCustody(doc);
                }
            }
        }

        // =====================================================================
        // Recognition Engine Integration
        // =====================================================================
        async function showRecognition(doc) {
            const container = document.getElementById('recognitionContent');
            const btn = document.getElementById('runRecognitionBtn');

            if (btn) {
                btn.disabled = !doc.processed;
            }

            if (!doc.recognitionResult) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <p>Run advanced AI recognition analysis on this document</p>
                        <button class="btn btn-primary" onclick="runRecognitionAnalysis()" ${!doc.processed ? 'disabled' : ''}>
                            üß† Run Recognition Analysis
                        </button>
                        ${!doc.processed ? '<p style="color: var(--warning); font-size: 12px; margin-top: 8px;">‚ö†Ô∏è Process the document first</p>' : ''}
                    </div>
                `;
                return;
            }

            const result = doc.recognitionResult;
            container.innerHTML = `
                <div class="result-card">
                    <h4>üéØ Document Classification</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Type</div>
                            <div class="value">${result.document_type || 'Unknown'}</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Confidence</div>
                            <div class="value">${((result.confidence?.overall || 0) * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>

                ${result.entities?.length ? `
                <div class="result-card">
                    <h4>üìã Extracted Entities (${result.entities.length})</h4>
                    <div class="extracted-list">
                        ${result.entities.map(e => `
                            <div class="extracted-item">
                                <span class="type-badge">${e.type}</span>
                                <span>${e.value}</span>
                                ${e.confidence ? `<span class="confidence">${(e.confidence * 100).toFixed(0)}%</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${result.issues?.length ? `
                <div class="result-card">
                    <h4>‚ö†Ô∏è Issues Detected (${result.issues.length})</h4>
                    ${result.issues.map(issue => `
                        <div class="issue-item issue-${(issue.severity || 'info').toLowerCase()}">
                            <div class="issue-title">${getSeverityIcon(issue.severity || 'INFO')} ${issue.title || issue.type}</div>
                            <div class="issue-desc">${issue.description}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${result.reasoning_chain?.length ? `
                <div class="result-card">
                    <h4>üß† Reasoning Chain</h4>
                    <div class="reasoning-chain">
                        ${result.reasoning_chain.map((step, i) => `
                            <div class="reasoning-step">
                                <strong>Step ${i + 1}: ${step.step}</strong>
                                <p>${step.reasoning}</p>
                                <span class="confidence-badge">${(step.confidence * 100).toFixed(0)}% confident</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${result.handwriting ? `
                <div class="result-card">
                    <h4>‚úçÔ∏è Handwriting Analysis</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Detected</div>
                            <div class="value">${result.handwriting.detected ? 'Yes' : 'No'}</div>
                        </div>
                        ${result.handwriting.forgery_risk ? `
                        <div class="result-item">
                            <div class="label">Forgery Risk</div>
                            <div class="value" style="color: ${result.handwriting.forgery_risk === 'high' || result.handwriting.forgery_risk === 'critical' ? 'var(--danger)' : 'inherit'}">
                                ${result.handwriting.forgery_risk.toUpperCase()}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ${result.handwriting.indicators?.length ? `
                        <div class="forgery-indicators">
                            <strong>‚ö†Ô∏è Forgery Indicators:</strong>
                            <ul>
                                ${result.handwriting.indicators.map(ind => `<li>${ind.type}: ${ind.description}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                ` : ''}

                <div class="button-group">
                    <button class="btn btn-outline" onclick="runRecognitionAnalysis()">
                        üîÑ Re-analyze
                    </button>
                    <button class="btn btn-outline" onclick="openRecognitionPage()">
                        üîç Open Full Recognition
                    </button>
                </div>
            `;
        }

        async function runRecognitionAnalysis() {
            const doc = documents.find(d => d.id === selectedDocId);
            if (!doc) {
                showToast('Please select a document first', 'warning');
                return;
            }

            if (!doc.processed || !doc.extraction) {
                showToast('Please process the document first', 'warning');
                return;
            }

            const container = document.getElementById('recognitionContent');
            container.innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Running advanced AI recognition analysis...</p>
                    <p style="font-size: 12px; color: var(--gray-500);">Multi-pass reasoning ‚Ä¢ Legal domain expertise ‚Ä¢ Handwriting detection</p>
                </div>
            `;

            try {
                // Get document text from extraction
                const text = doc.extraction?.summary || doc.extraction?.raw_text || '';

                const response = await fetch(`${API_BASE}/api/recognition/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        text: text,
                        filename: doc.filename,
                        include_reasoning: true
                    })
                });

                if (!response.ok) {
                    throw new Error('Recognition analysis failed');
                }

                const result = await response.json();
                doc.recognitionResult = result;

                showRecognition(doc);
                showToast('Recognition analysis complete', 'success');

                // Emit brain event for cross-module awareness
                if (window.brainWs && window.brainWs.readyState === WebSocket.OPEN) {
                    window.brainWs.send(JSON.stringify({
                        type: 'recognition_complete',
                        document_id: doc.id,
                        document_type: result.document_type,
                        confidence: result.confidence?.overall,
                        issues_count: result.issues?.length || 0
                    }));
                }

            } catch (error) {
                container.innerHTML = `
                    <div class="error-state">
                        <div class="icon">‚ùå</div>
                        <p>Recognition analysis failed: ${error.message}</p>
                        <button class="btn btn-primary" onclick="runRecognitionAnalysis()">
                            üîÑ Retry
                        </button>
                    </div>
                `;
                showToast(`Recognition failed: ${error.message}`, 'error');
            }
        }

        function openRecognitionPage() {
            const doc = documents.find(d => d.id === selectedDocId);
            if (doc) {
                // Store doc info for recognition page
                sessionStorage.setItem('recognitionDoc', JSON.stringify({
                    id: doc.id,
                    filename: doc.filename,
                    text: doc.extraction?.summary || doc.extraction?.raw_text || '',
                    result: doc.recognitionResult
                }));
            }
            window.location.href = '/static/recognition.html';
        }

        // =====================================================================
        // Tab Handling
        // =====================================================================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
            });
        });
        
        // =====================================================================
        // Batch Operations
        // =====================================================================
        processAllBtn.addEventListener('click', async () => {
            for (const doc of documents.filter(d => !d.processed)) {
                await processDocument(doc);
            }
        });
        
        registerAllBtn.addEventListener('click', async () => {
            for (const doc of documents.filter(d => !d.registered)) {
                await registerDocument(doc);
            }
        });
        
        clearQueueBtn.addEventListener('click', () => {
            documents = [];
            selectedDocId = null;
            renderQueue();
            clearAllTabs();
        });
        
        // =====================================================================
        // Utility Functions
        // =====================================================================
        function showProgress(show) {
            progressContainer.classList.toggle('active', show);
        }
        
        function updateProgress(percent, status) {
            progressFill.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressStatus.textContent = status;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
        
        function formatDocType(type) {
            return type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
        
        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString();
        }
        
        function formatAction(action) {
            const actions = {
                'RECEIVED': 'üì• Received',
                'VERIFIED': '‚úÖ Verified',
                'PROCESSED': '‚öôÔ∏è Processed',
                'ACCESSED': 'üëÅÔ∏è Accessed',
                'MODIFIED': '‚úèÔ∏è Modified',
                'EXPORTED': 'üì§ Exported',
                'SHARED': 'üîó Shared',
                'FLAGGED': 'üö© Flagged',
                'ARCHIVED': 'üì¶ Archived',
                'INTEGRITY_CHECK': 'üîí Integrity Check'
            };
            return actions[action] || action;
        }
        
        function getSeverityIcon(severity) {
            const icons = {
                'HIGH': 'üî¥',
                'MEDIUM': 'üü°',
                'LOW': 'üîµ'
            };
            return icons[severity.toUpperCase()] || '‚ö™';
        }
        
        // =====================================================================
        // Initialization
        // =====================================================================
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            loadRegisteredDocuments();
            
            // Welcome message with adaptive toast
            if (typeof SemptifyToast !== 'undefined') {
                setTimeout(() => {
                    SemptifyToast.info('Ready to Upload', 'Drag documents here or click to browse. We\'ll help you organize everything! üìÅ', 5000);
                }, 1000);
            }
            
            // Initialize emotion engine
            if (typeof EmotionEngine !== 'undefined') {
                EmotionEngine.init();
            }
        });
    </script>
</body>
</html>
