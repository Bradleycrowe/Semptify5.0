<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <title>Complaint Builder - Semptify</title>
    <link rel="stylesheet" href="/static/css/shared-nav.css">
    <link rel="stylesheet" href="/static/css/help-system.css">
    <!-- Case Context Manager - Central case data service -->
    <script src="/static/js/case-context.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title span {
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-card);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab:hover {
            background: var(--bg-card-hover);
            color: var(--text);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Agency Grid */
        .agency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .agency-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .agency-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .agency-card.selected {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .agency-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .agency-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .agency-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            border-radius: 20px;
            white-space: nowrap;
        }

        .agency-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .agency-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .meta-tag {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background: var(--bg-card-hover);
            border-radius: 6px;
            color: var(--text-muted);
        }

        .agency-contact {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .agency-contact a {
            color: var(--primary);
            text-decoration: none;
        }

        .agency-contact a:hover {
            text-decoration: underline;
        }

        /* Keyword Search */
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 0.875rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* Voice Input */
        .voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .voice-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .voice-btn.listening {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* AI Assistance Panel */
        .ai-assist-panel {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .ai-assist-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .ai-assist-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .ai-suggestion-chip {
            display: inline-block;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border-radius: 1rem;
            font-size: 0.85rem;
            margin: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-suggestion-chip:hover {
            background: var(--primary);
            color: white;
        }

        .input-with-voice {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .input-with-voice .form-input,
        .input-with-voice .form-textarea {
            flex: 1;
        }

        /* Timeline Link Button */
        .timeline-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            color: var(--success);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .timeline-link-btn:hover {
            background: var(--success);
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 0.875rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Draft Wizard */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 24px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border);
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .wizard-step.active .step-number {
            background: var(--primary);
            border-color: var(--primary);
        }

        .wizard-step.completed .step-number {
            background: var(--success);
            border-color: var(--success);
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .wizard-step.active .step-label {
            color: var(--text);
            font-weight: 500;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-label span {
            color: var(--danger);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Two Column Layout */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Complaint Preview */
        .preview-box {
            background: #0f172a;
            border-radius: 10px;
            padding: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Document List */
        .document-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .document-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card-hover);
            border-radius: 10px;
        }

        .document-icon {
            font-size: 1.5rem;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
        }

        .document-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-draft {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }

        .status-ready {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-filed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        /* Draft List */
        .draft-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .draft-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .draft-item:hover {
            border-color: var(--primary);
        }

        .draft-icon {
            font-size: 2rem;
        }

        .draft-info {
            flex: 1;
        }

        .draft-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .draft-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .draft-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Quick Tips */
        .tips-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }

        .tip-icon {
            font-size: 1.25rem;
        }

        .tip-text {
            font-size: 0.95rem;
        }

        /* Checklist */
        .checklist {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card-hover);
            border-radius: 8px;
            cursor: pointer;
        }

        .checklist-item input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checklist-item.checked {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* Strategy Card */
        .strategy-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .strategy-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .strategy-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Success Message */
        .success-message {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .success-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .success-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .success-text {
            color: var(--text-muted);
        }

        /* Utility classes for inline style replacement */
        .text-muted { color: var(--text-muted); }
        .mb-1 { margin-bottom: 1rem; }
        .mt-1 { margin-top: 1rem; }
        .mt-1-5 { margin-top: 1.5rem; }
        .text-right { text-align: right; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .mr-half { margin-right: 0.5rem; }
        .grid-auto-fit { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .h4-warning { color: var(--warning); margin-bottom: 0.75rem; }
        .required-docs-list { color: var(--text-muted); padding-left: 1.5rem; }
        .checklist-header { margin-bottom: 1rem; }

        /* Evidence document list */
        .evidence-item {
            transition: all 0.2s ease;
        }
        .evidence-item:hover {
            background: var(--bg-elevated) !important;
            transform: translateX(4px);
        }
        .evidence-item input[type="checkbox"]:checked + div {
            color: var(--primary);
        }

        /* Print styles */
        @media print {
            .page-header, .tabs, .wizard-steps, .btn, .ai-assist-panel {
                display: none !important;
            }
            .card { box-shadow: none !important; border: 1px solid #ccc; }
            .preview-box { white-space: pre-wrap; }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Toast animation */
        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .required-docs-card { background: rgba(245, 158, 11, 0.1); border-color: var(--warning); }
    </style>
</head>
<body>
    <!-- Shared Navigation -->
    <div id="semptify-nav"></div>
    <script src="/static/js/shared-nav.js"></script>

    <div class="container">
        <!-- Header -->
        <header class="page-header">
            <h1 class="page-title">
                <span>‚öñÔ∏è</span>
                Complaint Builder
            </h1>
            <div class="header-actions">
                <button class="btn btn-sm" onclick="showKeyboardShortcuts()" title="Keyboard shortcuts">‚å®Ô∏è</button>
                <a href="/static/letter_builder.html" class="btn btn-sm" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none;" title="Generate formal letters">‚úâÔ∏è Letter Builder</a>
                <a href="/static/timeline-builder.html" class="timeline-link-btn">‚ö° Timeline Builder</a>
                <a href="/static/dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
            </div>
        </header>

        <!-- Keyboard Shortcuts Modal -->
        <div id="keyboard-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="flex-between mb-1">
                    <h3 style="margin: 0;">‚å®Ô∏è Keyboard Shortcuts</h3>
                    <button class="btn btn-sm" onclick="closeKeyboardModal()">√ó</button>
                </div>
                <div class="shortcuts-list" style="display: grid; gap: 0.5rem;">
                    <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                        <span>Save Draft</span>
                        <kbd style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Ctrl + S</kbd>
                    </div>
                    <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                        <span>Voice Input</span>
                        <kbd style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Ctrl + M</kbd>
                    </div>
                    <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                        <span>Next Step</span>
                        <kbd style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + ‚Üí</kbd>
                    </div>
                    <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                        <span>Previous Step</span>
                        <kbd style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Alt + ‚Üê</kbd>
                    </div>
                    <div class="shortcut-item" style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                        <span>Close Modal</span>
                        <kbd style="background: var(--bg-elevated); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Esc</kbd>
                    </div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem;">
                    üí° Use üé§ buttons for voice input if typing is difficult
                </p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="agencies">üèõÔ∏è Agencies</button>
            <button class="tab" data-tab="new-complaint">‚úèÔ∏è New Complaint</button>
            <button class="tab" data-tab="my-complaints">üìÅ My Complaints</button>
            <button class="tab" data-tab="guide">üìö Guide</button>
        </div>

        <!-- Panel: Agencies -->
        <div id="panel-agencies" class="panel active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîç Find the Right Agency</h2>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" id="keyword-search" 
                           placeholder="Describe your issue (e.g., discrimination, security deposit, harassment)">
                    <button class="voice-btn" onclick="startVoiceInput('keyword-search')" title="Voice search" aria-label="Voice search">üé§</button>
                    <button class="btn btn-primary" id="search-agencies-btn">
                        üîç Get Recommendations
                    </button>
                </div>
            </div>

            <!-- Strategy Card (shown after search) -->
            <div id="strategy-section" class="hidden">
                <div class="strategy-card">
                    <h3 class="strategy-title">üìã Recommended Strategy</h3>
                    <div id="strategy-content" class="strategy-content"></div>
                </div>
            </div>

            <!-- Agency Grid -->
            <div class="agency-grid" id="agency-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading agencies...
                </div>
            </div>
        </div>

        <!-- Panel: New Complaint -->
        <div id="panel-new-complaint" class="panel">
            <!-- Wizard Steps -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-number">1</div>
                    <span class="step-label">Select Agency</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-number">2</div>
                    <span class="step-label">Complaint Details</span>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-number">3</div>
                    <span class="step-label">Attach Evidence</span>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="step-number">4</div>
                    <span class="step-label">Review & File</span>
                </div>
            </div>

            <!-- Step 1: Select Agency -->
            <div id="wizard-step-1" class="wizard-content">
                <div class="card">
                    <h3 class="card-title">Select an Agency</h3>
                    <p class="text-muted mb-1">
                        Choose the agency you want to file a complaint with.
                    </p>
                    <div class="agency-grid" id="wizard-agency-grid"></div>
                    <div class="mt-1-5 text-right">
                        <button class="btn btn-primary" id="step1-next" disabled>
                            Continue ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Complaint Details -->
            <div id="wizard-step-2" class="wizard-content hidden">
                <div class="card">
                    <h3 class="card-title">üìù Complaint Details</h3>
                    
                    <!-- AI Assistance Panel -->
                    <div class="ai-assist-panel">
                        <div class="ai-assist-header">
                            <span>ü§ñ</span>
                            <span class="ai-assist-title">AI Writing Assistant</span>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Click a suggestion to add to your description:</p>
                        <div id="ai-suggestions">
                            <span class="ai-suggestion-chip" onclick="addSuggestion('My landlord failed to return my security deposit within 21 days as required by MN law.')">Security deposit not returned</span>
                            <span class="ai-suggestion-chip" onclick="addSuggestion('I reported maintenance issues on [DATE] but my landlord has failed to make repairs, violating the warranty of habitability.')">Repair issues ignored</span>
                            <span class="ai-suggestion-chip" onclick="addSuggestion('I believe I am being discriminated against based on [PROTECTED CLASS].')">Discrimination</span>
                            <span class="ai-suggestion-chip" onclick="addSuggestion('My landlord entered my unit without proper notice or consent.')">Illegal entry</span>
                            <span class="ai-suggestion-chip" onclick="addSuggestion('I am being retaliated against for exercising my tenant rights.')">Retaliation</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject <span>*</span></label>
                        <div class="input-with-voice">
                            <input type="text" class="form-input" id="complaint-subject"
                                   placeholder="Brief summary of your complaint">
                            <button class="voice-btn" onclick="startVoiceInput('complaint-subject')" title="Voice input">üé§</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description <span>*</span></label>
                        <div class="input-with-voice">
                            <textarea class="form-textarea" id="complaint-description"
                                      placeholder="Describe what happened in detail..."></textarea>
                            <button class="voice-btn" onclick="startVoiceInput('complaint-description')" title="Voice input">üé§</button>
                        </div>
                        <p class="form-help">Include dates, names, and specific incidents. Use voice input üé§ if typing is difficult.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Incident Dates</label>
                        <input type="text" class="form-input" id="complaint-dates"
                               placeholder="e.g., January 15, 2025 - February 1, 2025">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Damages Claimed ($)</label>
                            <input type="number" class="form-input" id="complaint-damages"
                                   placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Relief Sought</label>
                            <div class="input-with-voice">
                                <input type="text" class="form-input" id="complaint-relief"
                                       placeholder="What outcome do you want?">
                                <button class="voice-btn" onclick="startVoiceInput('complaint-relief')" title="Voice input">üé§</button>
                            </div>
                        </div>
                    </div>
                    <h4 class="mt-1-5">üë§ Respondent Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Respondent Name <span>*</span></label>
                            <input type="text" class="form-input" id="respondent-name"
                                   placeholder="Landlord or company name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company (if applicable)</label>
                            <input type="text" class="form-input" id="respondent-company"
                                   placeholder="Property management company">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-input" id="respondent-address"
                                   placeholder="Property address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-input" id="respondent-phone"
                                   placeholder="(xxx) xxx-xxxx">
                        </div>
                    </div>
                    <div class="mt-1-5 flex-between">
                        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="goToStep(3)">Continue ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Attach Evidence -->
            <div id="wizard-step-3" class="wizard-content hidden">
                <div class="card">
                    <div class="flex-between mb-1">
                        <h3 class="card-title">üìé Attach Evidence</h3>
                        <div>
                            <button class="btn btn-sm" onclick="loadDocumentsForEvidence()" title="Refresh documents">üîÑ Refresh</button>
                            <button class="btn btn-sm" onclick="importTimelineEvents()" title="Import from timeline">üìÖ Import Timeline</button>
                        </div>
                    </div>
                    <p class="text-muted mb-1">
                        Select documents from your uploaded files to attach as evidence. Click checkboxes to attach.
                    </p>
                    <div class="document-list" id="evidence-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading your documents...
                        </div>
                    </div>
                    <div id="selected-evidence-count" class="text-muted mt-1" style="font-size: 0.85rem;"></div>
                    <div id="required-docs" class="card mt-1-5 required-docs-card">
                        <h4 class="h4-warning">üìã Required Documents</h4>
                        <ul id="required-docs-list" class="required-docs-list"></ul>
                    </div>
                    <div class="mt-1-5 flex-between">
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="goToStep(4)">Continue ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review & File -->
            <div id="wizard-step-4" class="wizard-content hidden">
                <div class="card">
                    <div class="flex-between mb-1">
                        <h3 class="card-title">üìù Review Your Complaint</h3>
                        <button class="btn btn-sm" onclick="copyComplaintText()" title="Copy complaint text">
                            üìã Copy Text
                        </button>
                    </div>
                    <div class="preview-box" id="complaint-preview"></div>
                    
                    <div class="checklist mt-1-5">
                        <h4 class="checklist-header">‚úÖ Pre-Filing Checklist</h4>
                        <label class="checklist-item">
                            <input type="checkbox" id="check-1">
                            <span>All information is accurate and complete</span>
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" id="check-2">
                            <span>Evidence documents are attached</span>
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" id="check-3">
                            <span>Made copies for my records</span>
                        </label>
                        <label class="checklist-item">
                            <input type="checkbox" id="check-4">
                            <span>Respondent information is correct</span>
                        </label>
                    </div>

                    <div class="mt-1-5 flex-between">
                        <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="printComplaint()" title="Print preview">
                                üñ®Ô∏è Print
                            </button>
                            <button class="btn btn-secondary" onclick="exportComplaintPDF()" title="Export as PDF">
                                üìÑ Export PDF
                            </button>
                            <button class="btn btn-secondary" id="save-draft-btn">
                                üíæ Save
                            </button>
                            <button class="btn btn-success" id="file-complaint-btn">
                                üì§ File
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filed Success -->
            <div id="wizard-success" class="wizard-content hidden">
                <div class="success-message">
                    <div class="success-icon">‚úÖ</div>
                    <h3 class="success-title">Complaint Filed!</h3>
                    <p class="success-text">Your complaint has been recorded. Follow the link below to complete filing.</p>
                    <a id="filing-link" href="#" target="_blank" rel="noopener" class="btn btn-primary mt-1">
                        üì§ Go to Agency Filing Portal
                    </a>
                    <p class="mt-1 text-muted form-help">
                        Confirmation Number: <strong id="confirmation-number">-</strong>
                    </p>
                    <p class="text-muted form-help">
                        Follow-up Date: <strong id="followup-date">-</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- Panel: My Complaints -->
        <div id="panel-my-complaints" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÅ My Complaint Drafts</h2>
                    <button class="btn btn-primary btn-sm" onclick="switchTab('new-complaint')">
                        + New Complaint
                    </button>
                </div>
                <div class="draft-list" id="draft-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading your complaints...
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel: Guide -->
        <div id="panel-guide" class="panel">
            <div class="card">
                <h2 class="card-title">üìö Complaint Filing Guide</h2>
                <div class="tips-list mt-1">
                    <div class="tip-item">
                        <span class="tip-icon">1Ô∏è‚É£</span>
                        <span class="tip-text"><strong>Call HOME Line First:</strong> (612) 728-5767 - Get free tenant advice before filing formal complaints.</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">2Ô∏è‚É£</span>
                        <span class="tip-text"><strong>Contact Legal Aid:</strong> If you qualify, they can represent you for free and help with complaint strategy.</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">3Ô∏è‚É£</span>
                        <span class="tip-text"><strong>File with MN Attorney General:</strong> Strong enforcement powers for fraud and deceptive practices.</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">4Ô∏è‚É£</span>
                        <span class="tip-text"><strong>HUD for Discrimination:</strong> If you faced any discrimination based on protected class, file with HUD.</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">5Ô∏è‚É£</span>
                        <span class="tip-text"><strong>Multi-Agency Strategy:</strong> Filing with multiple agencies creates pressure from multiple directions.</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">6Ô∏è‚É£</span>
                        <span class="tip-text"><strong>BBB for Public Pressure:</strong> BBB complaints become public record and can damage business reputation.</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üîó Quick Links</h3>
                <div class="grid-auto-fit mt-1">
                    <a href="https://homelinemn.org/" target="_blank" rel="noopener" class="btn btn-secondary">HOME Line MN</a>
                    <a href="https://www.lawhelpmn.org/" target="_blank" rel="noopener" class="btn btn-secondary">Legal Aid MN</a>
                    <a href="https://www.ag.state.mn.us/Office/Complaint.asp" target="_blank" rel="noopener" class="btn btn-secondary">MN Attorney General</a>
                    <a href="https://portalapps.hud.gov/FHEO903/Form903/Form903Start.action" target="_blank" rel="noopener" class="btn btn-secondary">HUD Fair Housing</a>
                    <a href="https://mn.gov/commerce/consumers/file-a-complaint/" target="_blank" rel="noopener" class="btn btn-secondary">MN Commerce</a>
                    <a href="https://www.bbb.org/file-a-complaint" target="_blank" rel="noopener" class="btn btn-secondary">BBB Complaint</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="file-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üì§ Confirm Filing</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>You're about to file your complaint with <strong id="modal-agency-name"></strong>.</p>
                <div class="form-group mt-1">
                    <label class="form-label">Confirmation Number (optional)</label>
                    <input type="text" class="form-input" id="modal-confirmation"
                           placeholder="Enter after filing with agency">
                    <p class="form-help">You can add this after you receive it from the agency.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-success" id="confirm-file-btn">
                    ‚úÖ Mark as Filed
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let agencies = [];
        let selectedAgencyId = null;
        let currentDraftId = null;
        let currentStep = 1;
        let userDocuments = [];

        // Get user ID
        function getUserId() {
            let userId = localStorage.getItem('semptify_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('semptify_user_id', userId);
            }
            return userId;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`panel-${tabName}`).classList.add('active');

            if (tabName === 'my-complaints') loadDrafts();
            if (tabName === 'new-complaint') loadWizardAgencies();
        }

        // Load agencies
        async function loadAgencies() {
            try {
                const response = await fetch('/api/complaints/agencies');
                agencies = await response.json();
                renderAgencies(agencies);
            } catch (err) {
                console.error('Failed to load agencies:', err);
            }
        }

        function renderAgencies(agencyList) {
            const grid = document.getElementById('agency-grid');
            if (agencyList.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üèõÔ∏è</div><p>No agencies found</p></div>';
                return;
            }

            grid.innerHTML = agencyList.map(agency => `
                <div class="agency-card" data-id="${agency.id}" onclick="selectAgencyAndStart('${agency.id}')">
                    <div class="agency-header">
                        <h3 class="agency-name">${agency.name}</h3>
                        <span class="agency-badge">${agency.jurisdiction}</span>
                    </div>
                    <p class="agency-description">${agency.description}</p>
                    <div class="agency-meta">
                        ${agency.complaint_types.slice(0, 3).map(t => `<span class="meta-tag">${t}</span>`).join('')}
                    </div>
                    <div class="agency-contact">
                        ${agency.phone ? `<span>üìû ${agency.phone}</span>` : ''}
                        ${agency.filing_url ? `<a href="${agency.filing_url}" target="_blank" onclick="event.stopPropagation()">üîó File Online</a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Search agencies
        document.getElementById('search-agencies-btn').addEventListener('click', searchAgencies);
        document.getElementById('keyword-search').addEventListener('keypress', e => {
            if (e.key === 'Enter') searchAgencies();
        });

        async function searchAgencies() {
            const keywords = document.getElementById('keyword-search').value;
            if (!keywords.trim()) {
                loadAgencies();
                document.getElementById('strategy-section').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch('/api/complaints/agencies/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords: keywords.split(',').map(k => k.trim()) })
                });
                const recommended = await response.json();
                renderAgencies(recommended);

                // Show strategy
                document.getElementById('strategy-section').classList.remove('hidden');
                document.getElementById('strategy-content').textContent = 
                    `Based on your keywords "${keywords}", we recommend starting with ${recommended[0]?.name || 'Legal Aid'}.\n\n` +
                    `Filing with multiple agencies (${recommended.length} recommended) creates pressure from multiple directions.`;
            } catch (err) {
                console.error('Search failed:', err);
            }
        }

        // Wizard functions
        function loadWizardAgencies() {
            const grid = document.getElementById('wizard-agency-grid');
            grid.innerHTML = agencies.map(agency => `
                <div class="agency-card ${selectedAgencyId === agency.id ? 'selected' : ''}" 
                     data-id="${agency.id}" onclick="selectWizardAgency('${agency.id}')">
                    <div class="agency-header">
                        <h3 class="agency-name">${agency.name}</h3>
                        <span class="agency-badge">${agency.jurisdiction}</span>
                    </div>
                    <p class="agency-description">${agency.description}</p>
                </div>
            `).join('');
        }

        function selectWizardAgency(agencyId) {
            selectedAgencyId = agencyId;
            document.querySelectorAll('#wizard-agency-grid .agency-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === agencyId);
            });
            document.getElementById('step1-next').disabled = false;
            updateAISuggestions(); // Update AI suggestions based on agency
        }

        function selectAgencyAndStart(agencyId) {
            selectedAgencyId = agencyId;
            switchTab('new-complaint');
            loadWizardAgencies();
            document.getElementById('step1-next').disabled = false;
            updateAISuggestions(); // Update AI suggestions based on agency
        }

        document.getElementById('step1-next').addEventListener('click', async () => {
            if (!selectedAgencyId) return;
            
            // Create draft
            try {
                const response = await fetch(`/api/complaints/drafts?user_id=${getUserId()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agency_id: selectedAgencyId, subject: '' })
                });
                const draft = await response.json();
                currentDraftId = draft.id;

                // Load required docs for this agency
                const agency = agencies.find(a => a.id === selectedAgencyId);
                if (agency) {
                    document.getElementById('required-docs-list').innerHTML = 
                        agency.required_documents.map(d => `<li>${d}</li>`).join('');
                }

                goToStep(2);
            } catch (err) {
                console.error('Failed to create draft:', err);
            }
        });

        function goToStep(step) {
            currentStep = step;
            
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach(s => {
                const stepNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'completed');
                if (stepNum < step) s.classList.add('completed');
                if (stepNum === step) s.classList.add('active');
            });

            // Show/hide content
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`wizard-step-${i}`).classList.toggle('hidden', i !== step);
            }
            document.getElementById('wizard-success').classList.add('hidden');

            // Load preview on step 4
            if (step === 4) loadPreview();
        }

        async function loadPreview() {
            if (!currentDraftId) return;

            // First update the draft with form data
            await saveDraft();

            try {
                const response = await fetch(`/api/complaints/drafts/${currentDraftId}/preview`);
                const preview = await response.json();
                document.getElementById('complaint-preview').textContent = preview.complaint_text;
            } catch (err) {
                console.error('Failed to load preview:', err);
            }
        }

        async function saveDraft() {
            if (!currentDraftId) return;

            const dates = document.getElementById('complaint-dates').value;
            const data = {
                subject: document.getElementById('complaint-subject').value,
                description: document.getElementById('complaint-description').value,
                incident_dates: dates ? dates.split(',').map(d => d.trim()) : [],
                damages_claimed: parseFloat(document.getElementById('complaint-damages').value) || null,
                relief_sought: document.getElementById('complaint-relief').value,
                respondent_name: document.getElementById('respondent-name').value,
                respondent_company: document.getElementById('respondent-company').value,
                respondent_address: document.getElementById('respondent-address').value,
                respondent_phone: document.getElementById('respondent-phone').value,
            };

            try {
                await fetch(`/api/complaints/drafts/${currentDraftId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (err) {
                console.error('Failed to save draft:', err);
            }
        }

        document.getElementById('save-draft-btn').addEventListener('click', async () => {
            await saveDraft();
            alert('Draft saved!');
        });

        // File complaint
        document.getElementById('file-complaint-btn').addEventListener('click', () => {
            const agency = agencies.find(a => a.id === selectedAgencyId);
            document.getElementById('modal-agency-name').textContent = agency?.name || 'the agency';
            document.getElementById('file-modal').classList.remove('hidden');
        });

        document.getElementById('confirm-file-btn').addEventListener('click', async () => {
            const confirmation = document.getElementById('modal-confirmation').value;
            
            try {
                const response = await fetch(`/api/complaints/drafts/${currentDraftId}/file`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirmation_number: confirmation || null })
                });
                const result = await response.json();

                // Show success
                closeModal();
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`wizard-step-${i}`).classList.add('hidden');
                }
                document.getElementById('wizard-success').classList.remove('hidden');

                const agency = agencies.find(a => a.id === selectedAgencyId);
                document.getElementById('filing-link').href = agency?.filing_url || '#';
                document.getElementById('confirmation-number').textContent = confirmation || 'Pending';
                document.getElementById('followup-date').textContent = 
                    new Date(Date.now() + (agency?.typical_response_days || 30) * 86400000).toLocaleDateString();

            } catch (err) {
                console.error('Failed to file:', err);
            }
        });

        function closeModal() {
            document.getElementById('file-modal').classList.add('hidden');
        }

        // Load drafts
        async function loadDrafts() {
            try {
                const response = await fetch(`/api/complaints/drafts?user_id=${getUserId()}`);
                const drafts = await response.json();
                renderDrafts(drafts);
            } catch (err) {
                console.error('Failed to load drafts:', err);
            }
        }

        function renderDrafts(drafts) {
            const list = document.getElementById('draft-list');
            if (drafts.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>No complaints yet</p>
                        <button class="btn btn-primary btn-sm mt-1" onclick="switchTab('new-complaint')">
                            Start Your First Complaint
                        </button>
                    </div>
                `;
                return;
            }

            list.innerHTML = drafts.map(draft => {
                const agency = agencies.find(a => a.id === draft.agency_id);
                const statusClass = draft.status === 'filed' ? 'status-filed' : 
                                   draft.status === 'ready' ? 'status-ready' : 'status-draft';
                return `
                    <div class="draft-item">
                        <div style="display: flex; align-items: center; flex: 1; cursor: pointer;" onclick="loadDraft('${draft.id}')">
                            <span class="draft-icon">üìã</span>
                            <div class="draft-info">
                                <div class="draft-title">${draft.subject || 'Untitled Complaint'}</div>
                                <div class="draft-meta">
                                    ${agency?.name || 'Unknown Agency'} ‚Ä¢ 
                                    Updated ${new Date(draft.updated_at).toLocaleDateString()}
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${draft.status}</span>
                        </div>
                        <button class="btn btn-sm" style="margin-left: 0.5rem; color: var(--danger-color);" 
                                onclick="event.stopPropagation(); deleteDraft('${draft.id}')" title="Delete draft">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        async function loadDraft(draftId) {
            try {
                const response = await fetch(`/api/complaints/drafts/${draftId}`);
                const draft = await response.json();

                currentDraftId = draftId;
                selectedAgencyId = draft.agency_id;

                // Populate form
                document.getElementById('complaint-subject').value = draft.subject || '';
                document.getElementById('complaint-description').value = draft.description || '';
                document.getElementById('complaint-dates').value = (draft.incident_dates || []).join(', ');
                document.getElementById('complaint-damages').value = draft.damages_claimed || '';
                document.getElementById('complaint-relief').value = draft.relief_sought || '';
                document.getElementById('respondent-name').value = draft.respondent_name || '';
                document.getElementById('respondent-company').value = draft.respondent_company || '';
                document.getElementById('respondent-address').value = draft.respondent_address || '';
                document.getElementById('respondent-phone').value = draft.respondent_phone || '';

                // Switch to new complaint tab and step 2
                switchTab('new-complaint');
                goToStep(2);
            } catch (err) {
                console.error('Failed to load draft:', err);
            }
        }

        // =============================================
        // Voice Input Support (Accessibility)
        // =============================================
        let voiceRecognition = null;

        function startVoiceInput(inputId) {
            const input = document.getElementById(inputId);
            const btn = input.closest('.input-with-voice, .search-box')?.querySelector('.voice-btn');
            
            // Check if already listening
            if (voiceRecognition && btn?.classList.contains('listening')) {
                voiceRecognition.stop();
                btn.classList.remove('listening');
                return;
            }

            // Check browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Voice input is not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }

            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = true;
            voiceRecognition.lang = 'en-US';

            if (btn) btn.classList.add('listening');
            input.placeholder = 'üé§ Listening... speak now';

            voiceRecognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                
                // For textarea, append. For input, replace
                if (input.tagName === 'TEXTAREA') {
                    input.value = input.value ? input.value + ' ' + transcript : transcript;
                } else {
                    input.value = transcript;
                }
            };

            voiceRecognition.onend = () => {
                if (btn) btn.classList.remove('listening');
                input.placeholder = input.dataset.placeholder || '';
            };

            voiceRecognition.onerror = (event) => {
                if (btn) btn.classList.remove('listening');
                if (event.error === 'no-speech') {
                    alert('No speech detected. Please try again.');
                } else if (event.error !== 'aborted') {
                    alert('Voice recognition error: ' + event.error);
                }
            };

            // Store original placeholder
            input.dataset.placeholder = input.placeholder;
            voiceRecognition.start();
        }

        // =============================================
        // AI Suggestion Helper
        // =============================================
        function addSuggestion(text) {
            const description = document.getElementById('complaint-description');
            description.value = description.value ? description.value + '\n\n' + text : text;
            description.focus();
            description.scrollTop = description.scrollHeight;
        }

        // Update AI suggestions based on selected agency
        function updateAISuggestions() {
            const agency = agencies.find(a => a.id === selectedAgencyId);
            if (!agency) return;
            
            const suggestionsDiv = document.getElementById('ai-suggestions');
            const suggestions = [];
            
            // Add relevant suggestions based on complaint types
            if (agency.complaint_types.some(t => t.toLowerCase().includes('deposit'))) {
                suggestions.push({text: 'My landlord failed to return my security deposit within 21 days as required by MN law.', label: 'Security deposit'});
            }
            if (agency.complaint_types.some(t => t.toLowerCase().includes('discrimination') || t.toLowerCase().includes('fair housing'))) {
                suggestions.push({text: 'I believe I am being discriminated against based on [PROTECTED CLASS: race, color, religion, sex, familial status, national origin, or disability].', label: 'Discrimination'});
            }
            if (agency.complaint_types.some(t => t.toLowerCase().includes('repair') || t.toLowerCase().includes('habitability'))) {
                suggestions.push({text: 'I reported maintenance issues on [DATE] but my landlord has failed to make repairs, violating the warranty of habitability under MN Stat. ¬ß 504B.161.', label: 'Repair issues'});
            }
            if (agency.complaint_types.some(t => t.toLowerCase().includes('retaliation'))) {
                suggestions.push({text: 'I am being retaliated against for exercising my tenant rights (reporting code violations, requesting repairs, etc.).', label: 'Retaliation'});
            }
            
            // Always include generic suggestions
            suggestions.push({text: 'My landlord entered my unit without proper 24-hour notice or consent.', label: 'Illegal entry'});
            suggestions.push({text: 'I have documentation and evidence to support my complaint including [photos, emails, receipts, witnesses].', label: 'Evidence statement'});
            
            suggestionsDiv.innerHTML = suggestions.slice(0, 6).map(s => 
                `<span class="ai-suggestion-chip" onclick="addSuggestion('${s.text.replace(/'/g, "\\'")}')">${s.label}</span>`
            ).join('');
        }

        // =============================================
        // Auto-Save Feature
        // =============================================
        let autoSaveTimer = null;
        let lastSavedData = '';

        function startAutoSave() {
            // Debounce auto-save on input changes
            const inputs = document.querySelectorAll('#wizard-step-2 input, #wizard-step-2 textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(autoSaveIfNeeded, 3000); // Save 3 seconds after typing stops
                });
            });
        }

        async function autoSaveIfNeeded() {
            if (!currentDraftId) return;
            
            const currentData = JSON.stringify({
                subject: document.getElementById('complaint-subject').value,
                description: document.getElementById('complaint-description').value
            });
            
            if (currentData === lastSavedData) return; // No changes
            
            try {
                await saveDraft(true); // silent save
                lastSavedData = currentData;
                showAutoSaveIndicator();
            } catch (err) {
                console.error('Auto-save failed:', err);
            }
        }

        function showAutoSaveIndicator() {
            // Create indicator if not exists
            let indicator = document.querySelector('.autosave-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'autosave-indicator';
                indicator.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px;
                    background: var(--success-color); color: white;
                    padding: 8px 16px; border-radius: 8px;
                    font-size: 0.85rem; z-index: 1000;
                    opacity: 0; transition: opacity 0.3s;
                `;
                document.body.appendChild(indicator);
            }
            
            indicator.textContent = '‚úì Auto-saved';
            indicator.style.opacity = '1';
            setTimeout(() => indicator.style.opacity = '0', 2000);
        }

        // =============================================
        // Keyboard Shortcuts
        // =============================================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S = Save draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (currentDraftId) {
                    saveDraft();
                }
            }
            
            // Ctrl/Cmd + V when focused on voice field = Start voice input
            if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                e.preventDefault();
                const activeInput = document.activeElement;
                if (activeInput && (activeInput.tagName === 'INPUT' || activeInput.tagName === 'TEXTAREA')) {
                    startVoiceInput(activeInput.id);
                }
            }
            
            // Alt + Arrow Right/Left = Navigate steps
            if (e.altKey && e.key === 'ArrowRight') {
                e.preventDefault();
                if (currentStep < 4) goToStep(currentStep + 1);
            }
            if (e.altKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                if (currentStep > 1) goToStep(currentStep - 1);
            }
            
            // Escape = Close modal if open
            if (e.key === 'Escape') {
                const modal = document.querySelector('.modal.active');
                if (modal) modal.classList.remove('active');
            }
        });

        // =============================================
        // Copy Complaint Text
        // =============================================
        async function copyComplaintText() {
            const previewEl = document.getElementById('complaint-preview');
            if (!previewEl) return;
            
            try {
                await navigator.clipboard.writeText(previewEl.innerText);
                showToast('Copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy:', err);
                showToast('Failed to copy', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--primary-color)'};
                color: white; padding: 12px 24px; border-radius: 8px;
                font-size: 0.9rem; z-index: 1000; animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================
        // Keyboard Shortcuts Modal
        // =============================================
        function showKeyboardShortcuts() {
            document.getElementById('keyboard-modal').classList.add('active');
        }

        function closeKeyboardModal() {
            document.getElementById('keyboard-modal').classList.remove('active');
        }

        // =============================================
        // Evidence Document Loading
        // =============================================
        let selectedDocumentIds = [];

        async function loadDocumentsForEvidence() {
            const list = document.getElementById('evidence-list');
            list.innerHTML = '<div class="loading"><div class="spinner"></div>Loading documents...</div>';
            
            try {
                const response = await fetch(`/api/documents?user_id=${getUserId()}`);
                if (!response.ok) throw new Error('Failed to load documents');
                
                const docs = await response.json();
                renderEvidenceDocuments(docs);
            } catch (err) {
                console.error('Failed to load documents:', err);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÑ</div>
                        <p>Unable to load documents</p>
                        <a href="/static/documents.html" class="btn btn-primary btn-sm mt-1">
                            Upload Documents
                        </a>
                    </div>
                `;
            }
        }

        function renderEvidenceDocuments(docs) {
            const list = document.getElementById('evidence-list');
            
            if (!docs || docs.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÑ</div>
                        <p>No documents uploaded yet</p>
                        <a href="/static/documents.html" class="btn btn-primary btn-sm mt-1">
                            Upload Documents
                        </a>
                    </div>
                `;
                return;
            }

            list.innerHTML = docs.map(doc => `
                <label class="evidence-item" style="display: flex; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;">
                    <input type="checkbox" 
                           id="doc-${doc.id}" 
                           value="${doc.id}"
                           ${selectedDocumentIds.includes(doc.id) ? 'checked' : ''}
                           onchange="toggleDocumentSelection('${doc.id}')"
                           style="margin-right: 0.75rem; width: 18px; height: 18px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${doc.filename || doc.name || 'Document'}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            ${doc.category || doc.type || 'General'} ‚Ä¢ ${formatFileSize(doc.file_size || 0)}
                        </div>
                    </div>
                    <span style="font-size: 1.2rem;">${getDocIcon(doc.category || doc.type)}</span>
                </label>
            `).join('');
            
            updateSelectedCount();
        }

        function toggleDocumentSelection(docId) {
            const idx = selectedDocumentIds.indexOf(docId);
            if (idx > -1) {
                selectedDocumentIds.splice(idx, 1);
            } else {
                selectedDocumentIds.push(docId);
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('selected-evidence-count');
            countEl.textContent = selectedDocumentIds.length > 0 
                ? `üìé ${selectedDocumentIds.length} document(s) selected` 
                : '';
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function getDocIcon(category) {
            const icons = {
                'lease': 'üìÑ', 'agreement': 'üìÑ', 'contract': 'üìÑ',
                'notice': 'üì¨', 'letter': '‚úâÔ∏è',
                'photo': 'üì∑', 'image': 'üì∑',
                'receipt': 'üßæ', 'payment': 'üí∞',
                'court': '‚öñÔ∏è', 'legal': '‚öñÔ∏è',
                'email': 'üìß', 'communication': 'üí¨',
                'evidence': 'üìã'
            };
            const lc = (category || '').toLowerCase();
            for (const [key, icon] of Object.entries(icons)) {
                if (lc.includes(key)) return icon;
            }
            return 'üìÑ';
        }

        // =============================================
        // Timeline Import
        // =============================================
        async function importTimelineEvents() {
            try {
                const response = await fetch(`/api/timeline/events?user_id=${getUserId()}`);
                if (!response.ok) throw new Error('Failed to load timeline');
                
                const events = await response.json();
                if (!events || events.length === 0) {
                    showToast('No timeline events found', 'info');
                    return;
                }

                // Format timeline events for complaint description
                const timelineText = events.slice(0, 20).map(e => 
                    `‚Ä¢ ${e.date || 'Unknown date'}: ${e.title || e.description || 'Event'}`
                ).join('\n');

                const desc = document.getElementById('complaint-description');
                const prefix = desc.value ? desc.value + '\n\n--- TIMELINE EVENTS ---\n' : '--- TIMELINE EVENTS ---\n';
                desc.value = prefix + timelineText;
                
                // Mark timeline as included
                document.getElementById('complaint-dates').value = events
                    .filter(e => e.date)
                    .map(e => e.date)
                    .slice(0, 10)
                    .join(', ');

                showToast(`Imported ${events.length} timeline events`, 'success');
            } catch (err) {
                console.error('Failed to import timeline:', err);
                showToast('Failed to import timeline', 'error');
            }
        }

        // =============================================
        // Delete Draft
        // =============================================
        async function deleteDraft(draftId) {
            if (!confirm('Are you sure you want to delete this draft? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/complaints/drafts/${draftId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast('Draft deleted', 'success');
                    loadDrafts(); // Refresh list
                } else {
                    showToast('Failed to delete draft', 'error');
                }
            } catch (err) {
                console.error('Failed to delete:', err);
                showToast('Failed to delete draft', 'error');
            }
        }

        // =============================================
        // Print & Export
        // =============================================
        function printComplaint() {
            const preview = document.getElementById('complaint-preview');
            if (!preview) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Complaint - Print Preview</title>
                    <style>
                        body { font-family: 'Courier New', monospace; padding: 40px; line-height: 1.6; }
                        h1 { font-size: 14pt; margin-bottom: 20px; }
                        pre { white-space: pre-wrap; font-size: 11pt; }
                    </style>
                </head>
                <body>
                    <pre>${preview.innerText}</pre>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function exportComplaintPDF() {
            showToast('Generating PDF...', 'info');
            
            // Use browser print to PDF as fallback
            const preview = document.getElementById('complaint-preview');
            if (!preview) return;

            // Try server-side PDF generation first
            try {
                const response = await fetch(`/api/complaints/drafts/${currentDraftId}/export?format=pdf`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `complaint_${currentDraftId.substring(0, 8)}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('PDF downloaded!', 'success');
                    return;
                }
            } catch (err) {
                console.log('Server PDF not available, using print');
            }

            // Fallback: Open print dialog (user can save as PDF)
            printComplaint();
            showToast('Use "Save as PDF" in the print dialog', 'info');
        }

        // Load documents when entering Step 3
        const originalGoToStep = goToStep;
        goToStep = function(step) {
            originalGoToStep(step);
            if (step === 3) {
                loadDocumentsForEvidence();
            }
        };

        // Initialize auto-save
        startAutoSave();

        // Initialize
        loadAgencies();
        
        // Auto-fill from CaseContext if active case exists
        setTimeout(() => {
            const activeCase = CaseContext.getActiveCase();
            if (activeCase) {
                console.log('üìã Auto-filling complaint form from active case:', activeCase.case_number);
                
                // Fill respondent info from plaintiff (landlord)
                const plaintiffName = activeCase.plaintiff?.name || activeCase.plaintiff_name;
                if (plaintiffName) {
                    const respNameEl = document.getElementById('respondent-name');
                    if (respNameEl && !respNameEl.value) respNameEl.value = plaintiffName;
                }
                
                // Fill property address
                if (activeCase.property_address) {
                    const respAddrEl = document.getElementById('respondent-address');
                    if (respAddrEl && !respAddrEl.value) respAddrEl.value = activeCase.property_address;
                }
                
                // Fill plaintiff contact if available
                if (activeCase.plaintiff?.phone) {
                    const respPhoneEl = document.getElementById('respondent-phone');
                    if (respPhoneEl && !respPhoneEl.value) respPhoneEl.value = activeCase.plaintiff.phone;
                }
                
                // Fill company name if different from name
                if (activeCase.plaintiff?.company) {
                    const respCompEl = document.getElementById('respondent-company');
                    if (respCompEl && !respCompEl.value) respCompEl.value = activeCase.plaintiff.company;
                }
            }
        }, 500);
    </script>

    <!-- Site-Wide Help System -->
    <script src="/static/js/help-system.js"></script>
    <script src="/static/js/help-content.js"></script>
    <script>SemptifyHelp.init('complaints');</script>
</body>
</html>
