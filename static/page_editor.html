<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semptify Page Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: #16213e;
            border-bottom: 1px solid #0f3460;
            height: 50px;
            z-index: 1000;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toolbar-logo {
            font-weight: 700;
            font-size: 1rem;
            color: #60a5fa;
        }

        .page-selector {
            padding: 0.4rem 0.75rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 0.85rem;
            min-width: 200px;
        }

        .page-selector option {
            background: #16213e;
        }

        .tool-btn {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .tool-btn.active {
            background: #3b82f6;
            color: #fff;
        }

        .btn-save {
            padding: 0.5rem 1rem;
            background: #22c55e;
            border: none;
            color: #fff;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-save:hover {
            background: #16a34a;
        }

        .btn-save:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* iframe container */
        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #0d1117;
        }

        .editor-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        /* Selection overlay */
        .selection-overlay {
            position: absolute;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        .selection-overlay.visible {
            display: block;
        }

        /* Resize handles */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border: 2px solid #fff;
            border-radius: 2px;
            cursor: pointer;
            z-index: 101;
        }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        .resize-handle.n { top: -5px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.e { right: -5px; top: 50%; transform: translateY(-50%); cursor: e-resize; }
        .resize-handle.w { left: -5px; top: 50%; transform: translateY(-50%); cursor: w-resize; }

        /* Right sidebar */
        .sidebar-right {
            width: 280px;
            background: #16213e;
            border-left: 1px solid #0f3460;
            overflow-y: auto;
            padding: 1rem;
        }

        .property-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .property-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #60a5fa;
        }

        .property-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .property-label {
            font-size: 0.75rem;
            color: #888;
            width: 60px;
            flex-shrink: 0;
        }

        .property-input {
            flex: 1;
            padding: 0.4rem 0.5rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
        }

        .property-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .property-row-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .property-small-input {
            padding: 0.4rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 0.75rem;
            width: 100%;
            text-align: center;
        }

        .no-selection {
            text-align: center;
            padding: 2rem 1rem;
            color: #666;
            font-size: 0.85rem;
        }

        .element-tag {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
            margin-bottom: 0.75rem;
            display: inline-block;
        }

        /* Changes list */
        .changes-list {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .change-item {
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #888;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #22c55e;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 4000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Help bar */
        .help-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 280px;
            background: rgba(0,0,0,0.8);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #888;
            display: flex;
            gap: 2rem;
        }

        .help-bar kbd {
            background: rgba(255,255,255,0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin: 0 0.15rem;
        }

        /* Edit mode indicator */
        .edit-mode-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #22c55e;
            color: #fff;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-mode-indicator .dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Element hover highlight in iframe */
        .element-highlight {
            outline: 2px dashed #3b82f6 !important;
            outline-offset: 2px;
        }

        .element-selected {
            outline: 2px solid #3b82f6 !important;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-left">
            <span class="toolbar-logo">‚úèÔ∏è Page Editor</span>
            
            <select class="page-selector" id="pageSelector" onchange="loadPage()">
                <option value="">-- Select a page --</option>
                <option value="welcome.html">welcome.html</option>
                <option value="home.html">home.html</option>
                <option value="focus.html">focus.html</option>
                <option value="mission_control.html">mission_control.html</option>
                <option value="document_intake.html">document_intake.html</option>
                <option value="crisis_intake.html">crisis_intake.html</option>
                <option value="dashboard.html">dashboard.html</option>
                <option value="recognition.html">recognition.html</option>
                <option value="court_packet.html">court_packet.html</option>
                <option value="complaints.html">complaints.html</option>
                <option value="fraud.html">fraud.html</option>
                <option value="exposure.html">exposure.html</option>
                <option value="law_library.html">law_library.html</option>
                <option value="contacts.html">contacts.html</option>
                <option value="help.html">help.html</option>
                <option value="privacy.html">privacy.html</option>
            </select>

            <button class="tool-btn" onclick="refreshPage()">üîÑ Refresh</button>
        </div>

        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span id="changeCount" style="font-size: 0.8rem; color: #888;">No changes</span>
            <button class="tool-btn" onclick="undoChange()">‚Ü©Ô∏è Undo</button>
            <button class="btn-save" id="saveBtn" onclick="saveChanges()" disabled>üíæ Save Changes</button>
            <button class="tool-btn" onclick="exportCSS()">üìã Copy CSS</button>
        </div>
    </div>

    <div class="main-layout">
        <!-- Editor Container -->
        <div class="editor-container" id="editorContainer">
            <div class="edit-mode-indicator">
                <span class="dot"></span>
                Edit Mode
            </div>
            
            <iframe id="editorFrame" class="editor-frame"></iframe>
            
            <!-- Selection overlay -->
            <div class="selection-overlay" id="selectionOverlay">
                <div class="resize-handle nw" data-handle="nw"></div>
                <div class="resize-handle n" data-handle="n"></div>
                <div class="resize-handle ne" data-handle="ne"></div>
                <div class="resize-handle e" data-handle="e"></div>
                <div class="resize-handle se" data-handle="se"></div>
                <div class="resize-handle s" data-handle="s"></div>
                <div class="resize-handle sw" data-handle="sw"></div>
                <div class="resize-handle w" data-handle="w"></div>
            </div>

            <div class="help-bar">
                <span><kbd>Click</kbd> Select element</span>
                <span><kbd>Drag</kbd> Move element</span>
                <span><kbd>Drag handles</kbd> Resize</span>
                <span><kbd>Esc</kbd> Deselect</span>
                <span><kbd>Delete</kbd> Reset element</span>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar-right">
            <div id="propertiesPanel">
                <div class="no-selection">
                    <p>üìÑ Select a page from dropdown</p>
                    <p style="margin-top: 0.5rem; font-size: 0.75rem;">Then click any element to edit it</p>
                </div>
            </div>

            <div class="property-section" id="changesSection" style="display: none;">
                <div class="property-title">üìù Pending Changes</div>
                <div class="changes-list" id="changesList"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Saved!</div>

    <script>
        // State
        let currentPage = '';
        let selectedElement = null;
        let changes = {};
        let isDragging = false;
        let isResizing = false;
        let dragStart = { x: 0, y: 0 };
        let elementStart = { x: 0, y: 0, w: 0, h: 0 };
        let resizeHandle = null;

        const frame = document.getElementById('editorFrame');
        const overlay = document.getElementById('selectionOverlay');
        const container = document.getElementById('editorContainer');

        // Load page into iframe
        function loadPage() {
            const page = document.getElementById('pageSelector').value;
            if (!page) return;
            
            currentPage = page;
            changes = {};
            selectedElement = null;
            updateOverlay();
            updateChangesUI();
            
            frame.src = `/static/${page}`;
            
            frame.onload = () => {
                initializeEditMode();
                showToast(`Loaded ${page}`);
            };
        }

        function refreshPage() {
            if (currentPage) {
                frame.src = `/static/${currentPage}`;
                frame.onload = () => initializeEditMode();
            }
        }

        // Initialize edit mode in iframe
        function initializeEditMode() {
            const doc = frame.contentDocument;
            if (!doc) return;

            // Add edit mode styles
            const style = doc.createElement('style');
            style.textContent = `
                * { cursor: default !important; }
                a, button { pointer-events: none !important; }
                .edit-highlight { outline: 2px dashed rgba(59, 130, 246, 0.5) !important; outline-offset: 2px; }
                .edit-selected { outline: 2px solid #3b82f6 !important; outline-offset: 2px; background: rgba(59, 130, 246, 0.05) !important; }
            `;
            doc.head.appendChild(style);

            // Add event listeners to all elements
            const elements = doc.querySelectorAll('body *');
            elements.forEach(el => {
                // Skip script and style tags
                if (['SCRIPT', 'STYLE', 'LINK', 'META'].includes(el.tagName)) return;

                el.addEventListener('mouseenter', (e) => {
                    e.stopPropagation();
                    if (!isDragging && !isResizing) {
                        el.classList.add('edit-highlight');
                    }
                });

                el.addEventListener('mouseleave', (e) => {
                    el.classList.remove('edit-highlight');
                });

                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectElement(el);
                });

                el.addEventListener('mousedown', (e) => {
                    if (el === selectedElement) {
                        e.preventDefault();
                        startDrag(e);
                    }
                });
            });

            // Click on body to deselect
            doc.body.addEventListener('click', (e) => {
                if (e.target === doc.body) {
                    deselectElement();
                }
            });
        }

        // Select element
        function selectElement(el) {
            // Deselect previous
            if (selectedElement) {
                selectedElement.classList.remove('edit-selected');
            }

            selectedElement = el;
            el.classList.add('edit-selected');
            el.classList.remove('edit-highlight');
            
            updateOverlay();
            updatePropertiesPanel();
        }

        function deselectElement() {
            if (selectedElement) {
                selectedElement.classList.remove('edit-selected');
                selectedElement = null;
            }
            overlay.classList.remove('visible');
            showNoSelection();
        }

        // Update overlay position
        function updateOverlay() {
            if (!selectedElement) {
                overlay.classList.remove('visible');
                return;
            }

            const rect = selectedElement.getBoundingClientRect();
            const frameRect = frame.getBoundingClientRect();

            overlay.style.left = (frameRect.left + rect.left) + 'px';
            overlay.style.top = (frameRect.top + rect.top - 50) + 'px'; // -50 for toolbar
            overlay.style.width = rect.width + 'px';
            overlay.style.height = rect.height + 'px';
            overlay.classList.add('visible');
        }

        // Properties panel
        function updatePropertiesPanel() {
            if (!selectedElement) {
                showNoSelection();
                return;
            }

            const computed = frame.contentWindow.getComputedStyle(selectedElement);
            const rect = selectedElement.getBoundingClientRect();

            document.getElementById('propertiesPanel').innerHTML = `
                <div class="property-section">
                    <span class="element-tag">&lt;${selectedElement.tagName.toLowerCase()}&gt;</span>
                    ${selectedElement.className ? `<div style="font-size:0.7rem; color:#666; margin-top:0.25rem;">.${selectedElement.className.split(' ').join(' .')}</div>` : ''}
                </div>

                <div class="property-section">
                    <div class="property-title">üìê Size</div>
                    <div class="property-row-split">
                        <div>
                            <label class="property-label">Width</label>
                            <input type="text" class="property-small-input" id="propWidth" value="${Math.round(rect.width)}px" onchange="updateElementStyle('width', this.value)">
                        </div>
                        <div>
                            <label class="property-label">Height</label>
                            <input type="text" class="property-small-input" id="propHeight" value="${Math.round(rect.height)}px" onchange="updateElementStyle('height', this.value)">
                        </div>
                    </div>
                </div>

                <div class="property-section">
                    <div class="property-title">üìç Spacing</div>
                    <div class="property-row">
                        <label class="property-label">Margin</label>
                        <input type="text" class="property-input" id="propMargin" value="${computed.margin}" onchange="updateElementStyle('margin', this.value)">
                    </div>
                    <div class="property-row">
                        <label class="property-label">Padding</label>
                        <input type="text" class="property-input" id="propPadding" value="${computed.padding}" onchange="updateElementStyle('padding', this.value)">
                    </div>
                </div>

                <div class="property-section">
                    <div class="property-title">üé® Appearance</div>
                    <div class="property-row">
                        <label class="property-label">Background</label>
                        <input type="text" class="property-input" id="propBg" value="${computed.backgroundColor}" onchange="updateElementStyle('backgroundColor', this.value)">
                    </div>
                    <div class="property-row">
                        <label class="property-label">Color</label>
                        <input type="text" class="property-input" id="propColor" value="${computed.color}" onchange="updateElementStyle('color', this.value)">
                    </div>
                    <div class="property-row">
                        <label class="property-label">Font Size</label>
                        <input type="text" class="property-input" id="propFontSize" value="${computed.fontSize}" onchange="updateElementStyle('fontSize', this.value)">
                    </div>
                    <div class="property-row">
                        <label class="property-label">Border Radius</label>
                        <input type="text" class="property-input" id="propRadius" value="${computed.borderRadius}" onchange="updateElementStyle('borderRadius', this.value)">
                    </div>
                </div>

                <div class="property-section" style="border-bottom: none;">
                    <button class="tool-btn" style="width:100%;" onclick="resetElement()">‚Ü©Ô∏è Reset This Element</button>
                </div>
            `;
        }

        function showNoSelection() {
            document.getElementById('propertiesPanel').innerHTML = `
                <div class="no-selection">
                    <p>üëÜ Click any element to select it</p>
                    <p style="margin-top: 0.5rem; font-size: 0.75rem;">Then drag to move or resize</p>
                </div>
            `;
        }

        // Update element style
        function updateElementStyle(prop, value) {
            if (!selectedElement) return;

            // Store original value for undo
            const selector = getElementSelector(selectedElement);
            if (!changes[selector]) {
                changes[selector] = { original: {}, current: {} };
            }
            if (!changes[selector].original[prop]) {
                changes[selector].original[prop] = selectedElement.style[prop] || '';
            }
            changes[selector].current[prop] = value;

            // Apply change
            selectedElement.style[prop] = value;
            
            updateOverlay();
            updateChangesUI();
        }

        // Get CSS selector for element
        function getElementSelector(el) {
            if (el.id) return `#${el.id}`;
            
            let selector = el.tagName.toLowerCase();
            if (el.className) {
                selector += '.' + el.className.trim().split(/\s+/).join('.');
            }
            
            // Add nth-child if needed for uniqueness
            const parent = el.parentElement;
            if (parent) {
                const siblings = Array.from(parent.children).filter(c => c.tagName === el.tagName);
                if (siblings.length > 1) {
                    const index = siblings.indexOf(el) + 1;
                    selector += `:nth-of-type(${index})`;
                }
            }
            
            return selector;
        }

        // Drag functionality
        function startDrag(e) {
            if (!selectedElement) return;
            
            isDragging = true;
            dragStart = { x: e.clientX, y: e.clientY };
            
            const computed = frame.contentWindow.getComputedStyle(selectedElement);
            elementStart = {
                marginTop: parseInt(computed.marginTop) || 0,
                marginLeft: parseInt(computed.marginLeft) || 0
            };

            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function handleDrag(e) {
            if (!isDragging || !selectedElement) return;

            const dx = e.clientX - dragStart.x;
            const dy = e.clientY - dragStart.y;

            const newMarginLeft = elementStart.marginLeft + dx;
            const newMarginTop = elementStart.marginTop + dy;

            updateElementStyle('marginLeft', newMarginLeft + 'px');
            updateElementStyle('marginTop', newMarginTop + 'px');
            
            updateOverlay();
        }

        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // Resize handles
        overlay.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                startResize(e, handle.dataset.handle);
            });
        });

        function startResize(e, handle) {
            if (!selectedElement) return;
            
            isResizing = true;
            resizeHandle = handle;
            dragStart = { x: e.clientX, y: e.clientY };
            
            const rect = selectedElement.getBoundingClientRect();
            elementStart = {
                w: rect.width,
                h: rect.height
            };

            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        }

        function handleResize(e) {
            if (!isResizing || !selectedElement) return;

            const dx = e.clientX - dragStart.x;
            const dy = e.clientY - dragStart.y;

            let newW = elementStart.w;
            let newH = elementStart.h;

            if (resizeHandle.includes('e')) newW = elementStart.w + dx;
            if (resizeHandle.includes('w')) newW = elementStart.w - dx;
            if (resizeHandle.includes('s')) newH = elementStart.h + dy;
            if (resizeHandle.includes('n')) newH = elementStart.h - dy;

            if (newW > 20) updateElementStyle('width', Math.round(newW) + 'px');
            if (newH > 20) updateElementStyle('height', Math.round(newH) + 'px');
            
            updateOverlay();
            updatePropertiesPanel();
        }

        function stopResize() {
            isResizing = false;
            resizeHandle = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        // Changes management
        function updateChangesUI() {
            const count = Object.keys(changes).length;
            document.getElementById('changeCount').textContent = count ? `${count} change${count > 1 ? 's' : ''}` : 'No changes';
            document.getElementById('saveBtn').disabled = count === 0;

            const section = document.getElementById('changesSection');
            const list = document.getElementById('changesList');
            
            if (count === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = Object.entries(changes).map(([selector, data]) => {
                const props = Object.keys(data.current).join(', ');
                return `<div class="change-item">${selector}: ${props}</div>`;
            }).join('');
        }

        function undoChange() {
            if (!selectedElement) return;
            
            const selector = getElementSelector(selectedElement);
            if (changes[selector]) {
                // Restore original values
                Object.entries(changes[selector].original).forEach(([prop, value]) => {
                    selectedElement.style[prop] = value;
                });
                delete changes[selector];
                updateOverlay();
                updatePropertiesPanel();
                updateChangesUI();
            }
        }

        function resetElement() {
            undoChange();
        }

        // Save changes - generates CSS
        function saveChanges() {
            if (Object.keys(changes).length === 0) return;

            const css = generateCSS();
            
            // Copy to clipboard
            navigator.clipboard.writeText(css).then(() => {
                showToast('CSS copied to clipboard! Paste into your stylesheet.');
            });
        }

        function generateCSS() {
            let css = `/* Changes for ${currentPage} */\n/* Generated: ${new Date().toLocaleString()} */\n\n`;
            
            Object.entries(changes).forEach(([selector, data]) => {
                css += `${selector} {\n`;
                Object.entries(data.current).forEach(([prop, value]) => {
                    // Convert camelCase to kebab-case
                    const cssProp = prop.replace(/([A-Z])/g, '-$1').toLowerCase();
                    css += `    ${cssProp}: ${value};\n`;
                });
                css += `}\n\n`;
            });

            return css;
        }

        function exportCSS() {
            const css = generateCSS();
            navigator.clipboard.writeText(css);
            showToast('CSS copied!');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                deselectElement();
            }
            if (e.key === 'Delete' && selectedElement) {
                resetElement();
            }
        });

        // Window resize
        window.addEventListener('resize', updateOverlay);

        // Toast
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
