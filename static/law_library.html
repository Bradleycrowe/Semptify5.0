<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Law Library - Semptify</title>
    <link rel="stylesheet" href="/static/css/shared-nav.css">
    <link rel="stylesheet" href="/static/css/accessibility.css">
    <link rel="stylesheet" href="/static/css/help-system.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --accent: #60a5fa;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #475569;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* Main Content - Account for sidebar */
        .page-content {
            margin-left: 260px;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .page-content { margin-left: 0; padding: 1rem; }
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .hero h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .hero p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Search Bar */
        .search-container {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .voice-btn {
            padding: 1rem;
            background: var(--bg-hover);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 52px;
        }

        .voice-btn:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .voice-btn.listening {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .search-btn {
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .search-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Quick Questions */
        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .quick-q {
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--primary);
            border-radius: 2rem;
            color: var(--primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-q:hover {
            background: var(--primary);
            color: white;
        }

        /* Topic Cards Grid */
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .topic-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .topic-card.emergency {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), var(--bg-card));
        }

        .topic-card.emergency:hover {
            border-color: var(--danger);
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.2);
        }

        .topic-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .topic-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .topic-card p {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .topic-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .topic-link {
            padding: 0.25rem 0.75rem;
            background: var(--bg-hover);
            border-radius: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s;
        }

        .topic-link:hover {
            background: var(--primary);
            color: white;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .section-header h2 {
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .see-all-btn {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .see-all-btn:hover {
            text-decoration: underline;
        }

        /* Law Cards */
        .law-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .law-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .law-card:hover {
            border-color: var(--primary);
            transform: scale(1.02);
            z-index: 10;
        }

        .law-card:hover .law-card-popout {
            display: block;
        }

        .law-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .law-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .law-citation {
            font-size: 0.8rem;
            color: var(--primary);
            margin-top: 0.25rem;
        }

        .law-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .law-badge.mn { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
        .law-badge.federal { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .law-badge.case { background: rgba(139, 92, 246, 0.2); color: var(--purple); }

        .law-summary {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .law-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .law-tag {
            padding: 0.2rem 0.5rem;
            background: var(--bg-dark);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Law Card Popout - shows on hover */
        .law-card-popout {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 0 0 0.75rem 0.75rem;
            border-top: none;
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 300px;
            overflow-y: auto;
        }

        .popout-header {
            color: var(--primary);
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .popout-list {
            margin-left: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            padding-left: 0;
        }

        .popout-list li {
            margin-bottom: 0.5rem;
            line-height: 1.4;
            list-style-type: "‚úì ";
        }

        .law-card-popout .popout-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .popout-btn {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .popout-btn.primary {
            background: var(--primary);
            color: white;
        }

        .popout-btn.primary:hover {
            background: var(--primary-dark);
        }

        .popout-btn.secondary {
            background: var(--bg-hover);
            color: var(--text);
        }

        .popout-btn.secondary:hover {
            background: var(--border);
        }

        /* Mobile: tap to expand cards */
        .law-card.expanded .law-card-popout {
            display: block !important;
        }

        /* Tap indicator for mobile */
        .law-card::after {
            content: "Tap for more";
            position: absolute;
            bottom: 0.5rem;
            right: 0.75rem;
            font-size: 0.7rem;
            color: var(--primary);
            opacity: 0.7;
        }

        @media (min-width: 769px) {
            .law-card::after {
                content: "Hover for more";
            }
        }

        /* AI Librarian Panel - STICKY at top */
        .ai-panel {
            background: linear-gradient(135deg, #1e3a5f 0%, var(--bg-card) 100%);
            border: 2px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
            position: sticky;
            top: 1rem;
            z-index: 50;
        }

        .ai-panel.minimized {
            padding: 0.75rem 1.5rem;
        }

        .ai-panel.minimized .ai-response,
        .ai-panel.minimized .ai-sources {
            display: none;
        }

        .ai-panel.minimized .ai-header {
            margin-bottom: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        .ai-title h3 { font-size: 1rem; }
        .ai-title p { font-size: 0.85rem; color: var(--text-muted); }

        .ai-close {
            margin-left: auto;
            background: var(--bg-dark);
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-close:hover {
            background: var(--primary);
            color: white;
        }

        .ai-response {
            background: var(--bg-dark);
            border-radius: 0.75rem;
            padding: 1.25rem;
            line-height: 1.7;
        }

        .ai-response h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .ai-response p { margin-bottom: 0.75rem; }
        .ai-response ul { margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .ai-response li { margin-bottom: 0.25rem; }

        .ai-sources {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .ai-source {
            padding: 0.25rem 0.75rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-source:hover {
            background: var(--primary);
            color: white;
        }

        /* Quick Reference Sidebar */
        .quick-ref {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .quick-ref h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .timeline-item:last-child { border-bottom: none; }

        .timeline-days {
            min-width: 60px;
            font-weight: 700;
            color: var(--warning);
            font-size: 1.1rem;
        }

        .timeline-content h4 { font-size: 0.9rem; margin-bottom: 0.25rem; }
        .timeline-content p { font-size: 0.8rem; color: var(--text-muted); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 1rem;
            width: 100%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }

        .modal-header h2 { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .modal-header .citation { color: var(--primary); font-size: 0.9rem; }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-dark);
            border: none;
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 1.25rem;
            cursor: pointer;
        }

        .modal-close:hover { background: var(--danger); }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }

        .modal-section h3 {
            color: var(--primary);
            font-size: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-section p {
            line-height: 1.7;
            margin-bottom: 0.75rem;
        }

        .modal-section ul {
            margin-left: 1.5rem;
        }

        .modal-section li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .key-points-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .key-point {
            padding: 0.75rem 1rem;
            background: var(--bg-dark);
            border-radius: 0.5rem;
            border-left: 3px solid var(--primary);
        }

        .related-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .related-link {
            padding: 0.5rem 1rem;
            background: var(--bg-hover);
            border-radius: 0.5rem;
            text-decoration: none;
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .related-link:hover {
            background: var(--primary);
        }

        /* Disclaimer */
        .disclaimer {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--warning);
            margin-top: 2rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Shared Navigation -->
    <script src="/static/js/shared-nav.js"></script>

    <div class="page-content">
        <!-- Hero Section -->
        <div class="hero">
            <h1>üìö Minnesota Law Library</h1>
            <p>Find the laws that protect your housing rights. Search statutes, case law, and court rules.</p>
            
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="Ask a legal question... (e.g., 'How long do I have to answer an eviction?')">
                <button class="voice-btn" onclick="startVoiceSearch()" title="Voice search - speak your question" aria-label="Voice search">
                    üé§
                </button>
                <button class="search-btn" onclick="askLibrarian()">
                    ü§ñ Ask AI Librarian
                </button>
            </div>
            
            <div class="quick-questions">
                <span class="quick-q" onclick="quickSearch('eviction timeline')">‚è±Ô∏è Eviction Timeline</span>
                <span class="quick-q" onclick="quickSearch('security deposit return')">üí∞ Security Deposits</span>
                <span class="quick-q" onclick="quickSearch('habitability repairs')">üîß Repair Rights</span>
                <span class="quick-q" onclick="quickSearch('retaliation eviction')">üõ°Ô∏è Retaliation Defense</span>
                <span class="quick-q" onclick="quickSearch('reasonable accommodation')">‚ôø Accommodations</span>
            </div>
        </div>

        <!-- AI Legal Librarian Panel -->
        <div class="ai-panel active" id="aiPanel">
            <div class="ai-header" onclick="expandAI()">
                <div class="ai-avatar">ü§ñ</div>
                <div class="ai-title">
                    <h3>AI Legal Librarian</h3>
                    <p>Your guide to Minnesota tenant law</p>
                </div>
                <button class="ai-close" onclick="event.stopPropagation(); closeAI()" title="Minimize">‚àí</button>
            </div>
            <div class="ai-response" id="aiResponse">
                <h4>üëã How can I help you today?</h4>
                <p>I can help you understand Minnesota tenant rights, eviction procedures, and housing laws. Try asking me:</p>
                <ul>
                    <li>"How long do I have to respond to an eviction?"</li>
                    <li>"Can my landlord keep my security deposit?"</li>
                    <li>"What repairs is my landlord responsible for?"</li>
                </ul>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 1rem;">Type your question above or click a quick topic to get started.</p>
            </div>
            <div class="ai-sources" id="aiSources">
            </div>
        </div>

        <!-- Topic Cards -->
        <div class="topics-grid">
            <!-- Emergency: Facing Eviction -->
            <div class="topic-card emergency" onclick="showTopic('eviction')">
                <div class="topic-icon">üö®</div>
                <h3>Facing Eviction?</h3>
                <p>Know your rights and deadlines. You have 7 days to respond to an eviction complaint.</p>
                <div class="topic-links">
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.321')">Filing Answer</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.335')">Jury Trial</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.285')">Defenses</a>
                </div>
            </div>

            <!-- Security Deposits -->
            <div class="topic-card" onclick="showTopic('deposits')">
                <div class="topic-icon">üí∞</div>
                <h3>Security Deposits</h3>
                <p>Landlord must return deposit within 21 days or provide itemized deductions.</p>
                <div class="topic-links">
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.178')">Return Rules</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation();">Violations</a>
                </div>
            </div>

            <!-- Habitability -->
            <div class="topic-card" onclick="showTopic('habitability')">
                <div class="topic-icon">üè†</div>
                <h3>Habitability & Repairs</h3>
                <p>Your landlord must maintain safe, habitable conditions. Know your rent escrow rights.</p>
                <div class="topic-links">
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.161')">Warranty</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.385')">Rent Escrow</a>
                </div>
            </div>

            <!-- Retaliation -->
            <div class="topic-card" onclick="showTopic('retaliation')">
                <div class="topic-icon">üõ°Ô∏è</div>
                <h3>Retaliation Protection</h3>
                <p>Landlord can't evict you for complaining about conditions or exercising rights.</p>
                <div class="topic-links">
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.285')">90-Day Rule</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation(); showLaw('504B.441')">Complaints</a>
                </div>
            </div>

            <!-- Fair Housing -->
            <div class="topic-card" onclick="showTopic('fairhousing')">
                <div class="topic-icon">‚öñÔ∏è</div>
                <h3>Fair Housing & Discrimination</h3>
                <p>Federal and state laws protect against housing discrimination.</p>
                <div class="topic-links">
                    <a href="#" class="topic-link" onclick="event.stopPropagation();">Protected Classes</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation();">File Complaint</a>
                </div>
            </div>

            <!-- Disability & Accommodations -->
            <div class="topic-card" onclick="showTopic('disability')">
                <div class="topic-icon">‚ôø</div>
                <h3>Disability Rights</h3>
                <p>Request reasonable accommodations or modifications. ESA and service animal rights.</p>
                <div class="topic-links">
                    <a href="#" class="topic-link" onclick="event.stopPropagation();">Accommodations</a>
                    <a href="#" class="topic-link" onclick="event.stopPropagation();">Assistance Animals</a>
                </div>
            </div>
        </div>

        <!-- Quick Reference: Eviction Timeline -->
        <div class="quick-ref">
            <h3>‚è±Ô∏è Minnesota Eviction Timeline</h3>
            <div class="timeline-item">
                <div class="timeline-days">14 days</div>
                <div class="timeline-content">
                    <h4>Nonpayment Notice</h4>
                    <p>Landlord must give 14-day written notice before filing eviction for unpaid rent</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-days">7 days</div>
                <div class="timeline-content">
                    <h4>File Answer</h4>
                    <p>After being served, you have 7 days to file your Answer with the court</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-days">10 days</div>
                <div class="timeline-content">
                    <h4>Demand Jury Trial</h4>
                    <p>Must request jury trial within 10 days after filing your Answer</p>
                </div>
            </div>
            <div class="timeline-item">
                <div class="timeline-days">7-14 days</div>
                <div class="timeline-content">
                    <h4>Court Hearing</h4>
                    <p>Hearing typically scheduled 7-14 days from summons date</p>
                </div>
            </div>
        </div>

        <!-- Popular Statutes Section -->
        <div class="section-header">
            <h2>üìú Key Minnesota Statutes</h2>
            <a href="#" class="see-all-btn" onclick="showAllStatutes()">See all statutes ‚Üí</a>
        </div>
        
        <div class="law-cards" id="statuteCards">
            <div class="loading"><div class="spinner"></div> Loading statutes...</div>
        </div>

        <!-- Case Law Section -->
        <div class="section-header">
            <h2>üìñ Important Case Law</h2>
            <a href="#" class="see-all-btn" onclick="showAllCases()">See all cases ‚Üí</a>
        </div>
        
        <div class="law-cards" id="caseCards">
            <div class="loading"><div class="spinner"></div> Loading cases...</div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            ‚ö†Ô∏è <strong>Not Legal Advice:</strong> This information is for educational purposes only. 
            Laws change - verify current statutes at <a href="https://www.revisor.mn.gov" target="_blank" style="color: var(--warning);">revisor.mn.gov</a>. 
            For advice about your specific situation, consult a licensed attorney or contact 
            <a href="https://www.lawhelpmn.org" target="_blank" style="color: var(--warning);">Legal Aid</a>.
        </div>
    </div>

    <!-- Modal for detailed law view -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h2 id="modalTitle">Loading...</h2>
                    <div class="citation" id="modalCitation"></div>
                </div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading"><div class="spinner"></div> Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStatutes();
            loadCases();
        });

        // Search input enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') askLibrarian();
        });

        // Quick search
        function quickSearch(query) {
            document.getElementById('searchInput').value = query;
            askLibrarian();
        }

        // Ask AI Librarian
        async function askLibrarian() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const panel = document.getElementById('aiPanel');
            const response = document.getElementById('aiResponse');
            const sources = document.getElementById('aiSources');

            panel.classList.add('active');
            response.innerHTML = '<div class="loading"><div class="spinner"></div> Researching...</div>';
            sources.innerHTML = '';

            try {
                const res = await fetch('/api/law-library/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: query })
                });

                if (res.ok) {
                    const data = await res.json();
                    response.innerHTML = `
                        <h4>${data.topic || 'Answer'}</h4>
                        <p>${data.answer || data.response || 'No answer available.'}</p>
                        ${data.key_points ? `<ul>${data.key_points.map(p => `<li>${p}</li>`).join('')}</ul>` : ''}
                    `;

                    if (data.sources && data.sources.length > 0) {
                        sources.innerHTML = '<strong style="font-size:0.8rem;color:var(--text-muted);margin-right:0.5rem;">Sources:</strong>' +
                            data.sources.map(s => `<span class="ai-source" onclick="showLaw('${s.id}')">${s.citation || s.title}</span>`).join('');
                    }
                } else {
                    // Fallback for no API
                    response.innerHTML = `
                        <h4>Search Results for: "${query}"</h4>
                        <p>Use the topic cards below to browse relevant laws, or try searching for specific statute numbers like "504B.321".</p>
                    `;
                }
            } catch (err) {
                response.innerHTML = `
                    <h4>Search: "${query}"</h4>
                    <p>Browse the topic cards below to find relevant Minnesota laws about ${query}.</p>
                `;
            }
        }

        function closeAI() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('minimized');
            const btn = panel.querySelector('.ai-close');
            btn.textContent = panel.classList.contains('minimized') ? '+' : '‚àí';
            btn.title = panel.classList.contains('minimized') ? 'Expand' : 'Minimize';
        }

        function expandAI() {
            const panel = document.getElementById('aiPanel');
            panel.classList.remove('minimized');
            panel.classList.add('active');
            const btn = panel.querySelector('.ai-close');
            btn.textContent = '‚àí';
            btn.title = 'Minimize';
        }

        // Voice search - accessibility feature
        let voiceRecognition = null;
        
        function startVoiceSearch() {
            const voiceBtn = document.querySelector('.voice-btn');
            const searchInput = document.getElementById('searchInput');
            
            // Check if already listening
            if (voiceRecognition && voiceBtn.classList.contains('listening')) {
                voiceRecognition.stop();
                voiceBtn.classList.remove('listening');
                return;
            }
            
            // Check browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Voice search is not supported in this browser. Please try Chrome, Edge, or Safari.');
                return;
            }
            
            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = true;
            voiceRecognition.lang = 'en-US';
            
            voiceBtn.classList.add('listening');
            searchInput.placeholder = 'üé§ Listening... speak your question';
            
            voiceRecognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                searchInput.value = transcript;
            };
            
            voiceRecognition.onend = () => {
                voiceBtn.classList.remove('listening');
                searchInput.placeholder = "Ask a legal question... (e.g., 'How long do I have to answer an eviction?')";
                
                // Auto-submit if we got text
                if (searchInput.value.trim()) {
                    askLibrarian();
                }
            };
            
            voiceRecognition.onerror = (event) => {
                voiceBtn.classList.remove('listening');
                searchInput.placeholder = "Ask a legal question... (e.g., 'How long do I have to answer an eviction?')";
                
                if (event.error === 'no-speech') {
                    alert('No speech detected. Please try again.');
                } else if (event.error !== 'aborted') {
                    alert('Voice recognition error: ' + event.error);
                }
            };
            
            voiceRecognition.start();
        }

        // Load statutes
        async function loadStatutes() {
            const container = document.getElementById('statuteCards');
            
            try {
                const res = await fetch('/api/law-library/statutes');
                const data = await res.json();
                
                // Handle new response format with disclaimer
                const statutes = data.statutes || data;
                const featured = statutes.slice(0, 6);
                
                container.innerHTML = featured.map(s => `
                    <div class="law-card" data-law-id="${s.id}">
                        <div class="law-card-header">
                            <div>
                                <div class="law-title">${s.title}</div>
                                <div class="law-citation">${s.citation}</div>
                            </div>
                            <span class="law-badge ${s.category === 'federal' ? 'federal' : 'mn'}">${s.category === 'federal' ? 'Federal' : 'MN'}</span>
                        </div>
                        <div class="law-summary">${s.summary}</div>
                        <div class="law-tags">
                            ${(s.key_points || []).slice(0, 2).map(p => `<span class="law-tag">${p.substring(0, 30)}...</span>`).join('')}
                        </div>
                        <div class="law-card-popout">
                            <div class="popout-header">‚≠ê Key Points</div>
                            <ul class="popout-list">
                                ${(s.key_points || ['View details for more information']).map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            <div class="popout-actions">
                                <button class="popout-btn primary" onclick="event.stopPropagation(); showLaw('${s.id}')">üìñ Full Details</button>
                                <button class="popout-btn secondary" onclick="event.stopPropagation(); askAboutLaw('${s.id}', '${s.title}')">ü§ñ Ask AI</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = `
                    <div class="law-card" data-law-id="504B.321">
                        <div class="law-card-header">
                            <div>
                                <div class="law-title">Eviction Procedure</div>
                                <div class="law-citation">Minn. Stat. ¬ß 504B.321</div>
                            </div>
                            <span class="law-badge mn">MN</span>
                        </div>
                        <div class="law-summary">Complaint and summons requirements for eviction actions. 7-day answer deadline.</div>
                        <div class="law-card-popout">
                            <div class="popout-header">‚≠ê Key Points</div>
                            <ul class="popout-list">
                                <li>Tenant must file answer within 7 days</li>
                                <li>Requires proper service of summons</li>
                                <li>Hearing scheduled after answer filed</li>
                            </ul>
                            <div class="popout-actions">
                                <button class="popout-btn primary" onclick="event.stopPropagation(); showLaw('504B.321')">üìñ Full Details</button>
                                <button class="popout-btn secondary" onclick="event.stopPropagation(); askAboutLaw('504B.321', 'Eviction Procedure')">ü§ñ Ask AI</button>
                            </div>
                        </div>
                    </div>
                    <div class="law-card" data-law-id="504B.178">
                        <div class="law-card-header">
                            <div>
                                <div class="law-title">Security Deposits</div>
                                <div class="law-citation">Minn. Stat. ¬ß 504B.178</div>
                            </div>
                            <span class="law-badge mn">MN</span>
                        </div>
                        <div class="law-summary">21-day return requirement, interest rules, withholding limits.</div>
                        <div class="law-card-popout">
                            <div class="popout-header">‚≠ê Key Points</div>
                            <ul class="popout-list">
                                <li>Landlord has 21 days to return deposit</li>
                                <li>Must provide itemized list of deductions</li>
                                <li>Interest required on deposits over 1 year</li>
                            </ul>
                            <div class="popout-actions">
                                <button class="popout-btn primary" onclick="event.stopPropagation(); showLaw('504B.178')">üìñ Full Details</button>
                                <button class="popout-btn secondary" onclick="event.stopPropagation(); askAboutLaw('504B.178', 'Security Deposits')">ü§ñ Ask AI</button>
                            </div>
                        </div>
                    </div>
                    <div class="law-card" data-law-id="504B.161">
                        <div class="law-card-header">
                            <div>
                                <div class="law-title">Habitability Warranty</div>
                                <div class="law-citation">Minn. Stat. ¬ß 504B.161</div>
                            </div>
                            <span class="law-badge mn">MN</span>
                        </div>
                        <div class="law-summary">Landlord's duty to maintain fit and habitable premises.</div>
                        <div class="law-card-popout">
                            <div class="popout-header">‚≠ê Key Points</div>
                            <ul class="popout-list">
                                <li>Landlord must maintain safe, clean premises</li>
                                <li>Heat, water, and essential services required</li>
                                <li>Tenant can seek rent escrow if violated</li>
                            </ul>
                            <div class="popout-actions">
                                <button class="popout-btn primary" onclick="event.stopPropagation(); showLaw('504B.161')">üìñ Full Details</button>
                                <button class="popout-btn secondary" onclick="event.stopPropagation(); askAboutLaw('504B.161', 'Habitability Warranty')">ü§ñ Ask AI</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Load cases
        async function loadCases() {
            const container = document.getElementById('caseCards');
            
            try {
                const res = await fetch('/api/law-library/case-law');
                const data = await res.json();
                
                // Handle new response format with disclaimer
                const cases = data.cases || data;
                const featured = cases.slice(0, 4);
                
                container.innerHTML = featured.map(c => `
                    <div class="law-card" data-case-id="${c.id}">
                        <div class="law-card-header">
                            <div>
                                <div class="law-title">${c.case_name}</div>
                                <div class="law-citation">${c.citation}</div>
                            </div>
                            <span class="law-badge case">Case</span>
                        </div>
                        <div class="law-summary">${c.summary}</div>
                        <div class="law-card-popout">
                            <div class="popout-header">üìã Case Summary</div>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">${c.summary}</p>
                            <div class="popout-actions">
                                <button class="popout-btn primary" onclick="event.stopPropagation(); showCase('${c.id}')">üìñ Full Details</button>
                                <button class="popout-btn secondary" onclick="event.stopPropagation(); askAboutLaw('${c.id}', '${c.case_name}')">ü§ñ Ask AI</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = `
                    <div class="law-card" data-case-id="fritz-warthen">
                        <div class="law-card-header">
                            <div>
                                <div class="law-title">Fritz v. Warthen</div>
                                <div class="law-citation">298 Minn. 54, 213 N.W.2d 339 (1973)</div>
                            </div>
                            <span class="law-badge case">Case</span>
                        </div>
                        <div class="law-summary">Established implied warranty of habitability in Minnesota residential leases.</div>
                        <div class="law-card-popout">
                            <div class="popout-header">üìã Case Summary</div>
                            <ul class="popout-list">
                                <li>Landmark MN Supreme Court decision</li>
                                <li>Created implied warranty of habitability</li>
                                <li>Tenants can withhold rent for uninhabitable conditions</li>
                            </ul>
                            <div class="popout-actions">
                                <button class="popout-btn primary" onclick="event.stopPropagation(); showCase('fritz-warthen')">üìñ Full Details</button>
                                <button class="popout-btn secondary" onclick="event.stopPropagation(); askAboutLaw('fritz-warthen', 'Fritz v. Warthen')">ü§ñ Ask AI</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Show law detail modal
        async function showLaw(id) {
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const citation = document.getElementById('modalCitation');
            const body = document.getElementById('modalBody');

            overlay.classList.add('active');
            title.textContent = 'Loading...';
            citation.textContent = '';
            body.innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';

            try {
                const res = await fetch(`/api/law-library/statutes/${id}`);
                if (res.ok) {
                    const data = await res.json();
                    const statute = data.statute || data;
                    
                    title.textContent = statute.title;
                    citation.textContent = statute.citation;
                    body.innerHTML = `
                        <div class="modal-section">
                            <h3>üìù Summary</h3>
                            <p>${statute.summary}</p>
                        </div>
                        
                        <div class="modal-section">
                            <h3>‚≠ê Key Points</h3>
                            <div class="key-points-list">
                                ${(statute.key_points || []).map(p => `<div class="key-point">${p}</div>`).join('')}
                            </div>
                        </div>
                        
                        ${statute.full_text ? `
                        <div class="modal-section">
                            <h3>üìú Full Text</h3>
                            <p style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; background: var(--bg-dark); padding: 1rem; border-radius: 0.5rem;">${statute.full_text}</p>
                        </div>
                        ` : ''}
                        
                        ${statute.related_forms && statute.related_forms.length > 0 ? `
                        <div class="modal-section">
                            <h3>üìÑ Related Forms</h3>
                            <div class="related-links">
                                ${statute.related_forms.map(f => `<a href="/eviction/forms/library?form=${f}" class="related-link">${f}</a>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="modal-section">
                            <h3>üîó Official Source</h3>
                            <a href="https://www.revisor.mn.gov/statutes/cite/${statute.citation?.replace('Minn. Stat. ¬ß ', '')}" 
                               target="_blank" class="related-link">View on revisor.mn.gov ‚Üí</a>
                        </div>
                    `;
                } else {
                    body.innerHTML = '<p>Statute not found. Please try another search.</p>';
                }
            } catch (err) {
                body.innerHTML = `
                    <div class="modal-section">
                        <h3>üìú ${id}</h3>
                        <p>View the official text at:</p>
                        <a href="https://www.revisor.mn.gov/statutes/cite/${id}" target="_blank" class="related-link">
                            revisor.mn.gov/statutes/cite/${id} ‚Üí
                        </a>
                    </div>
                `;
            }
        }

        function showCase(id) {
            // Similar to showLaw but for case law
            showLaw(id); // Reuse for now
        }

        // Ask AI about a specific law from popout button
        function askAboutLaw(id, title) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = `Explain ${title} and how it applies to tenant rights`;
            searchInput.focus();
            askLibrarian();
        }

        function showTopic(topic) {
            // Filter or show topic-specific content
            const queries = {
                'eviction': 'eviction procedure rights defenses',
                'deposits': 'security deposit return',
                'habitability': 'habitability repairs maintenance',
                'retaliation': 'retaliation eviction protection',
                'fairhousing': 'fair housing discrimination',
                'disability': 'disability accommodation ADA'
            };
            document.getElementById('searchInput').value = queries[topic] || topic;
            askLibrarian();
        }

        function showAllStatutes() {
            window.location.href = '/law-library?section=statutes';
        }

        function showAllCases() {
            window.location.href = '/law-library?section=cases';
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Mobile: tap to expand law cards (since hover doesn't work on touch)
        document.addEventListener('click', (e) => {
            const card = e.target.closest('.law-card');
            if (card) {
                // If clicking on action buttons inside popout, don't toggle
                if (e.target.closest('.popout-btn')) {
                    return;
                }
                
                // Close other expanded cards
                document.querySelectorAll('.law-card.expanded').forEach(c => {
                    if (c !== card) c.classList.remove('expanded');
                });
                
                // Toggle this card
                card.classList.toggle('expanded');
            } else {
                // Clicked outside - close all expanded cards
                document.querySelectorAll('.law-card.expanded').forEach(c => {
                    c.classList.remove('expanded');
                });
            }
        });
    </script>
    
    <!-- Help System -->
    <script src="/static/js/help-system.js"></script>
    <script src="/static/js/semptify-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof SemptifyHelp !== 'undefined') {
                SemptifyHelp.init('law_library');
            }
        });
    </script>
</body>
</html>
