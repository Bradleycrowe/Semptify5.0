<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Semptify Interactive Timeline - Visual case timeline with zoom from minute to year">
  <title>Interactive Timeline - Semptify</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/static/css/design-system.css">
  <link rel="stylesheet" href="/static/css/layouts.css">
  <link rel="stylesheet" href="/static/css/help-system.css">

  <style>
    /* ================================================================
       INTERACTIVE TIMELINE - WORLD CLASS VISUALIZATION
       Zoomable from minute to year level
       ================================================================ */
    
    :root {
      --timeline-track: #e2e8f0;
      --timeline-track-dark: #334155;
      --timeline-marker: #3b82f6;
      --timeline-marker-urgent: #ef4444;
      --timeline-marker-success: #22c55e;
      --timeline-marker-warning: #f59e0b;
      --timeline-today: #8b5cf6;
      --timeline-grid: rgba(148, 163, 184, 0.2);
      --timeline-text: #64748b;
      --timeline-text-dark: #94a3b8;
    }

    [data-theme="dark"] {
      --timeline-track: #334155;
      --timeline-track-dark: #1e293b;
      --timeline-grid: rgba(148, 163, 184, 0.1);
      --timeline-text: #94a3b8;
    }

    /* Main Timeline Container */
    .timeline-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 140px);
      background: var(--surface-primary);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Timeline Header with Controls */
    .timeline-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--surface-secondary);
      border-bottom: 1px solid var(--border-primary);
      flex-shrink: 0;
    }

    .timeline-title-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .timeline-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .timeline-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Zoom Controls */
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface-primary);
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-primary);
    }

    .zoom-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .zoom-btn:hover {
      background: var(--surface-secondary);
      color: var(--text-primary);
    }

    .zoom-btn:active {
      transform: scale(0.95);
    }

    .zoom-level-display {
      min-width: 80px;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--primary);
      padding: 6px 12px;
      background: var(--primary-light);
      border-radius: 6px;
    }

    .zoom-slider {
      width: 150px;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--timeline-track);
      border-radius: 3px;
      cursor: pointer;
    }

    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Navigation Controls */
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--surface-primary);
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .nav-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Timeline Viewport */
    .timeline-viewport {
      flex: 1;
      overflow: hidden;
      position: relative;
      cursor: grab;
    }

    .timeline-viewport:active {
      cursor: grabbing;
    }

    .timeline-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.1s ease-out;
    }

    /* Timeline Track */
    .timeline-track {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--timeline-track);
      transform: translateY(-50%);
      border-radius: 2px;
    }

    /* Grid Lines */
    .timeline-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .grid-line {
      position: absolute;
      top: 60px;
      bottom: 60px;
      width: 1px;
      background: var(--timeline-grid);
    }

    .grid-line.major {
      background: var(--border-primary);
    }

    .grid-label {
      position: absolute;
      top: 20px;
      transform: translateX(-50%);
      font-size: 0.75rem;
      color: var(--timeline-text);
      white-space: nowrap;
      font-weight: 500;
    }

    .grid-label.major {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Today Marker */
    .today-marker {
      position: absolute;
      top: 40px;
      bottom: 40px;
      width: 3px;
      background: var(--timeline-today);
      border-radius: 2px;
      z-index: 10;
      box-shadow: 0 0 10px var(--timeline-today);
    }

    .today-marker::before {
      content: 'TODAY';
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.625rem;
      font-weight: 700;
      color: var(--timeline-today);
      letter-spacing: 0.5px;
      background: var(--surface-primary);
      padding: 2px 8px;
      border-radius: 4px;
    }

    /* Event Markers */
    .event-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: all 0.2s;
      z-index: 5;
    }

    .event-marker:hover {
      z-index: 20;
    }

    .marker-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--timeline-marker);
      border: 3px solid var(--surface-primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s;
    }

    .event-marker:hover .marker-dot {
      transform: scale(1.4);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .event-marker.urgent .marker-dot {
      background: var(--timeline-marker-urgent);
      animation: pulse-urgent 2s infinite;
    }

    .event-marker.success .marker-dot {
      background: var(--timeline-marker-success);
    }

    .event-marker.warning .marker-dot {
      background: var(--timeline-marker-warning);
    }

    .event-marker.court .marker-dot {
      background: var(--danger);
    }

    @keyframes pulse-urgent {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
      50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }

    /* Event Card (appears on hover/click) */
    .event-card {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
      background: var(--surface-primary);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid var(--border-primary);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      pointer-events: none;
      z-index: 100;
    }

    .event-marker:hover .event-card,
    .event-marker.active .event-card {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .event-card::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: var(--surface-primary);
    }

    .event-card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .event-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .event-card-icon.court { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .event-card-icon.notice { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .event-card-icon.payment { background: rgba(34, 197, 94, 0.1); color: var(--success); }
    .event-card-icon.communication { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
    .event-card-icon.maintenance { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }

    .event-card-title {
      flex: 1;
    }

    .event-card-title h4 {
      margin: 0;
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .event-card-title span {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .event-card-body {
      padding: 12px 16px;
    }

    .event-card-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .event-card-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .event-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    .event-meta-item i {
      font-size: 0.75rem;
    }

    .event-card-actions {
      padding: 12px 16px;
      border-top: 1px solid var(--border-primary);
      display: flex;
      gap: 8px;
    }

    .event-action-btn {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-action-btn:hover {
      background: var(--surface-secondary);
      color: var(--text-primary);
    }

    .event-action-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Timeline Stats Bar */
    .timeline-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      background: var(--surface-secondary);
      border-top: 1px solid var(--border-primary);
      flex-shrink: 0;
    }

    .stats-group {
      display: flex;
      gap: 24px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stat-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .stat-icon.events { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
    .stat-icon.urgent { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
    .stat-icon.upcoming { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

    .stat-info {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* Legend */
    .timeline-legend {
      display: flex;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.court { background: var(--danger); }
    .legend-dot.notice { background: var(--warning); }
    .legend-dot.payment { background: var(--success); }
    .legend-dot.communication { background: var(--primary); }
    .legend-dot.maintenance { background: #8b5cf6; }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .timeline-header {
        flex-direction: column;
        gap: 12px;
        padding: 12px 16px;
      }

      .zoom-controls {
        width: 100%;
        justify-content: space-between;
      }

      .zoom-slider {
        flex: 1;
      }

      .nav-controls {
        width: 100%;
        justify-content: center;
      }

      .timeline-stats {
        flex-direction: column;
        gap: 12px;
      }

      .stats-group {
        width: 100%;
        justify-content: space-around;
      }

      .timeline-legend {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* Minimap */
    .timeline-minimap {
      position: absolute;
      bottom: 80px;
      right: 24px;
      width: 200px;
      height: 60px;
      background: var(--surface-primary);
      border-radius: 12px;
      border: 1px solid var(--border-primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      z-index: 50;
    }

    .minimap-track {
      position: absolute;
      top: 50%;
      left: 10px;
      right: 10px;
      height: 2px;
      background: var(--timeline-track);
      transform: translateY(-50%);
    }

    .minimap-events {
      position: absolute;
      top: 0;
      left: 10px;
      right: 10px;
      bottom: 0;
    }

    .minimap-dot {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
    }

    .minimap-viewport {
      position: absolute;
      top: 5px;
      bottom: 5px;
      background: rgba(59, 130, 246, 0.1);
      border: 2px solid var(--primary);
      border-radius: 4px;
      cursor: move;
    }

    /* Quick Add Button */
    .quick-add-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
      transition: all 0.3s;
      z-index: 100;
    }

    .quick-add-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(59, 130, 246, 0.5);
    }

    /* Add Event Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 1000;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--surface-primary);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
      transform: translateY(20px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.25rem;
    }

    .modal-close:hover {
      background: var(--surface-secondary);
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-primary);
      background: var(--surface-secondary);
      color: var(--text-primary);
      font-size: 0.9375rem;
      transition: all 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    .event-type-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .event-type-option {
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border-primary);
      background: transparent;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .event-type-option:hover {
      border-color: var(--primary);
    }

    .event-type-option.selected {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .event-type-option i {
      font-size: 1.25rem;
      margin-bottom: 6px;
      display: block;
    }

    .event-type-option span {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-primary);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn-secondary {
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid var(--border-primary);
      background: transparent;
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
    }

    .btn-primary {
      padding: 10px 24px;
      border-radius: 10px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    /* Modal Tabs */
    .modal-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-primary);
      padding-bottom: 12px;
    }

    .modal-tab {
      flex: 1;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid transparent;
      background: var(--surface-secondary);
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .modal-tab:hover {
      background: var(--surface-primary);
      border-color: var(--border-primary);
    }

    .modal-tab.active {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-primary);
      border-radius: 16px;
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--surface-secondary);
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .drop-zone.dragover {
      transform: scale(1.02);
    }

    .drop-zone-icon {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 16px;
    }

    .drop-zone h3 {
      margin: 0 0 8px 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .drop-zone p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9375rem;
    }

    .drop-zone-hint {
      margin-top: 12px !important;
      font-size: 0.75rem !important;
      color: var(--text-tertiary) !important;
    }

    /* Upload Progress */
    .upload-progress {
      margin-top: 20px;
      padding: 20px;
      background: var(--surface-secondary);
      border-radius: 12px;
    }

    .progress-bar {
      height: 8px;
      background: var(--timeline-track);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s;
      animation: progress-pulse 1.5s ease-in-out infinite;
    }

    @keyframes progress-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .progress-text {
      margin: 12px 0 0 0;
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* Extracted Events */
    .extracted-events {
      margin-top: 20px;
    }

    .extracted-events h4 {
      margin: 0 0 16px 0;
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .extracted-events h4 i {
      color: var(--primary);
    }

    .events-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .extracted-event-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface-secondary);
      border-radius: 10px;
      border: 1px solid var(--border-primary);
    }

    .extracted-event-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .extracted-event-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .extracted-event-info {
      flex: 1;
      min-width: 0;
    }

    .extracted-event-info h5 {
      margin: 0;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .extracted-event-info span {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    .extracted-event-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .extracted-event-badge.evidence {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .extracted-event-badge.urgent {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .extracted-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      justify-content: flex-end;
    }

    /* File Info */
    .file-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface-secondary);
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .file-info-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--primary-light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
    }

    .file-info-details {
      flex: 1;
    }

    .file-info-details h5 {
      margin: 0;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .file-info-details span {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }
  </style>
</head>
<body>
  <script src="/static/js/header.js"></script>

  <div id="toast-container" class="toast-container"></div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-header">
          <a href="/" class="sidebar-brand">
            <div class="sidebar-logo-icon"><i class="fas fa-balance-scale"></i></div>
            <span class="sidebar-brand-text">Semptify</span>
          </a>
          <button class="sidebar-toggle btn btn-ghost btn-icon" id="sidebar-toggle">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        <nav class="sidebar-nav">
          <ul class="sidebar-menu">
            <li class="sidebar-item">
              <a href="/static/dashboard-v2.html" class="sidebar-link">
                <i class="fas fa-home sidebar-icon"></i>
                <span class="sidebar-text">Dashboard</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a href="/static/documents-v2.html" class="sidebar-link">
                <i class="fas fa-file-alt sidebar-icon"></i>
                <span class="sidebar-text">Documents</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a href="/static/interactive-timeline.html" class="sidebar-link active" aria-current="page">
                <i class="fas fa-stream sidebar-icon"></i>
                <span class="sidebar-text">Timeline</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a href="/static/calendar-v2.html" class="sidebar-link">
                <i class="fas fa-calendar sidebar-icon"></i>
                <span class="sidebar-text">Calendar</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>

    <div class="main-wrapper">
      <header class="header">
        <div class="header-inner">
          <button class="header-menu-toggle btn btn-ghost btn-icon" id="mobile-menu-toggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="header-title">
            <h1 class="page-title">Interactive Timeline</h1>
          </div>
        </div>
      </header>

      <main class="main-content" id="main-content">
        <div class="timeline-container">
          <!-- Timeline Header with Controls -->
          <div class="timeline-header">
            <div class="timeline-title-section">
              <div>
                <h2 class="timeline-title">Case Timeline</h2>
                <p class="timeline-subtitle">Visual history of your tenant journey</p>
              </div>
            </div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
              <button class="zoom-btn" id="zoom-out" title="Zoom Out">
                <i class="fas fa-search-minus"></i>
              </button>
              <input type="range" class="zoom-slider" id="zoom-slider" min="0" max="6" value="3">
              <button class="zoom-btn" id="zoom-in" title="Zoom In">
                <i class="fas fa-search-plus"></i>
              </button>
              <div class="zoom-level-display" id="zoom-level">Month</div>
            </div>

            <!-- Navigation Controls -->
            <div class="nav-controls">
              <button class="nav-btn" id="nav-prev">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="nav-btn active" id="nav-today">Today</button>
              <button class="nav-btn" id="nav-next">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>

          <!-- Timeline Viewport -->
          <div class="timeline-viewport" id="timeline-viewport">
            <div class="timeline-canvas" id="timeline-canvas">
              <div class="timeline-grid" id="timeline-grid"></div>
              <div class="timeline-track"></div>
              <div class="today-marker" id="today-marker"></div>
              <div id="event-markers"></div>
            </div>

            <!-- Minimap -->
            <div class="timeline-minimap" id="minimap">
              <div class="minimap-track"></div>
              <div class="minimap-events" id="minimap-events"></div>
              <div class="minimap-viewport" id="minimap-viewport"></div>
            </div>
          </div>

          <!-- Stats Bar -->
          <div class="timeline-stats">
            <div class="stats-group">
              <div class="stat-item">
                <div class="stat-icon events">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                  <span class="stat-value" id="total-events">0</span>
                  <span class="stat-label">Total Events</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon urgent">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                  <span class="stat-value" id="urgent-events">0</span>
                  <span class="stat-label">Urgent</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon upcoming">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                  <span class="stat-value" id="upcoming-events">0</span>
                  <span class="stat-label">Upcoming</span>
                </div>
              </div>
            </div>

            <div class="timeline-legend">
              <div class="legend-item">
                <div class="legend-dot court"></div>
                <span>Court</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot notice"></div>
                <span>Notice</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot payment"></div>
                <span>Payment</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot communication"></div>
                <span>Communication</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot maintenance"></div>
                <span>Maintenance</span>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Quick Add Button -->
  <button class="quick-add-btn" id="quick-add" title="Add Event">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Add Event Modal -->
  <div class="modal-overlay" id="add-event-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Timeline Event</h2>
        <button class="modal-close" id="modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Tab Navigation -->
        <div class="modal-tabs">
          <button class="modal-tab active" data-tab="upload">
            <i class="fas fa-file-upload"></i> Drop or Choose File
          </button>
          <button class="modal-tab" data-tab="manual">
            <i class="fas fa-edit"></i> Manual Entry
          </button>
        </div>

        <!-- Upload Tab (Default) -->
        <div class="tab-content active" id="tab-upload">
          <div class="drop-zone" id="drop-zone">
            <div class="drop-zone-content">
              <i class="fas fa-cloud-upload-alt drop-zone-icon"></i>
              <h3>Drop your document here</h3>
              <p>or click to choose a file</p>
              <p class="drop-zone-hint">PDF, images, or text files â€¢ Max 10MB</p>
            </div>
            <input type="file" id="file-input" accept=".pdf,.png,.jpg,.jpeg,.gif,.txt,.doc,.docx" hidden>
          </div>
          
          <div class="upload-progress" id="upload-progress" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p class="progress-text" id="progress-text">Analyzing document...</p>
          </div>

          <div class="extracted-events" id="extracted-events" style="display: none;">
            <h4><i class="fas fa-magic"></i> Events Found in Document</h4>
            <div class="events-list" id="events-list"></div>
            <div class="extracted-actions">
              <button class="btn-secondary" id="clear-extracted">Clear</button>
              <button class="btn-primary" id="add-all-events">
                <i class="fas fa-plus"></i> Add All Events
              </button>
            </div>
          </div>
        </div>

        <!-- Manual Tab -->
        <div class="tab-content" id="tab-manual">
          <div class="form-group">
            <label class="form-label">Event Type</label>
            <div class="event-type-grid">
              <button class="event-type-option selected" data-type="notice">
                <i class="fas fa-envelope" style="color: var(--warning)"></i>
                <span>Notice</span>
              </button>
              <button class="event-type-option" data-type="payment">
                <i class="fas fa-dollar-sign" style="color: var(--success)"></i>
                <span>Payment</span>
              </button>
              <button class="event-type-option" data-type="court">
                <i class="fas fa-gavel" style="color: var(--danger)"></i>
                <span>Court</span>
              </button>
              <button class="event-type-option" data-type="communication">
                <i class="fas fa-comments" style="color: var(--primary)"></i>
                <span>Communication</span>
              </button>
              <button class="event-type-option" data-type="maintenance">
                <i class="fas fa-wrench" style="color: #8b5cf6"></i>
                <span>Maintenance</span>
              </button>
              <button class="event-type-option" data-type="other">
                <i class="fas fa-ellipsis-h" style="color: var(--text-tertiary)"></i>
                <span>Other</span>
              </button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="event-title">Title</label>
            <input type="text" class="form-input" id="event-title" placeholder="e.g., Received eviction notice">
          </div>
          <div class="form-group">
            <label class="form-label" for="event-date">Date & Time</label>
            <input type="datetime-local" class="form-input" id="event-date">
          </div>
          <div class="form-group">
            <label class="form-label" for="event-description">Description</label>
            <textarea class="form-textarea" id="event-description" placeholder="Details about this event..."></textarea>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="event-evidence">
              <span class="form-label" style="margin: 0;">Mark as evidence for court</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer" id="manual-footer" style="display: none;">
        <button class="btn-secondary" id="modal-cancel">Cancel</button>
        <button class="btn-primary" id="modal-save">Add Event</button>
      </div>
    </div>
  </div>

  <!-- sidebar.js removed - using shared-nav.js instead -->
  <script>
    // ================================================================
    // INTERACTIVE TIMELINE ENGINE
    // World-class zoomable timeline from minute to year
    // ================================================================

    class InteractiveTimeline {
      constructor() {
        // Zoom levels: minute, hour, day, week, month, quarter, year
        this.zoomLevels = [
          { name: 'Minute', duration: 60 * 1000, format: 'HH:mm', gridMinor: 1, gridMajor: 5 },
          { name: 'Hour', duration: 60 * 60 * 1000, format: 'HH:mm', gridMinor: 5, gridMajor: 30 },
          { name: 'Day', duration: 24 * 60 * 60 * 1000, format: 'MMM D', gridMinor: 1, gridMajor: 6 },
          { name: 'Week', duration: 7 * 24 * 60 * 60 * 1000, format: 'MMM D', gridMinor: 1, gridMajor: 7 },
          { name: 'Month', duration: 30 * 24 * 60 * 60 * 1000, format: 'MMM YYYY', gridMinor: 7, gridMajor: 30 },
          { name: 'Quarter', duration: 90 * 24 * 60 * 60 * 1000, format: 'MMM YYYY', gridMinor: 30, gridMajor: 90 },
          { name: 'Year', duration: 365 * 24 * 60 * 60 * 1000, format: 'YYYY', gridMinor: 30, gridMajor: 365 }
        ];

        this.currentZoom = 4; // Start at Month level
        this.centerDate = new Date();
        this.events = [];
        this.isDragging = false;
        this.dragStart = { x: 0, date: null };
        this.viewportWidth = 0;
        this.pixelsPerMs = 0;

        this.init();
      }

      init() {
        this.cacheElements();
        this.bindEvents();
        this.loadEvents();
        this.updateZoomDisplay();
        this.render();
      }

      cacheElements() {
        this.viewport = document.getElementById('timeline-viewport');
        this.canvas = document.getElementById('timeline-canvas');
        this.grid = document.getElementById('timeline-grid');
        this.todayMarker = document.getElementById('today-marker');
        this.eventMarkersContainer = document.getElementById('event-markers');
        this.zoomSlider = document.getElementById('zoom-slider');
        this.zoomDisplay = document.getElementById('zoom-level');
        this.minimap = document.getElementById('minimap');
        this.minimapViewport = document.getElementById('minimap-viewport');
        this.minimapEvents = document.getElementById('minimap-events');
      }

      bindEvents() {
        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => this.zoom(1));
        document.getElementById('zoom-out').addEventListener('click', () => this.zoom(-1));
        this.zoomSlider.addEventListener('input', (e) => {
          this.currentZoom = parseInt(e.target.value);
          this.updateZoomDisplay();
          this.render();
        });

        // Navigation
        document.getElementById('nav-today').addEventListener('click', () => this.goToToday());
        document.getElementById('nav-prev').addEventListener('click', () => this.navigate(-1));
        document.getElementById('nav-next').addEventListener('click', () => this.navigate(1));

        // Viewport drag
        this.viewport.addEventListener('mousedown', (e) => this.startDrag(e));
        document.addEventListener('mousemove', (e) => this.doDrag(e));
        document.addEventListener('mouseup', () => this.endDrag());

        // Touch support
        this.viewport.addEventListener('touchstart', (e) => this.startDrag(e.touches[0]));
        document.addEventListener('touchmove', (e) => this.doDrag(e.touches[0]));
        document.addEventListener('touchend', () => this.endDrag());

        // Mouse wheel zoom
        this.viewport.addEventListener('wheel', (e) => {
          e.preventDefault();
          this.zoom(e.deltaY > 0 ? 1 : -1);
        }, { passive: false });

        // Resize handler
        window.addEventListener('resize', () => this.render());

        // Modal
        document.getElementById('quick-add').addEventListener('click', () => this.openModal());
        document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
        document.getElementById('modal-cancel').addEventListener('click', () => this.closeModal());
        document.getElementById('modal-save').addEventListener('click', () => this.saveEvent());

        // Event type selection
        document.querySelectorAll('.event-type-option').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.event-type-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          });
        });

        // Click outside modal
        document.getElementById('add-event-modal').addEventListener('click', (e) => {
          if (e.target.id === 'add-event-modal') this.closeModal();
        });
      }

      async loadEvents() {
        try {
          const token = localStorage.getItem('access_token');
          const response = await fetch('/api/timeline/', {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
          });

          if (response.ok) {
            const data = await response.json();
            this.events = data.events.map(e => ({
              ...e,
              date: new Date(e.event_date)
            }));
          } else {
            // Use sample data if not authenticated
            this.events = this.getSampleEvents();
          }
        } catch (err) {
          console.error('Failed to load events:', err);
          this.events = this.getSampleEvents();
        }

        this.updateStats();
        this.render();
      }

      getSampleEvents() {
        const now = new Date();
        return [
          {
            id: '1',
            event_type: 'notice',
            title: 'Received 14-Day Notice',
            description: 'Landlord served 14-day pay or quit notice',
            date: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000),
            is_evidence: true
          },
          {
            id: '2',
            event_type: 'communication',
            title: 'Called Landlord',
            description: 'Discussed payment plan options',
            date: new Date(now.getTime() - 25 * 24 * 60 * 60 * 1000),
            is_evidence: false
          },
          {
            id: '3',
            event_type: 'payment',
            title: 'Partial Rent Payment',
            description: 'Paid $500 towards December rent',
            date: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000),
            is_evidence: true
          },
          {
            id: '4',
            event_type: 'court',
            title: 'Received Summons',
            description: 'Eviction summons served - court date Jan 15',
            date: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000),
            is_evidence: true,
            urgent: true
          },
          {
            id: '5',
            event_type: 'maintenance',
            title: 'Reported Heating Issue',
            description: 'No heat in bedroom - submitted repair request',
            date: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000),
            is_evidence: true
          },
          {
            id: '6',
            event_type: 'court',
            title: 'Court Hearing',
            description: 'Eviction hearing scheduled',
            date: new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000),
            is_evidence: false,
            urgent: true
          },
          {
            id: '7',
            event_type: 'payment',
            title: 'January Rent Due',
            description: 'Monthly rent payment due',
            date: new Date(now.getTime() + 20 * 24 * 60 * 60 * 1000),
            is_evidence: false
          }
        ];
      }

      updateStats() {
        const now = new Date();
        const urgent = this.events.filter(e => e.urgent || e.event_type === 'court').length;
        const upcoming = this.events.filter(e => e.date > now).length;

        document.getElementById('total-events').textContent = this.events.length;
        document.getElementById('urgent-events').textContent = urgent;
        document.getElementById('upcoming-events').textContent = upcoming;
      }

      zoom(direction) {
        const newZoom = this.currentZoom + direction;
        if (newZoom >= 0 && newZoom < this.zoomLevels.length) {
          this.currentZoom = newZoom;
          this.zoomSlider.value = this.currentZoom;
          this.updateZoomDisplay();
          this.render();
        }
      }

      updateZoomDisplay() {
        this.zoomDisplay.textContent = this.zoomLevels[this.currentZoom].name;
      }

      goToToday() {
        this.centerDate = new Date();
        this.render();
      }

      navigate(direction) {
        const level = this.zoomLevels[this.currentZoom];
        this.centerDate = new Date(this.centerDate.getTime() + direction * level.duration / 2);
        this.render();
      }

      startDrag(e) {
        this.isDragging = true;
        this.dragStart = {
          x: e.clientX || e.pageX,
          date: new Date(this.centerDate)
        };
        this.viewport.style.cursor = 'grabbing';
      }

      doDrag(e) {
        if (!this.isDragging) return;

        const currentX = e.clientX || e.pageX;
        const deltaX = currentX - this.dragStart.x;
        const level = this.zoomLevels[this.currentZoom];
        
        // Calculate time delta based on pixel movement
        const msPerPixel = level.duration / (this.viewportWidth / 3);
        const timeDelta = -deltaX * msPerPixel;

        this.centerDate = new Date(this.dragStart.date.getTime() + timeDelta);
        this.render();
      }

      endDrag() {
        this.isDragging = false;
        this.viewport.style.cursor = 'grab';
      }

      render() {
        this.viewportWidth = this.viewport.clientWidth;
        const level = this.zoomLevels[this.currentZoom];
        
        // Calculate visible time range (3x viewport width for smooth scrolling)
        const visibleDuration = level.duration * 3;
        const startTime = this.centerDate.getTime() - visibleDuration / 2;
        const endTime = this.centerDate.getTime() + visibleDuration / 2;
        
        this.pixelsPerMs = this.viewportWidth / level.duration;

        this.renderGrid(startTime, endTime, level);
        this.renderTodayMarker(startTime);
        this.renderEvents(startTime, endTime);
        this.renderMinimap();
      }

      renderGrid(startTime, endTime, level) {
        this.grid.innerHTML = '';
        
        // Calculate grid intervals
        const minorInterval = level.gridMinor * 24 * 60 * 60 * 1000; // days to ms
        const majorInterval = level.gridMajor * 24 * 60 * 60 * 1000;
        
        // Adjust for sub-day zoom levels
        let actualMinor = minorInterval;
        let actualMajor = majorInterval;
        
        if (level.name === 'Minute') {
          actualMinor = 60 * 1000; // 1 minute
          actualMajor = 5 * 60 * 1000; // 5 minutes
        } else if (level.name === 'Hour') {
          actualMinor = 5 * 60 * 1000; // 5 minutes
          actualMajor = 30 * 60 * 1000; // 30 minutes
        } else if (level.name === 'Day') {
          actualMinor = 60 * 60 * 1000; // 1 hour
          actualMajor = 6 * 60 * 60 * 1000; // 6 hours
        }

        // Round start time to nearest interval
        const firstLine = Math.ceil(startTime / actualMinor) * actualMinor;

        for (let time = firstLine; time <= endTime; time += actualMinor) {
          const x = (time - startTime) * this.pixelsPerMs;
          const isMajor = time % actualMajor === 0;
          
          // Grid line
          const line = document.createElement('div');
          line.className = `grid-line ${isMajor ? 'major' : ''}`;
          line.style.left = `${x}px`;
          this.grid.appendChild(line);

          // Label (only for major lines or sparse grids)
          if (isMajor || actualMinor >= 24 * 60 * 60 * 1000) {
            const label = document.createElement('div');
            label.className = `grid-label ${isMajor ? 'major' : ''}`;
            label.style.left = `${x}px`;
            label.textContent = this.formatDate(new Date(time), level);
            this.grid.appendChild(label);
          }
        }
      }

      formatDate(date, level) {
        const options = {};
        
        switch (level.name) {
          case 'Minute':
          case 'Hour':
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          case 'Day':
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          case 'Week':
          case 'Month':
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          case 'Quarter':
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          case 'Year':
            return date.getFullYear().toString();
          default:
            return date.toLocaleDateString();
        }
      }

      renderTodayMarker(startTime) {
        const now = new Date();
        const x = (now.getTime() - startTime) * this.pixelsPerMs;
        this.todayMarker.style.left = `${x}px`;
      }

      renderEvents(startTime, endTime) {
        this.eventMarkersContainer.innerHTML = '';

        this.events.forEach(event => {
          const eventTime = event.date.getTime();
          
          // Only render visible events
          if (eventTime < startTime || eventTime > endTime) return;

          const x = (eventTime - startTime) * this.pixelsPerMs;
          
          const marker = document.createElement('div');
          marker.className = `event-marker ${event.event_type}`;
          if (event.urgent) marker.classList.add('urgent');
          marker.style.left = `${x}px`;

          // Alternate position above/below track
          const isAbove = this.events.indexOf(event) % 2 === 0;
          marker.style.top = isAbove ? '35%' : '65%';

          marker.innerHTML = `
            <div class="marker-dot"></div>
            <div class="event-card" style="${isAbove ? 'bottom: calc(100% + 12px); top: auto;' : 'top: calc(100% + 12px); bottom: auto;'}">
              <div class="event-card-header">
                <div class="event-card-icon ${event.event_type}">
                  <i class="fas ${this.getEventIcon(event.event_type)}"></i>
                </div>
                <div class="event-card-title">
                  <h4>${event.title}</h4>
                  <span>${this.formatEventDate(event.date)}</span>
                </div>
              </div>
              <div class="event-card-body">
                <p class="event-card-description">${event.description || 'No description'}</p>
                <div class="event-card-meta">
                  ${event.is_evidence ? '<span class="event-meta-item"><i class="fas fa-check-circle"></i> Evidence</span>' : ''}
                  <span class="event-meta-item"><i class="fas fa-clock"></i> ${this.getRelativeTime(event.date)}</span>
                </div>
              </div>
              <div class="event-card-actions">
                <button class="event-action-btn" onclick="timeline.editEvent('${event.id}')">Edit</button>
                <button class="event-action-btn primary" onclick="timeline.viewEvent('${event.id}')">View Details</button>
              </div>
            </div>
          `;

          // Adjust card position for above markers
          if (!isAbove) {
            const card = marker.querySelector('.event-card');
            card.style.bottom = 'auto';
            card.style.top = 'calc(100% + 12px)';
            // Move arrow to top
            card.style.setProperty('--arrow-top', '-16px');
          }

          this.eventMarkersContainer.appendChild(marker);
        });
      }

      getEventIcon(type) {
        const icons = {
          court: 'fa-gavel',
          notice: 'fa-envelope',
          payment: 'fa-dollar-sign',
          communication: 'fa-comments',
          maintenance: 'fa-wrench',
          other: 'fa-circle'
        };
        return icons[type] || icons.other;
      }

      formatEventDate(date) {
        return date.toLocaleDateString('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
      }

      getRelativeTime(date) {
        const now = new Date();
        const diff = date.getTime() - now.getTime();
        const days = Math.round(diff / (24 * 60 * 60 * 1000));

        if (days === 0) return 'Today';
        if (days === 1) return 'Tomorrow';
        if (days === -1) return 'Yesterday';
        if (days > 0) return `In ${days} days`;
        return `${Math.abs(days)} days ago`;
      }

      renderMinimap() {
        this.minimapEvents.innerHTML = '';
        
        if (this.events.length === 0) return;

        // Find date range
        const dates = this.events.map(e => e.date.getTime());
        const minDate = Math.min(...dates) - 30 * 24 * 60 * 60 * 1000;
        const maxDate = Math.max(...dates) + 30 * 24 * 60 * 60 * 1000;
        const range = maxDate - minDate;
        const width = 180; // minimap width minus padding

        // Render event dots
        this.events.forEach(event => {
          const x = ((event.date.getTime() - minDate) / range) * width;
          const dot = document.createElement('div');
          dot.className = 'minimap-dot';
          dot.style.left = `${x}px`;
          dot.style.background = this.getEventColor(event.event_type);
          this.minimapEvents.appendChild(dot);
        });

        // Position viewport indicator
        const level = this.zoomLevels[this.currentZoom];
        const viewStart = ((this.centerDate.getTime() - level.duration / 2 - minDate) / range) * width;
        const viewWidth = (level.duration / range) * width;
        
        this.minimapViewport.style.left = `${Math.max(0, viewStart + 10)}px`;
        this.minimapViewport.style.width = `${Math.min(width, Math.max(20, viewWidth))}px`;
      }

      getEventColor(type) {
        const colors = {
          court: '#ef4444',
          notice: '#f59e0b',
          payment: '#22c55e',
          communication: '#3b82f6',
          maintenance: '#8b5cf6',
          other: '#64748b'
        };
        return colors[type] || colors.other;
      }

      openModal() {
        document.getElementById('add-event-modal').classList.add('active');
        document.getElementById('event-date').value = new Date().toISOString().slice(0, 16);
      }

      closeModal() {
        document.getElementById('add-event-modal').classList.remove('active');
        document.getElementById('event-title').value = '';
        document.getElementById('event-description').value = '';
        document.getElementById('event-evidence').checked = false;
      }

      async saveEvent() {
        const selectedType = document.querySelector('.event-type-option.selected');
        const title = document.getElementById('event-title').value;
        const date = document.getElementById('event-date').value;
        const description = document.getElementById('event-description').value;
        const isEvidence = document.getElementById('event-evidence').checked;

        if (!title || !date) {
          this.showToast('Please fill in required fields', 'error');
          return;
        }

        const eventData = {
          event_type: selectedType?.dataset.type || 'other',
          title,
          event_date: new Date(date).toISOString(),
          description,
          is_evidence: isEvidence
        };

        try {
          const token = localStorage.getItem('access_token');
          const response = await fetch('/api/timeline/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(eventData)
          });

          if (response.ok) {
            this.showToast('Event added successfully!', 'success');
            this.closeModal();
            await this.loadEvents();
          } else {
            // Add locally if not authenticated
            this.events.push({
              ...eventData,
              id: Date.now().toString(),
              date: new Date(date)
            });
            this.updateStats();
            this.render();
            this.closeModal();
            this.showToast('Event added locally', 'info');
          }
        } catch (err) {
          console.error('Failed to save event:', err);
          this.showToast('Failed to save event', 'error');
        }
      }

      editEvent(id) {
        console.log('Edit event:', id);
        // TODO: Implement edit functionality
      }

      viewEvent(id) {
        const event = this.events.find(e => e.id === id);
        if (event) {
          this.centerDate = new Date(event.date);
          this.render();
        }
      }

      showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
          <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
          <span>${message}</span>
        `;
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    }

    // Initialize timeline
    let timeline;
    document.addEventListener('DOMContentLoaded', () => {
      timeline = new InteractiveTimeline();
    });

    // ================================================================
    // FILE UPLOAD & DOCUMENT INTELLIGENCE
    // Drop a file â†’ Auto-extract timeline events
    // ================================================================

    class FileUploadHandler {
      constructor(timeline) {
        this.timeline = timeline;
        this.extractedEvents = [];
        this.uploadedFile = null;
        this.init();
      }

      init() {
        this.dropZone = document.getElementById('drop-zone');
        this.fileInput = document.getElementById('file-input');
        this.uploadProgress = document.getElementById('upload-progress');
        this.progressFill = document.getElementById('progress-fill');
        this.progressText = document.getElementById('progress-text');
        this.extractedEventsDiv = document.getElementById('extracted-events');
        this.eventsList = document.getElementById('events-list');

        this.bindEvents();
      }

      bindEvents() {
        // Tab switching
        document.querySelectorAll('.modal-tab').forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });

        // Drop zone events
        this.dropZone.addEventListener('click', () => this.fileInput.click());
        this.dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.dropZone.addEventListener('dragleave', () => this.handleDragLeave());
        this.dropZone.addEventListener('drop', (e) => this.handleDrop(e));
        this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

        // Extracted events actions
        document.getElementById('clear-extracted')?.addEventListener('click', () => this.clearExtracted());
        document.getElementById('add-all-events')?.addEventListener('click', () => this.addAllEvents());
      }

      switchTab(tabName) {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Show/hide footer for manual tab
        const footer = document.getElementById('manual-footer');
        if (footer) {
          footer.style.display = tabName === 'manual' ? 'flex' : 'none';
        }
      }

      handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        this.dropZone.classList.add('dragover');
      }

      handleDragLeave() {
        this.dropZone.classList.remove('dragover');
      }

      handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          this.processFile(files[0]);
        }
      }

      handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
          this.processFile(files[0]);
        }
      }

      async processFile(file) {
        // Validate file size
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (file.size > maxSize) {
          this.timeline.showToast('File too large. Max 10MB allowed.', 'error');
          return;
        }

        this.uploadedFile = file;
        this.showProgress();
        
        try {
          const events = await this.uploadAndAnalyze(file);
          this.extractedEvents = events;
          this.showExtractedEvents(events, file);
        } catch (err) {
          console.error('Upload failed:', err);
          this.timeline.showToast('Failed to analyze document', 'error');
          this.hideProgress();
        }
      }

      async uploadAndAnalyze(file) {
        const formData = new FormData();
        formData.append('file', file);

        this.updateProgress(20, 'Uploading document...');

        try {
          const token = localStorage.getItem('access_token');
          
          // Upload the document
          const uploadResponse = await fetch('/api/documents/upload', {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: formData
          });

          if (!uploadResponse.ok) {
            throw new Error('Upload failed');
          }

          const uploadData = await uploadResponse.json();
          this.updateProgress(50, 'Analyzing document...');

          // Get intelligence analysis
          const docId = uploadData.document?.id || uploadData.id;
          if (docId) {
            const intelligenceResponse = await fetch(`/api/documents/${docId}/intelligence`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });

            if (intelligenceResponse.ok) {
              const intelligence = await intelligenceResponse.json();
              this.updateProgress(80, 'Extracting events...');
              
              const events = this.extractEventsFromIntelligence(intelligence, uploadData.document || uploadData);
              this.updateProgress(100, 'Done!');
              return events;
            }
          }

          this.updateProgress(100, 'Done!');
          return this.extractBasicEvents(uploadData.document || uploadData, file);

        } catch (err) {
          this.updateProgress(100, 'Done!');
          return this.extractBasicEvents(null, file);
        }
      }

      extractEventsFromIntelligence(intelligence, doc) {
        const events = [];
        
        // Extract timeline events from intelligence
        if (intelligence.timeline_events && Array.isArray(intelligence.timeline_events)) {
          intelligence.timeline_events.forEach(te => {
            events.push({
              id: `extracted-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
              event_type: this.mapEventType(te.event_type || intelligence.document_type),
              title: te.title || te.description,
              description: te.description,
              date: te.date ? new Date(te.date) : new Date(),
              is_evidence: te.is_evidence || intelligence.urgency === 'critical',
              urgent: intelligence.urgency === 'critical' || intelligence.urgency === 'high',
              document_id: doc?.id,
              selected: true
            });
          });
        }

        // Extract events from action items with deadlines
        if (intelligence.action_items && Array.isArray(intelligence.action_items)) {
          intelligence.action_items.forEach(ai => {
            if (ai.deadline) {
              events.push({
                id: `action-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                event_type: ai.priority === 'critical' ? 'court' : 'notice',
                title: ai.action,
                description: `Deadline: ${ai.deadline}${ai.legal_basis ? ` (${ai.legal_basis})` : ''}`,
                date: this.parseDeadline(ai.deadline),
                is_evidence: false,
                urgent: ai.priority === 'critical' || ai.priority === 'high',
                document_id: doc?.id,
                selected: true
              });
            }
          });
        }

        // If no events extracted, create one for the document itself
        if (events.length === 0 && doc) {
          events.push({
            id: `doc-${Date.now()}`,
            event_type: this.mapEventType(intelligence.document_type || doc.doc_type),
            title: intelligence.plain_english?.title || doc.title || 'Document Received',
            description: intelligence.plain_english?.summary || doc.description || '',
            date: new Date(doc.created_at || new Date()),
            is_evidence: true,
            urgent: intelligence.urgency === 'critical',
            document_id: doc.id,
            selected: true
          });
        }

        return events;
      }

      extractBasicEvents(doc, file) {
        const filename = file.name.toLowerCase();
        let eventType = 'other';
        let title = file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
        let isEvidence = true;
        let urgent = false;

        // Detect type from filename
        if (filename.includes('summons') || filename.includes('complaint')) {
          eventType = 'court';
          title = 'Court Summons Received';
          urgent = true;
        } else if (filename.includes('notice') || filename.includes('eviction')) {
          eventType = 'notice';
          title = 'Notice Received';
          urgent = true;
        } else if (filename.includes('lease') || filename.includes('agreement')) {
          eventType = 'other';
          title = 'Lease Document';
        } else if (filename.includes('receipt') || filename.includes('payment')) {
          eventType = 'payment';
          title = 'Payment Record';
        } else if (filename.includes('repair') || filename.includes('maintenance')) {
          eventType = 'maintenance';
          title = 'Maintenance Request/Record';
        } else if (filename.includes('letter') || filename.includes('email')) {
          eventType = 'communication';
          title = 'Communication Record';
        }

        return [{
          id: `file-${Date.now()}`,
          event_type: eventType,
          title: title,
          description: `Uploaded: ${file.name} (${this.formatFileSize(file.size)})`,
          date: new Date(),
          is_evidence: isEvidence,
          urgent: urgent,
          document_id: doc?.id,
          selected: true
        }];
      }

      mapEventType(docType) {
        const mapping = {
          'summons': 'court',
          'complaint': 'court',
          'writ': 'court',
          'order': 'court',
          'notice': 'notice',
          'eviction_notice': 'notice',
          'lease': 'other',
          'rental_agreement': 'other',
          'payment': 'payment',
          'receipt': 'payment',
          'repair_request': 'maintenance',
          'maintenance': 'maintenance',
          'letter': 'communication',
          'email': 'communication'
        };
        return mapping[docType?.toLowerCase()] || 'other';
      }

      parseDeadline(deadline) {
        const date = new Date(deadline);
        if (!isNaN(date.getTime())) {
          return date;
        }
        
        const daysMatch = deadline.match(/(\d+)\s*days?/i);
        if (daysMatch) {
          const days = parseInt(daysMatch[1]);
          return new Date(Date.now() + days * 24 * 60 * 60 * 1000);
        }

        return new Date();
      }

      formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      showProgress() {
        this.dropZone.style.display = 'none';
        this.uploadProgress.style.display = 'block';
        this.extractedEventsDiv.style.display = 'none';
      }

      hideProgress() {
        this.dropZone.style.display = 'block';
        this.uploadProgress.style.display = 'none';
      }

      updateProgress(percent, text) {
        this.progressFill.style.width = `${percent}%`;
        this.progressText.textContent = text;
      }

      showExtractedEvents(events, file) {
        this.uploadProgress.style.display = 'none';
        this.extractedEventsDiv.style.display = 'block';
        
        let html = `
          <div class="file-info">
            <div class="file-info-icon">
              <i class="fas ${this.getFileIcon(file.type)}"></i>
            </div>
            <div class="file-info-details">
              <h5>${file.name}</h5>
              <span>${this.formatFileSize(file.size)}</span>
            </div>
          </div>
        `;

        if (events.length === 0) {
          html += `<p style="text-align: center; color: var(--text-tertiary);">No events could be extracted. Try adding manually.</p>`;
        } else {
          events.forEach((event, index) => {
            html += `
              <div class="extracted-event-item">
                <input type="checkbox" id="event-${index}" ${event.selected ? 'checked' : ''} 
                       onchange="fileHandler.toggleEvent(${index})">
                <div class="extracted-event-icon" style="background: ${this.getEventBgColor(event.event_type)}; color: ${this.getEventColor(event.event_type)}">
                  <i class="fas ${this.timeline.getEventIcon(event.event_type)}"></i>
                </div>
                <div class="extracted-event-info">
                  <h5>${event.title}</h5>
                  <span>${this.timeline.formatEventDate(event.date)}</span>
                </div>
                ${event.urgent ? '<span class="extracted-event-badge urgent">Urgent</span>' : ''}
                ${event.is_evidence ? '<span class="extracted-event-badge evidence">Evidence</span>' : ''}
              </div>
            `;
          });
        }

        this.eventsList.innerHTML = html;
      }

      getFileIcon(mimeType) {
        if (mimeType?.includes('pdf')) return 'fa-file-pdf';
        if (mimeType?.includes('image')) return 'fa-file-image';
        if (mimeType?.includes('word')) return 'fa-file-word';
        return 'fa-file-alt';
      }

      getEventColor(type) {
        const colors = {
          court: 'var(--danger)',
          notice: 'var(--warning)',
          payment: 'var(--success)',
          communication: 'var(--primary)',
          maintenance: '#8b5cf6',
          other: 'var(--text-tertiary)'
        };
        return colors[type] || colors.other;
      }

      getEventBgColor(type) {
        const colors = {
          court: 'rgba(239, 68, 68, 0.1)',
          notice: 'rgba(245, 158, 11, 0.1)',
          payment: 'rgba(34, 197, 94, 0.1)',
          communication: 'rgba(59, 130, 246, 0.1)',
          maintenance: 'rgba(139, 92, 246, 0.1)',
          other: 'rgba(100, 116, 139, 0.1)'
        };
        return colors[type] || colors.other;
      }

      toggleEvent(index) {
        if (this.extractedEvents[index]) {
          this.extractedEvents[index].selected = !this.extractedEvents[index].selected;
        }
      }

      clearExtracted() {
        this.extractedEvents = [];
        this.uploadedFile = null;
        this.hideProgress();
        this.extractedEventsDiv.style.display = 'none';
        this.dropZone.style.display = 'block';
        this.fileInput.value = '';
      }

      async addAllEvents() {
        const selectedEvents = this.extractedEvents.filter(e => e.selected);
        
        if (selectedEvents.length === 0) {
          this.timeline.showToast('No events selected', 'warning');
          return;
        }

        let added = 0;
        const token = localStorage.getItem('access_token');

        for (const event of selectedEvents) {
          try {
            const response = await fetch('/api/timeline/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify({
                event_type: event.event_type,
                title: event.title,
                description: event.description,
                event_date: event.date.toISOString(),
                is_evidence: event.is_evidence,
                document_id: event.document_id
              })
            });

            if (response.ok) {
              added++;
            } else {
              this.timeline.events.push({
                ...event,
                id: `local-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
              });
              added++;
            }
          } catch (err) {
            this.timeline.events.push({
              ...event,
              id: `local-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            });
            added++;
          }
        }

        this.timeline.showToast(`Added ${added} event${added !== 1 ? 's' : ''} to timeline!`, 'success');
        this.timeline.closeModal();
        await this.timeline.loadEvents();
        this.clearExtracted();
      }
    }

    // Initialize file handler after timeline
    let fileHandler;
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        fileHandler = new FileUploadHandler(timeline);
      }, 100);
    });
  </script>
  
  <!-- Voice Input for Accessibility -->
  <script src="/static/js/voice-input.js"></script>
  
  <!-- Help System -->
  <script src="/static/js/help-system.js"></script>
  <script src="/static/js/semptify-auth.js"></script>
  <script>
      document.addEventListener('DOMContentLoaded', () => {
          if (typeof SemptifyHelp !== 'undefined') {
              SemptifyHelp.init('interactive_timeline');
          }
      });
  </script>
</body>
</html>