<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíº Document Briefcase - Semptify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/shared-nav.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            
            /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
               14-COLOR EXTRACTION SYSTEM
               Each field type has: Color + Category Code + Number
               Format: [CODE]-[NUMBER] e.g., DT-1, PT-2, $-3
               ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
            
            /* ORIGINAL 8 COLORS */
            --hl-date: #fbbf24;      /* DT - Dates & Deadlines (Amber) */
            --hl-party: #3b82f6;     /* PT - Parties & Names (Blue) */
            --hl-amount: #10b981;    /* $  - Money & Amounts (Emerald) */
            --hl-address: #8b5cf6;   /* AD - Addresses & Locations (Violet) */
            --hl-legal: #ef4444;     /* LG - Legal Terms & Citations (Red) */
            --hl-note: #f97316;      /* NT - Notes & Footnotes (Orange) */
            --hl-form: #ec4899;      /* FM - Form Field Data (Pink) */
            --hl-event: #06b6d4;     /* EV - Events & Actions (Cyan) */
            
            /* NEW 6 COLORS FOR ENHANCED SYSTEM */
            --hl-deadline: #dc2626;  /* DL - Critical Deadlines (Deep Red) */
            --hl-witness: #84cc16;   /* WS - Witness/Testimony (Lime) */
            --hl-violation: #f43f5e; /* VL - Violations/Issues (Rose) */
            --hl-evidence: #14b8a6;  /* ED - Evidence Markers (Teal) */
            --hl-quote: #a855f7;     /* QT - Quoted Text (Purple) */
            --hl-timeline: #0ea5e9;  /* TL - Timeline Key Dates (Sky Blue) */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        .main-content {
            margin-left: 260px;
            padding: 0;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        body:not(.nav-pinned) .main-content { margin-left: 60px; }

        @media (max-width: 768px) { .main-content { margin-left: 0 !important; } }

        .page-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Main Layout */
        .workspace {
            display: grid;
            grid-template-columns: 280px 1fr 350px;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .workspace { grid-template-columns: 1fr; }
            .file-panel, .fields-panel { display: none; }
            .file-panel.mobile-open, .fields-panel.mobile-open { 
                display: block; 
                position: fixed;
                inset: 0;
                z-index: 100;
                background: var(--bg-dark);
            }
        }

        /* Left Panel - File Sources */
        .file-panel {
            background: var(--bg-card);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 1rem;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .source-btn {
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
            text-align: left;
            color: var(--text);
        }

        .source-btn:hover { 
            border-color: var(--primary); 
            background: rgba(59, 130, 246, 0.1); 
        }

        .source-btn.dragover { 
            border-color: var(--success); 
            background: rgba(16, 185, 129, 0.1); 
        }

        .source-btn .icon { font-size: 1.5rem; margin-right: 0.75rem; }
        .source-btn .label { font-weight: 500; }
        .source-btn .desc { font-size: 0.75rem; color: var(--text-muted); }

        .doc-type-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .doc-type-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .doc-type-select:focus { outline: none; border-color: var(--primary); }

        .scan-options { margin-top: 1rem; }
        .scan-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.85rem;
        }
        .scan-option:hover { background: rgba(255,255,255,0.05); }
        .scan-option input { width: 16px; height: 16px; accent-color: var(--primary); }

        .analyze-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .analyze-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Center - Document Preview */
        .preview-panel {
            background: #0d1117;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-toolbar {
            padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .toolbar-group { display: flex; align-items: center; gap: 0.5rem; }

        .toolbar-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            transition: background 0.2s;
        }

        .toolbar-btn:hover { background: rgba(255,255,255,0.2); }
        .toolbar-btn.active { background: var(--primary); }

        .highlight-btn {
            position: relative;
            padding-left: 1.75rem;
        }

        .highlight-btn::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .highlight-btn[data-color="date"]::before { background: var(--hl-date); }
        .highlight-btn[data-color="party"]::before { background: var(--hl-party); }
        .highlight-btn[data-color="amount"]::before { background: var(--hl-amount); }
        .highlight-btn[data-color="address"]::before { background: var(--hl-address); }
        .highlight-btn[data-color="legal"]::before { background: var(--hl-legal); }
        .highlight-btn[data-color="note"]::before { background: var(--hl-note); }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .zoom-control input[type="range"] {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .zoom-control input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .preview-content {
            flex: 1;
            overflow: auto;
            padding: 1rem;
            display: flex;
            justify-content: center;
        }

        .document-display {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-width: 100%;
            transform-origin: top center;
            transition: transform 0.2s;
        }

        .document-display img {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .document-text {
            padding: 2rem;
            font-family: 'Times New Roman', serif;
            font-size: 14px;
            line-height: 1.8;
            color: #1a1a1a;
            min-width: 600px;
            max-width: 800px;
        }

        /* PDF Multi-Page Container */
        .pdf-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            width: 100%;
        }

        .pdf-page {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .pdf-page canvas {
            display: block;
            max-width: 100%;
            height: auto !important;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           PDF TEXT LAYER - Enables text selection, copy, highlight
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .pdf-text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1.0;
            pointer-events: auto;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .pdf-text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }

        .pdf-text-layer > span::selection {
            background: rgba(59, 130, 246, 0.4);
        }

        .pdf-text-layer > span::-moz-selection {
            background: rgba(59, 130, 246, 0.4);
        }

        /* When text is selected, make it more visible */
        .pdf-text-layer.selecting {
            opacity: 0.5;
        }

        /* Highlight text that matches extraction */
        .pdf-text-layer .hl-date { background: rgba(251, 191, 36, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-party { background: rgba(59, 130, 246, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-amount { background: rgba(16, 185, 129, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-address { background: rgba(139, 92, 246, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-legal { background: rgba(239, 68, 68, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-note { background: rgba(249, 115, 22, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-form { background: rgba(236, 72, 153, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-event { background: rgba(6, 182, 212, 0.5) !important; color: transparent; }
        /* NEW: 6 Additional highlight colors */
        .pdf-text-layer .hl-deadline { background: rgba(220, 38, 38, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-witness { background: rgba(132, 204, 22, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-violation { background: rgba(244, 63, 94, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-evidence { background: rgba(20, 184, 166, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-quote { background: rgba(168, 85, 247, 0.5) !important; color: transparent; }
        .pdf-text-layer .hl-timeline { background: rgba(14, 165, 233, 0.5) !important; color: transparent; }

        .pdf-page-number {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            text-align: center;
            border-radius: 0 0 4px 4px;
        }

        /* Annotation Overlay System - Original Preserved */
        .annotation-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .annotation-layer.editable {
            pointer-events: auto;
        }

        .annotation-highlight {
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            border-radius: 3px;
            transition: opacity 0.2s;
        }

        .annotation-highlight.date { background: rgba(251, 191, 36, 0.4); border: 2px solid var(--hl-date); }
        .annotation-highlight.party { background: rgba(59, 130, 246, 0.4); border: 2px solid var(--hl-party); }
        .annotation-highlight.amount { background: rgba(16, 185, 129, 0.4); border: 2px solid var(--hl-amount); }
        .annotation-highlight.address { background: rgba(139, 92, 246, 0.4); border: 2px solid var(--hl-address); }
        .annotation-highlight.note { background: rgba(249, 115, 22, 0.4); border: 2px solid var(--hl-note); }
        .annotation-highlight.legal { background: rgba(239, 68, 68, 0.4); border: 2px solid var(--hl-legal); }
        .annotation-highlight.form { background: rgba(236, 72, 153, 0.4); border: 2px solid var(--hl-form); }
        .annotation-highlight.event { background: rgba(6, 182, 212, 0.4); border: 2px solid var(--hl-event); }
        /* NEW: 6 Additional annotation highlight classes */
        .annotation-highlight.deadline { background: rgba(220, 38, 38, 0.4); border: 2px solid var(--hl-deadline); }
        .annotation-highlight.witness { background: rgba(132, 204, 22, 0.4); border: 2px solid var(--hl-witness); }
        .annotation-highlight.violation { background: rgba(244, 63, 94, 0.4); border: 2px solid var(--hl-violation); }
        .annotation-highlight.evidence { background: rgba(20, 184, 166, 0.4); border: 2px solid var(--hl-evidence); }
        .annotation-highlight.quote { background: rgba(168, 85, 247, 0.4); border: 2px solid var(--hl-quote); }
        .annotation-highlight.timeline { background: rgba(14, 165, 233, 0.4); border: 2px solid var(--hl-timeline); }

        .annotation-marker {
            position: absolute;
            top: -10px;
            right: -10px;
            min-width: 24px;
            height: 18px;
            border-radius: 9px;
            font-size: 9px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 11;
            padding: 0 4px;
        }

        .annotation-marker.date { background: var(--hl-date); color: #1a1a1a; }
        .annotation-marker.party { background: var(--hl-party); }
        .annotation-marker.amount { background: var(--hl-amount); }
        .annotation-marker.address { background: var(--hl-address); }
        .annotation-marker.note { background: var(--hl-note); }
        .annotation-marker.legal { background: var(--hl-legal); }
        .annotation-marker.form { background: var(--hl-form); }
        .annotation-marker.event { background: var(--hl-event); }
        /* NEW: 6 Additional annotation marker classes */
        .annotation-marker.deadline { background: var(--hl-deadline); }
        .annotation-marker.witness { background: var(--hl-witness); color: #1a1a1a; }
        .annotation-marker.violation { background: var(--hl-violation); }
        .annotation-marker.evidence { background: var(--hl-evidence); }
        .annotation-marker.quote { background: var(--hl-quote); }
        .annotation-marker.timeline { background: var(--hl-timeline); }

        /* Detection Method Badge - Shows HOW it was found */
        .detection-badge {
            position: absolute;
            bottom: -16px;
            left: 0;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(0,0,0,0.7);
            color: #ccc;
            white-space: nowrap;
        }

        .detection-badge.pattern { color: #fbbf24; }
        .detection-badge.context { color: #3b82f6; }
        .detection-badge.keyword { color: #10b981; }
        .detection-badge.ai { color: #ec4899; }
        .detection-badge.manual { color: #f97316; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           COLOR KEY LEGEND - Shows what each color means
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .color-key-legend {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1rem;
            z-index: 50;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            flex-wrap: wrap;
            max-width: 90vw;
            justify-content: center;
        }

        .color-key-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .color-key-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .color-key-code {
            font-weight: 700;
            font-family: monospace;
        }

        /* Document ID Badge */
        .doc-id-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-family: monospace;
            z-index: 20;
        }

        .annotation-note-popup {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 0.75rem;
            min-width: 200px;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
        }

        .annotation-note-popup.active { display: block; }

        .annotation-note-popup textarea {
            width: 100%;
            min-height: 60px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: var(--text);
            padding: 0.5rem;
            font-size: 0.85rem;
            resize: vertical;
        }

        /* Original Document Badge */
        .original-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .annotations-toggle {
            background: rgba(139, 92, 246, 0.9);
            margin-left: 0.5rem;
        }

        /* Processing Status Panel */
        .processing-panel {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }

        .processing-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .processing-stat .label { color: var(--text-muted); }
        .processing-stat .value { font-weight: 600; }

        /* Extraction Index Table */
        .extraction-index {
            font-size: 0.75rem;
            width: 100%;
            border-collapse: collapse;
        }

        .extraction-index th,
        .extraction-index td {
            padding: 0.375rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .extraction-index th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
        }

        .extraction-code {
            font-family: monospace;
            font-weight: 700;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 3rem;
            color: var(--text-muted);
        }

        .pdf-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            color: #fca5a5;
        }

        .empty-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-preview i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }

        /* Highlighted text in document */
        .hl-date { background: rgba(251, 191, 36, 0.3); border-bottom: 2px solid var(--hl-date); cursor: pointer; }
        .hl-party { background: rgba(59, 130, 246, 0.3); border-bottom: 2px solid var(--hl-party); cursor: pointer; }
        .hl-amount { background: rgba(16, 185, 129, 0.3); border-bottom: 2px solid var(--hl-amount); cursor: pointer; }
        .hl-address { background: rgba(139, 92, 246, 0.3); border-bottom: 2px solid var(--hl-address); cursor: pointer; }
        .hl-legal { background: rgba(239, 68, 68, 0.3); border-bottom: 2px solid var(--hl-legal); cursor: pointer; }
        .hl-note { background: rgba(249, 115, 22, 0.3); border-bottom: 2px solid var(--hl-note); cursor: pointer; }

        .footnote-marker {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            color: white;
            vertical-align: super;
            margin-left: 2px;
            cursor: pointer;
        }

        .footnote-marker.date { background: var(--hl-date); color: #1a1a1a; }
        .footnote-marker.party { background: var(--hl-party); }
        .footnote-marker.amount { background: var(--hl-amount); }
        .footnote-marker.address { background: var(--hl-address); }
        .footnote-marker.legal { background: var(--hl-legal); }
        .footnote-marker.note { background: var(--hl-note); }

        /* Right Panel - Fields */
        .fields-panel {
            background: var(--bg-card);
            border-left: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .fields-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .field-groups { flex: 1; overflow-y: auto; padding: 0.5rem; }

        .field-group {
            margin-bottom: 1rem;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .field-group-header {
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .field-group-header .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .field-group-header .count {
            margin-left: auto;
            background: rgba(255,255,255,0.1);
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .field-group-content { padding: 0.5rem; }

        .field-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.625rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .field-item:hover { background: rgba(255,255,255,0.08); }
        .field-item.date { border-left-color: var(--hl-date); }
        .field-item.party { border-left-color: var(--hl-party); }
        .field-item.amount { border-left-color: var(--hl-amount); }
        .field-item.address { border-left-color: var(--hl-address); }
        .field-item.legal { border-left-color: var(--hl-legal); }
        .field-item.note { border-left-color: var(--hl-note); }
        .field-item.form { border-left-color: var(--hl-form); }
        .field-item.event { border-left-color: var(--hl-event); }
        /* NEW: 6 Additional field item styles */
        .field-item.deadline { border-left-color: var(--hl-deadline); }
        .field-item.witness { border-left-color: var(--hl-witness); }
        .field-item.violation { border-left-color: var(--hl-violation); }
        .field-item.evidence { border-left-color: var(--hl-evidence); }
        .field-item.quote { border-left-color: var(--hl-quote); }
        .field-item.timeline { border-left-color: var(--hl-timeline); }

        .field-number {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .field-number.date { background: var(--hl-date); color: #1a1a1a; }
        .field-number.party { background: var(--hl-party); color: white; }
        .field-number.amount { background: var(--hl-amount); color: white; }
        .field-number.address { background: var(--hl-address); color: white; }
        .field-number.legal { background: var(--hl-legal); color: white; }
        .field-number.note { background: var(--hl-note); color: white; }
        .field-number.form { background: var(--hl-form); color: white; }
        .field-number.event { background: var(--hl-event); color: white; }
        /* NEW: 6 Additional field number styles */
        .field-number.deadline { background: var(--hl-deadline); color: white; }
        .field-number.witness { background: var(--hl-witness); color: #1a1a1a; }
        .field-number.violation { background: var(--hl-violation); color: white; }
        .field-number.evidence { background: var(--hl-evidence); color: white; }
        .field-number.quote { background: var(--hl-quote); color: white; }
        .field-number.timeline { background: var(--hl-timeline); color: white; }

        .field-content { flex: 1; min-width: 0; }

        .field-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .field-value {
            font-size: 0.85rem;
            word-break: break-word;
        }

        .field-input {
            width: 100%;
            padding: 0.375rem 0.5rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.85rem;
        }

        .field-input:focus { outline: none; border-color: var(--primary); }

        .field-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .field-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .field-action-btn:hover { background: rgba(255,255,255,0.2); color: var(--text); }
        .field-action-btn.delete:hover { background: rgba(239, 68, 68, 0.3); color: #ef4444; }

        .add-field-btn {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .add-field-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }

        /* Footnotes Panel */
        .footnotes-section {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 1rem;
        }

        .footnote-item {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        /* Save Bar */
        .save-bar {
            padding: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 0.5rem;
        }

        .save-bar button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-bar .save-btn { background: var(--success); color: white; }
        .save-bar .save-btn:hover { background: #059669; }
        .save-bar .vault-btn { background: var(--primary); color: white; }
        .save-bar .vault-btn:hover { background: var(--primary-dark); }
        .save-bar .timeline-btn { background: #8b5cf6; color: white; }
        .save-bar .timeline-btn:hover { background: #7c3aed; }

        /* Help floating button */
        .help-float {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            color: var(--text-muted);
            transition: all 0.2s;
            z-index: 100;
            text-decoration: none;
        }

        .help-float:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: scale(1.05);
        }

        /* Timeline Event Item */
        .timeline-event-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .timeline-event-item:hover { background: rgba(255,255,255,0.08); }

        .timeline-event-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .timeline-event-item .event-date {
            font-weight: 600;
            color: var(--hl-date);
            min-width: 140px;
        }

        .timeline-event-item .event-label {
            flex: 1;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .timeline-event-item select {
            padding: 0.375rem 0.5rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.8rem;
        }

        /* Selection Tooltip */
        .selection-tooltip {
            display: none;
            position: fixed;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .selection-tooltip.active { display: flex; gap: 0.25rem; }

        .tooltip-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .tooltip-btn:hover { transform: scale(1.1); }
        .tooltip-btn.date { background: var(--hl-date); color: #1a1a1a; }
        .tooltip-btn.party { background: var(--hl-party); color: white; }
        .tooltip-btn.amount { background: var(--hl-amount); color: white; }
        .tooltip-btn.address { background: var(--hl-address); color: white; }
        .tooltip-btn.legal { background: var(--hl-legal); color: white; }
        .tooltip-btn.form { background: var(--hl-form); color: white; }
        .tooltip-btn.note { background: var(--hl-note); color: white; }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active { display: flex; }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Vault Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body { padding: 1rem; max-height: 60vh; overflow-y: auto; }

        .vault-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .vault-item:hover { background: rgba(255,255,255,0.1); }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           HIGHLIGHTER DROPDOWN MENU - All 14 Colors
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .highlighter-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 0.5rem;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .highlighter-menu-header {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.25rem 0.5rem 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 0.25rem;
        }

        .highlighter-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 0.25rem 0;
        }

        .highlighter-menu button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s;
        }

        .highlighter-menu button:hover {
            background: rgba(255,255,255,0.1);
        }

        .highlighter-menu button.active {
            background: rgba(59, 130, 246, 0.2);
        }

        .hl-dot {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="nav-pinned">
    <div id="semptify-nav"></div>

    <div class="main-content">
        <div class="page-header">
            <h1><i class="fas fa-briefcase text-amber-400"></i> Document Briefcase</h1>
            <div class="toolbar-group" style="display: flex; gap: 0.5rem;">
                <button class="toolbar-btn" onclick="toggleMobilePanel('file')"><i class="fas fa-folder"></i></button>
                <button class="toolbar-btn" onclick="toggleMobilePanel('fields')"><i class="fas fa-list"></i></button>
            </div>
        </div>

        <div class="workspace">
            <!-- Left Panel: File Sources & Options -->
            <div class="file-panel" id="filePanel">
                <div class="panel-title"><i class="fas fa-folder-open"></i> Select Document</div>
                
                <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.tiff,.bmp" onchange="handleFileSelect(event)">
                
                <button class="source-btn" id="uploadZone" onclick="document.getElementById('fileInput').click()"
                        ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <span class="icon">üìÅ</span>
                    <span class="label">Upload File</span>
                    <div class="desc">Drag & drop or click to browse</div>
                </button>

                <button class="source-btn" onclick="openVaultModal()">
                    <span class="icon">üîê</span>
                    <span class="label">From Vault</span>
                    <div class="desc">Select from saved documents</div>
                </button>

                <button class="source-btn" onclick="openCloudPicker()">
                    <span class="icon">‚òÅÔ∏è</span>
                    <span class="label">Cloud Storage</span>
                    <div class="desc">Google Drive, OneDrive</div>
                </button>

                <!-- Document Type -->
                <div class="doc-type-section">
                    <div class="panel-title"><i class="fas fa-file-alt"></i> Document Type</div>
                    <select class="doc-type-select" id="docTypeSelect" onchange="updateScanOptions()">
                        <option value="">Auto-detect</option>
                        <option value="lease">Lease Agreement</option>
                        <option value="eviction">Eviction Notice</option>
                        <option value="notice">Notice (14/30 Day)</option>
                        <option value="receipt">Rent Receipt</option>
                        <option value="repair">Repair Request</option>
                        <option value="court">Court Document</option>
                        <option value="letter">Letter/Correspondence</option>
                        <option value="photo">Photo Evidence</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Scan Options -->
                <div class="scan-options">
                    <div class="panel-title"><i class="fas fa-search"></i> Scan For</div>
                    <label class="scan-option"><input type="checkbox" id="scanDates" checked> <span>üìÖ Dates & Deadlines</span></label>
                    <label class="scan-option"><input type="checkbox" id="scanParties" checked> <span>üë§ Names & Parties</span></label>
                    <label class="scan-option"><input type="checkbox" id="scanAmounts" checked> <span>üí∞ Amounts & Fees</span></label>
                    <label class="scan-option"><input type="checkbox" id="scanAddresses" checked> <span>üìç Addresses</span></label>
                    <label class="scan-option"><input type="checkbox" id="scanLegal"> <span>‚öñÔ∏è Legal Terms</span></label>
                    <label class="scan-option"><input type="checkbox" id="scanHandwriting"> <span>‚úçÔ∏è Handwriting</span></label>
                    <label class="scan-option"><input type="checkbox" id="scanForgery"> <span>üö® Forgery Check</span></label>
                </div>

                <button class="analyze-btn" id="analyzeBtn" onclick="processDocument()" disabled>
                    <i class="fas fa-magic"></i> Process Document
                </button>
            </div>

            <!-- Center: Document Preview -->
            <div class="preview-panel">
                <div class="preview-toolbar">
                    <div class="toolbar-group" style="flex: 1; min-width: 0;">
                        <span class="text-sm text-gray-400" id="fileNameDisplay" onclick="enableFilenameEdit()" 
                              style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;" 
                              title="Click to rename">
                            No document selected
                        </span>
                        <button class="toolbar-btn" onclick="enableFilenameEdit()" title="Rename File" style="padding: 0.25rem 0.5rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="toolbar-btn" onclick="copySelectedText()" title="Copy Selected Text" style="padding: 0.25rem 0.5rem;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    
                    <div class="toolbar-group">
                        <button class="toolbar-btn highlight-btn" data-color="date" onclick="setHighlightMode('date')" title="Highlight Date (DT)">
                            <i class="fas fa-calendar"></i>
                        </button>
                        <button class="toolbar-btn highlight-btn" data-color="party" onclick="setHighlightMode('party')" title="Highlight Party (PT)">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="toolbar-btn highlight-btn" data-color="amount" onclick="setHighlightMode('amount')" title="Highlight Amount ($)">
                            <i class="fas fa-dollar-sign"></i>
                        </button>
                        <button class="toolbar-btn highlight-btn" data-color="address" onclick="setHighlightMode('address')" title="Highlight Address (AD)">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                        <button class="toolbar-btn highlight-btn" data-color="legal" onclick="setHighlightMode('legal')" title="Highlight Legal (LG)" style="color: var(--hl-legal);">
                            <i class="fas fa-gavel"></i>
                        </button>
                        <button class="toolbar-btn highlight-btn" data-color="form" onclick="setHighlightMode('form')" title="Highlight Form Field (FM)" style="color: var(--hl-form);">
                            <i class="fas fa-clipboard-list"></i>
                        </button>
                        <button class="toolbar-btn highlight-btn" data-color="note" onclick="setHighlightMode('note')" title="Add Footnote (NT)">
                            <i class="fas fa-sticky-note"></i>
                        </button>
                        <!-- Highlighter Dropdown for all 14 colors -->
                        <div class="highlighter-dropdown" style="position: relative;">
                            <button class="toolbar-btn" onclick="toggleHighlighterDropdown()" title="More Highlighters">
                                <i class="fas fa-highlighter"></i> <i class="fas fa-caret-down" style="font-size: 0.6rem;"></i>
                            </button>
                            <div id="highlighterDropdownMenu" class="highlighter-menu" style="display: none;">
                                <div class="highlighter-menu-header">All 14 Highlighters</div>
                                <button onclick="setHighlightMode('date')" data-color="date"><span class="hl-dot" style="background: var(--hl-date);"></span> üìÖ DT - Dates</button>
                                <button onclick="setHighlightMode('party')" data-color="party"><span class="hl-dot" style="background: var(--hl-party);"></span> üë§ PT - Parties</button>
                                <button onclick="setHighlightMode('amount')" data-color="amount"><span class="hl-dot" style="background: var(--hl-amount);"></span> üí∞ $ - Amounts</button>
                                <button onclick="setHighlightMode('address')" data-color="address"><span class="hl-dot" style="background: var(--hl-address);"></span> üìç AD - Addresses</button>
                                <button onclick="setHighlightMode('legal')" data-color="legal"><span class="hl-dot" style="background: var(--hl-legal);"></span> ‚öñÔ∏è LG - Legal</button>
                                <button onclick="setHighlightMode('note')" data-color="note"><span class="hl-dot" style="background: var(--hl-note);"></span> üìù NT - Notes</button>
                                <button onclick="setHighlightMode('form')" data-color="form"><span class="hl-dot" style="background: var(--hl-form);"></span> üìã FM - Form Data</button>
                                <button onclick="setHighlightMode('event')" data-color="event"><span class="hl-dot" style="background: var(--hl-event);"></span> üìÜ EV - Events</button>
                                <div class="highlighter-menu-divider"></div>
                                <button onclick="setHighlightMode('deadline')" data-color="deadline"><span class="hl-dot" style="background: var(--hl-deadline);"></span> üö® DL - Deadlines</button>
                                <button onclick="setHighlightMode('witness')" data-color="witness"><span class="hl-dot" style="background: var(--hl-witness);"></span> üëÅÔ∏è WS - Witness</button>
                                <button onclick="setHighlightMode('violation')" data-color="violation"><span class="hl-dot" style="background: var(--hl-violation);"></span> ‚ö†Ô∏è VL - Violations</button>
                                <button onclick="setHighlightMode('evidence')" data-color="evidence"><span class="hl-dot" style="background: var(--hl-evidence);"></span> üîç ED - Evidence</button>
                                <button onclick="setHighlightMode('quote')" data-color="quote"><span class="hl-dot" style="background: var(--hl-quote);"></span> üí¨ QT - Quotes</button>
                                <button onclick="setHighlightMode('timeline')" data-color="timeline"><span class="hl-dot" style="background: var(--hl-timeline);"></span> üïê TL - Timeline</button>
                            </div>
                        </div>
                    </div>

                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="toggleAnnotationsBtn" onclick="toggleAnnotations()" title="Toggle Annotations">
                            <i class="fas fa-layer-group"></i> <span id="annotationStatus">On</span>
                        </button>
                        <button class="toolbar-btn" onclick="toggleColorKeyLegend()" title="Show Color Key">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button class="toolbar-btn" onclick="clearAnnotations()" title="Clear All Annotations">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <div class="zoom-control">
                            <button class="toolbar-btn" onclick="zoomOut()" style="padding: 0.5rem;"><i class="fas fa-minus"></i></button>
                            <input type="range" id="zoomSlider" min="50" max="200" value="100" onchange="setZoom(this.value)">
                            <button class="toolbar-btn" onclick="zoomIn()" style="padding: 0.5rem;"><i class="fas fa-plus"></i></button>
                            <span class="text-xs text-gray-400" id="zoomLevel">100%</span>
                        </div>
                        <button class="toolbar-btn" onclick="rotateDoc()" title="Rotate"><i class="fas fa-redo"></i></button>
                        <button class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen"><i class="fas fa-expand"></i></button>
                    </div>
                </div>

                <div class="preview-content" id="previewContent">
                    <div class="empty-preview" id="emptyPreview">
                        <i class="fas fa-file-import"></i>
                        <p class="text-lg font-medium">Select a document to preview</p>
                        <p class="text-sm mt-2">Upload, choose from vault, or cloud storage</p>
                    </div>
                    <div class="document-display" id="documentDisplay" style="display: none;"></div>
                </div>
            </div>

            <!-- Right Panel: Extracted Fields -->
            <div class="fields-panel" id="fieldsPanel">
                <div class="fields-header">
                    <span class="font-semibold">Extracted Data</span>
                    <button class="toolbar-btn" onclick="collapseAllGroups()" title="Collapse All"><i class="fas fa-compress-alt"></i></button>
                </div>

                <div class="field-groups" id="fieldGroups">
                    <!-- Dates Group -->
                    <div class="field-group" data-type="date">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-date);"></span>
                            <span>üìÖ Dates</span>
                            <span class="count" id="dateCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="dateFields"></div>
                    </div>

                    <!-- Parties Group -->
                    <div class="field-group" data-type="party">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-party);"></span>
                            <span>üë§ Parties</span>
                            <span class="count" id="partyCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="partyFields"></div>
                    </div>

                    <!-- Amounts Group -->
                    <div class="field-group" data-type="amount">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-amount);"></span>
                            <span>üí∞ Amounts</span>
                            <span class="count" id="amountCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="amountFields"></div>
                    </div>

                    <!-- Addresses Group -->
                    <div class="field-group" data-type="address">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-address);"></span>
                            <span>üìç Addresses</span>
                            <span class="count" id="addressCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="addressFields"></div>
                    </div>

                    <!-- Footnotes Group -->
                    <div class="field-group" data-type="note">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-note);"></span>
                            <span>üìù Footnotes</span>
                            <span class="count" id="noteCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="noteFields"></div>
                    </div>

                    <!-- Legal Terms Group -->
                    <div class="field-group" data-type="legal">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-legal);"></span>
                            <span>‚öñÔ∏è Legal Terms</span>
                            <span class="count" id="legalCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="legalFields"></div>
                    </div>

                    <!-- Form Fields Group -->
                    <div class="field-group" data-type="form">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-form);"></span>
                            <span>üìã Form Data</span>
                            <span class="count" id="formCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="formFields"></div>
                    </div>

                    <!-- Events Group -->
                    <div class="field-group" data-type="event">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-event);"></span>
                            <span>üìÜ Linked Events</span>
                            <span class="count" id="eventCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="eventFields"></div>
                    </div>

                    <!-- NEW: 6 Additional Field Groups for Enhanced System -->
                    <div class="field-group" data-type="deadline">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-deadline);"></span>
                            <span>üö® Critical Deadlines</span>
                            <span class="count" id="deadlineCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="deadlineFields"></div>
                    </div>

                    <div class="field-group" data-type="witness">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-witness);"></span>
                            <span>üëÅÔ∏è Witnesses</span>
                            <span class="count" id="witnessCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="witnessFields"></div>
                    </div>

                    <div class="field-group" data-type="violation">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-violation);"></span>
                            <span>‚ö†Ô∏è Violations</span>
                            <span class="count" id="violationCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="violationFields"></div>
                    </div>

                    <div class="field-group" data-type="evidence">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-evidence);"></span>
                            <span>üîç Evidence</span>
                            <span class="count" id="evidenceCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="evidenceFields"></div>
                    </div>

                    <div class="field-group" data-type="quote">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-quote);"></span>
                            <span>üí¨ Quotes</span>
                            <span class="count" id="quoteCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="quoteFields"></div>
                    </div>

                    <div class="field-group" data-type="timeline">
                        <div class="field-group-header" onclick="toggleFieldGroup(this)">
                            <span class="color-dot" style="background: var(--hl-timeline);"></span>
                            <span>üïê Timeline Keys</span>
                            <span class="count" id="timelineCount">0</span>
                            <i class="fas fa-chevron-down ml-auto"></i>
                        </div>
                        <div class="field-group-content" id="timelineFields"></div>
                    </div>
                </div>

                <div class="save-bar">
                    <button class="save-btn" onclick="saveDocument()"><i class="fas fa-save mr-1"></i> Save</button>
                    <button class="vault-btn" onclick="saveToVault()"><i class="fas fa-lock mr-1"></i> To Vault</button>
                    <button class="timeline-btn" onclick="openTimelineModal()" title="Add to Timeline"><i class="fas fa-clock mr-1"></i> Timeline</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection Tooltip -->
    <div class="selection-tooltip" id="selectionTooltip">
        <button class="tooltip-btn date" onclick="highlightSelection('date')" title="Mark as Date (DT)"><i class="fas fa-calendar"></i></button>
        <button class="tooltip-btn party" onclick="highlightSelection('party')" title="Mark as Party (PT)"><i class="fas fa-user"></i></button>
        <button class="tooltip-btn amount" onclick="highlightSelection('amount')" title="Mark as Amount ($)"><i class="fas fa-dollar-sign"></i></button>
        <button class="tooltip-btn address" onclick="highlightSelection('address')" title="Mark as Address (AD)"><i class="fas fa-map-marker-alt"></i></button>
        <button class="tooltip-btn legal" onclick="highlightSelection('legal')" title="Mark as Legal (LG)"><i class="fas fa-gavel"></i></button>
        <button class="tooltip-btn note" onclick="highlightSelection('note')" title="Add Footnote (NT)"><i class="fas fa-sticky-note"></i></button>
    </div>

    <!-- Vault Modal -->
    <div class="modal" id="vaultModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-semibold">Select from Vault</h3>
                <button onclick="closeVaultModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="vaultList">
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                    <p>Loading documents...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div class="modal" id="timelineModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="font-semibold"><i class="fas fa-clock text-blue-400 mr-2"></i>Add to Timeline</h3>
                <button onclick="closeTimelineModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="timelineContent">
                <p class="text-gray-400 mb-4">Select dates to add as timeline events:</p>
                <div id="timelineDatesList"></div>
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex items-center gap-3 mb-3">
                        <input type="text" id="customEventDate" placeholder="Date (e.g., Dec 15, 2025)" 
                               class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-500">
                        <input type="text" id="customEventTitle" placeholder="Event title" 
                               class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-500">
                    </div>
                    <button onclick="addCustomTimelineEvent()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                        <i class="fas fa-plus mr-1"></i> Add Custom Event
                    </button>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex gap-3">
                <button onclick="sendToTimeline()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition">
                    <i class="fas fa-paper-plane mr-2"></i>Send to Timeline
                </button>
                <button onclick="openTimelineBuilder()" class="py-3 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition" title="Open Timeline Builder">
                    <i class="fas fa-external-link-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <div class="text-lg" id="loadingText">Processing document...</div>
            <div class="text-sm text-gray-400" id="loadingStep">Extracting text</div>
            <div class="mt-4 w-64 h-2 bg-gray-700 rounded-full overflow-hidden" id="progressBar" style="display:none;">
                <div class="h-full bg-blue-500 transition-all duration-300" id="progressFill" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- PDF.js for multi-page PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Tesseract.js for client-side OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="/static/js/shared-nav.js"></script>
    <script>
        // Initialize PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        let selectedFile = null;
        let currentZoom = 100;
        let currentRotation = 0;
        let highlightMode = null;
        let extractedData = { dates: [], parties: [], amounts: [], addresses: [], notes: [] };
        let fieldCounters = { date: 0, party: 0, amount: 0, address: 0, note: 0 };
        let tesseractWorker = null;
        
        // =====================================================================
        // ANNOTATION OVERLAY SYSTEM - Original Document Preserved
        // Annotations stored separately, rendered as overlay on original
        // =====================================================================
        let documentAnnotations = {
            documentId: null,
            originalHash: null,  // SHA256 of original file
            annotations: [],     // Array of annotation objects
            showAnnotations: true
        };

        function generateAnnotationId() {
            return 'ann-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Toggle annotations visibility
        function toggleAnnotations() {
            documentAnnotations.showAnnotations = !documentAnnotations.showAnnotations;
            const btn = document.getElementById('toggleAnnotationsBtn');
            const status = document.getElementById('annotationStatus');
            
            if (documentAnnotations.showAnnotations) {
                status.textContent = 'On';
                btn.classList.remove('opacity-50');
                document.querySelectorAll('.annotation-layer').forEach(l => l.style.display = 'block');
            } else {
                status.textContent = 'Off';
                btn.classList.add('opacity-50');
                document.querySelectorAll('.annotation-layer').forEach(l => l.style.display = 'none');
            }
            showToast(documentAnnotations.showAnnotations ? 'üîç Annotations visible' : 'üìÑ Original document view', 'success');
        }

        // Clear all annotations (with confirmation)
        function clearAnnotations() {
            if (documentAnnotations.annotations.length === 0) {
                showToast('No annotations to clear', 'error');
                return;
            }
            
            if (confirm(`Clear all ${documentAnnotations.annotations.length} annotations? Original document is preserved.`)) {
                documentAnnotations.annotations = [];
                document.querySelectorAll('.annotation-highlight').forEach(el => el.remove());
                
                // Clear field displays
                ['date', 'party', 'amount', 'address', 'note'].forEach(type => {
                    document.getElementById(`${type}Fields`).innerHTML = '';
                    document.getElementById(`${type}Count`).textContent = '0';
                    fieldCounters[type] = 0;
                });
                
                extractedData = { dates: [], parties: [], amounts: [], addresses: [], notes: [] };
                saveAnnotationsToStorage();
                showToast('‚úÖ All annotations cleared. Original document preserved.', 'success');
            }
        }

        // Add annotation overlay to a PDF page or image
        function addAnnotationLayer(container, pageNum = 1) {
            const layer = document.createElement('div');
            layer.className = 'annotation-layer editable';
            layer.id = `annotationLayer-${pageNum}`;
            layer.dataset.page = pageNum;
            
            // Original document badge
            const badge = document.createElement('div');
            badge.className = 'original-badge';
            badge.innerHTML = '<i class="fas fa-shield-alt"></i> Original Preserved';
            layer.appendChild(badge);
            
            // Document ID badge (shows unique identifier for matching overlays)
            const docId = processingResults.documentId || documentAnnotations.documentId || selectedFile?.id || selectedFile?.name || 'pending';
            const idBadge = document.createElement('div');
            idBadge.className = 'doc-id-badge';
            idBadge.innerHTML = `<i class="fas fa-fingerprint"></i> ${docId.substring(0, 12)}...`;
            idBadge.title = `Document ID: ${docId}`;
            layer.appendChild(idBadge);
            
            container.style.position = 'relative';
            container.appendChild(layer);
            
            // Setup click handler for adding annotations
            layer.addEventListener('click', (e) => {
                if (highlightMode && e.target === layer) {
                    showAnnotationPrompt(e, layer, pageNum);
                }
            });
            
            return layer;
        }

        // Show prompt to add annotation at click position
        function showAnnotationPrompt(e, layer, pageNum) {
            const rect = layer.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
            const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);
            
            const value = prompt(`Enter ${highlightMode} value to annotate:`);
            if (value && value.trim()) {
                addAnnotation({
                    type: highlightMode,
                    value: value.trim(),
                    page: pageNum,
                    x: parseFloat(x),
                    y: parseFloat(y),
                    width: 15,  // Default percentage width
                    height: 3   // Default percentage height
                });
            }
        }

        // Add an annotation to the overlay
        function addAnnotation(annotationData) {
            const annotation = {
                id: generateAnnotationId(),
                type: annotationData.type,
                value: annotationData.value,
                page: annotationData.page || 1,
                x: annotationData.x,
                y: annotationData.y,
                width: annotationData.width || 15,
                height: annotationData.height || 3,
                note: annotationData.note || '',
                createdAt: new Date().toISOString()
            };
            
            documentAnnotations.annotations.push(annotation);
            renderAnnotation(annotation);
            
            // Add to extracted data and field display
            fieldCounters[annotation.type]++;
            addFieldItem(annotation.type, annotation.value, fieldCounters[annotation.type]);
            
            saveAnnotationsToStorage();
            showToast(`‚úÖ ${annotation.type} annotation added`, 'success');
        }

        // Render a single annotation on the overlay
        function renderAnnotation(annotation) {
            const layer = document.getElementById(`annotationLayer-${annotation.page}`);
            if (!layer) return;
            
            const highlight = document.createElement('div');
            highlight.className = `annotation-highlight ${annotation.type}`;
            highlight.id = annotation.id;
            highlight.style.left = annotation.x + '%';
            highlight.style.top = annotation.y + '%';
            highlight.style.width = annotation.width + '%';
            highlight.style.height = annotation.height + '%';
            highlight.title = `${annotation.type}: ${annotation.value}`;
            
            // Marker number
            const num = documentAnnotations.annotations.filter(a => a.type === annotation.type).length;
            const marker = document.createElement('span');
            marker.className = `annotation-marker ${annotation.type}`;
            marker.textContent = num;
            highlight.appendChild(marker);
            
            // Click to edit
            highlight.addEventListener('click', (e) => {
                e.stopPropagation();
                editAnnotation(annotation.id);
            });
            
            // Right-click to delete
            highlight.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (confirm(`Delete this ${annotation.type} annotation?`)) {
                    deleteAnnotation(annotation.id);
                }
            });
            
            layer.appendChild(highlight);
        }

        // Edit annotation
        function editAnnotation(annotationId) {
            const annotation = documentAnnotations.annotations.find(a => a.id === annotationId);
            if (!annotation) return;
            
            const newValue = prompt(`Edit ${annotation.type} value:`, annotation.value);
            if (newValue !== null) {
                annotation.value = newValue.trim();
                const highlight = document.getElementById(annotationId);
                if (highlight) highlight.title = `${annotation.type}: ${annotation.value}`;
                saveAnnotationsToStorage();
                showToast('Annotation updated', 'success');
            }
        }

        // Delete annotation
        function deleteAnnotation(annotationId) {
            const idx = documentAnnotations.annotations.findIndex(a => a.id === annotationId);
            if (idx === -1) return;
            
            const annotation = documentAnnotations.annotations[idx];
            documentAnnotations.annotations.splice(idx, 1);
            
            // Remove from DOM
            const highlight = document.getElementById(annotationId);
            if (highlight) highlight.remove();
            
            saveAnnotationsToStorage();
            showToast('Annotation deleted', 'success');
        }

        // Save annotations to localStorage (and eventually to server)
        function saveAnnotationsToStorage() {
            if (!selectedFile) return;
            
            const key = `annotations-${selectedFile.id || selectedFile.name}`;
            localStorage.setItem(key, JSON.stringify(documentAnnotations));
        }

        // Load annotations from storage
        function loadAnnotationsFromStorage() {
            if (!selectedFile) return;
            
            const key = `annotations-${selectedFile.id || selectedFile.name}`;
            const stored = localStorage.getItem(key);
            
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    documentAnnotations = data;
                    
                    // Re-render all annotations
                    documentAnnotations.annotations.forEach(a => renderAnnotation(a));
                    
                    // Update field displays
                    ['date', 'party', 'amount', 'address', 'note'].forEach(type => {
                        const items = documentAnnotations.annotations.filter(a => a.type === type);
                        items.forEach((item, i) => {
                            fieldCounters[type] = i + 1;
                            addFieldItem(type, item.value, i + 1);
                        });
                    });
                    
                    showToast(`üìé Loaded ${documentAnnotations.annotations.length} annotations`, 'success');
                } catch (e) {
                    console.warn('Failed to load annotations:', e);
                }
            }
        }

        // Initialize Tesseract worker for client-side OCR
        async function initTesseract() {
            if (tesseractWorker) return tesseractWorker;
            try {
                tesseractWorker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const pct = Math.round(m.progress * 100);
                            document.getElementById('progressFill').style.width = pct + '%';
                            document.getElementById('loadingStep').textContent = `OCR Progress: ${pct}%`;
                        }
                    }
                });
                return tesseractWorker;
            } catch (e) {
                console.warn('Tesseract init failed:', e);
                return null;
            }
        }

        // File Handling
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadZone').classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) selectFile(e.dataTransfer.files[0]);
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) selectFile(e.target.files[0]);
        }

        function selectFile(file) {
            selectedFile = file;
            document.getElementById('fileNameDisplay').textContent = file.name;
            document.getElementById('analyzeBtn').disabled = false;
            loadPreview(file);
        }

        function loadPreview(file) {
            const display = document.getElementById('documentDisplay');
            const empty = document.getElementById('emptyPreview');
            const type = file.type || '';
            const name = file.name.toLowerCase();

            empty.style.display = 'none';
            display.style.display = 'block';

            if (type.startsWith('image/') || /\.(jpg|jpeg|png|gif|bmp|tiff|webp)$/i.test(name)) {
                // Reset annotations for new document
                documentAnnotations = {
                    documentId: selectedFile?.id || selectedFile?.name,
                    originalHash: null,
                    annotations: [],
                    showAnnotations: true
                };
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Wrap image in container for annotation layer
                    const wrapper = document.createElement('div');
                    wrapper.className = 'pdf-page';
                    wrapper.id = 'imagePage1';
                    wrapper.style.display = 'inline-block';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Document';
                    img.style.display = 'block';
                    img.style.maxWidth = '100%';
                    
                    wrapper.appendChild(img);
                    display.innerHTML = '';
                    display.appendChild(wrapper);
                    
                    // Add annotation layer after image loads
                    img.onload = () => {
                        addAnnotationLayer(wrapper, 1);
                        loadAnnotationsFromStorage();
                    };
                };
                reader.readAsDataURL(file);
            } else if (type === 'application/pdf' || name.endsWith('.pdf')) {
                // Use PDF.js for multi-page rendering
                renderPDFFromFile(file, display);
            } else if (type.startsWith('text/') || /\.(txt|md)$/i.test(name)) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    display.innerHTML = `<div class="document-text" id="docText">${escapeHtml(e.target.result)}</div>`;
                    setupTextSelection();
                };
                reader.readAsText(file);
            } else {
                display.innerHTML = `
                    <div class="document-text" style="text-align: center; padding: 4rem;">
                        <i class="fas fa-file text-6xl text-gray-400 mb-4"></i>
                        <p class="text-xl">${file.name}</p>
                        <p class="text-gray-500 mt-2">Processing this file type...</p>
                    </div>
                `;
            }
        }

        // PDF.js multi-page renderer
        async function renderPDFFromFile(file, display) {
            display.innerHTML = `
                <div class="pdf-loading">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-400"></i>
                    <p>Loading PDF...</p>
                </div>
            `;

            try {
                const arrayBuffer = await file.arrayBuffer();
                await renderPDFFromData(arrayBuffer, display);
            } catch (err) {
                console.error('PDF load error:', err);
                // Fallback to iframe
                display.innerHTML = `
                    <div class="pdf-error">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>PDF rendering failed. Trying fallback viewer...</p>
                    </div>
                `;
                setTimeout(() => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        display.innerHTML = `<iframe src="${e.target.result}" style="width: 100%; height: 700px; border: none;"></iframe>`;
                    };
                    reader.readAsDataURL(file);
                }, 1000);
            }
        }

        async function renderPDFFromData(data, display) {
            if (typeof pdfjsLib === 'undefined') {
                throw new Error('PDF.js not loaded');
            }

            const pdf = await pdfjsLib.getDocument({ data }).promise;
            const totalPages = pdf.numPages;
            
            // Reset annotations for new document
            documentAnnotations = {
                documentId: selectedFile?.id || selectedFile?.name,
                originalHash: null,
                annotations: [],
                showAnnotations: true
            };
            
            display.innerHTML = `<div class="pdf-container" id="pdfContainer"></div>`;
            const container = document.getElementById('pdfContainer');

            // Render all pages with text layers and annotation layers
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                
                // Scale for good quality
                const scale = 1.5;
                const viewport = page.getViewport({ scale });
                
                // Create page wrapper
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'pdf-page';
                pageWrapper.id = `pdfPage${pageNum}`;
                pageWrapper.style.width = viewport.width + 'px';
                pageWrapper.style.height = viewport.height + 'px';
                
                // Create canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                // Render page to canvas
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                pageWrapper.appendChild(canvas);
                
                // ADD TEXT LAYER for text selection/copy
                await addTextLayer(page, pageWrapper, viewport, pageNum);
                
                // ADD ANNOTATION LAYER on top of text layer
                addAnnotationLayer(pageWrapper, pageNum);
                
                // Page number indicator
                const pageLabel = document.createElement('div');
                pageLabel.className = 'pdf-page-number';
                pageLabel.textContent = `Page ${pageNum} of ${totalPages}`;
                pageWrapper.appendChild(pageLabel);
                
                container.appendChild(pageWrapper);
            }
            
            // Setup text selection handlers for PDF
            setupPDFTextSelection();
            
            // Load any saved annotations for this document
            loadAnnotationsFromStorage();
            
            showToast(`üìÑ Loaded ${totalPages} page${totalPages > 1 ? 's' : ''} - Text selectable`, 'success');
        }

        // Add text layer for text selection
        async function addTextLayer(page, container, viewport, pageNum) {
            const textContent = await page.getTextContent();
            
            const textLayer = document.createElement('div');
            textLayer.className = 'pdf-text-layer';
            textLayer.id = `textLayer-${pageNum}`;
            textLayer.style.width = viewport.width + 'px';
            textLayer.style.height = viewport.height + 'px';
            
            // Render text items
            textContent.items.forEach(item => {
                const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                
                const span = document.createElement('span');
                span.textContent = item.str;
                span.style.left = tx[4] + 'px';
                span.style.top = (viewport.height - tx[5]) + 'px';
                span.style.fontSize = Math.abs(tx[0]) + 'px';
                span.style.fontFamily = item.fontName || 'sans-serif';
                
                // Handle rotation if needed
                if (tx[1] !== 0 || tx[2] !== 0) {
                    const angle = Math.atan2(tx[1], tx[0]);
                    span.style.transform = `rotate(${angle}rad)`;
                }
                
                // Store text item data for highlighting
                span.dataset.text = item.str;
                span.dataset.page = pageNum;
                
                textLayer.appendChild(span);
            });
            
            container.appendChild(textLayer);
            return textLayer;
        }

        // Setup text selection handlers for PDF pages
        function setupPDFTextSelection() {
            document.querySelectorAll('.pdf-text-layer').forEach(layer => {
                layer.addEventListener('mousedown', () => {
                    layer.classList.add('selecting');
                });
                
                layer.addEventListener('mouseup', (e) => {
                    layer.classList.remove('selecting');
                    
                    const selection = window.getSelection();
                    const text = selection.toString().trim();
                    
                    if (text.length > 0) {
                        if (highlightMode) {
                            // Apply highlight to selected PDF text
                            applyPDFHighlight(selection, highlightMode, text);
                        } else {
                            // Show tooltip for marking
                            showSelectionTooltip(e, selection, text);
                        }
                    }
                });
                
                // Enable copy
                layer.addEventListener('copy', (e) => {
                    const selection = window.getSelection();
                    const text = selection.toString();
                    if (text) {
                        e.clipboardData.setData('text/plain', text);
                        showToast('üìã Text copied to clipboard', 'success');
                    }
                });
            });
        }

        // Apply highlight to PDF text selection
        function applyPDFHighlight(selection, type, text) {
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            
            // Wrap selected text in highlight span
            const highlightSpan = document.createElement('span');
            highlightSpan.className = `hl-${type}`;
            
            try {
                range.surroundContents(highlightSpan);
            } catch (e) {
                // If selection spans multiple elements, handle differently
                console.warn('Complex selection, using annotation instead');
            }
            
            // Add to extracted data
            fieldCounters[type]++;
            const num = fieldCounters[type];
            
            // Add extraction with detection method
            if (typeof addExtraction === 'function') {
                addExtraction({
                    category: type,
                    value: text,
                    detectionMethod: 'MANUAL',
                    detectionContext: 'Selected from PDF text',
                    page: parseInt(highlightSpan.closest('.pdf-text-layer')?.id?.split('-')[1]) || 1
                });
            } else {
                addFieldItem(type, text, num);
            }
            
            selection.removeAllRanges();
            showToast(`‚úÖ Marked as ${type}`, 'success');
        }

        async function renderPDFFromURL(url, display) {
            display.innerHTML = `
                <div class="pdf-loading">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-400"></i>
                    <p>Loading PDF...</p>
                </div>
            `;

            try {
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js not loaded');
                }

                // Reset annotations for new document
                documentAnnotations = {
                    documentId: selectedFile?.id || selectedFile?.name,
                    originalHash: null,
                    annotations: [],
                    showAnnotations: true
                };

                const pdf = await pdfjsLib.getDocument(url).promise;
                const totalPages = pdf.numPages;
                
                display.innerHTML = `<div class="pdf-container" id="pdfContainer"></div>`;
                const container = document.getElementById('pdfContainer');

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale });
                    
                    const pageWrapper = document.createElement('div');
                    pageWrapper.className = 'pdf-page';
                    pageWrapper.id = `pdfPage${pageNum}`;
                    pageWrapper.style.width = viewport.width + 'px';
                    pageWrapper.style.height = viewport.height + 'px';
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    pageWrapper.appendChild(canvas);
                    
                    // ADD TEXT LAYER for text selection/copy
                    await addTextLayer(page, pageWrapper, viewport, pageNum);
                    
                    // ADD ANNOTATION LAYER
                    addAnnotationLayer(pageWrapper, pageNum);
                    
                    const pageLabel = document.createElement('div');
                    pageLabel.className = 'pdf-page-number';
                    pageLabel.textContent = `Page ${pageNum} of ${totalPages}`;
                    pageWrapper.appendChild(pageLabel);
                    
                    container.appendChild(pageWrapper);
                }
                
                // Setup text selection handlers for PDF
                setupPDFTextSelection();
                
                // Load any saved annotations
                loadAnnotationsFromStorage();
                
                showToast(`üìÑ Loaded ${totalPages} page${totalPages > 1 ? 's' : ''} - Text selectable`, 'success');
            } catch (err) {
                console.error('PDF render error:', err);
                // Fallback to iframe
                display.innerHTML = `<iframe src="${url}" style="width: 100%; height: 700px; border: none;"></iframe>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Zoom & Rotate
        function zoomIn() { currentZoom = Math.min(200, currentZoom + 25); applyZoom(); }
        function zoomOut() { currentZoom = Math.max(50, currentZoom - 25); applyZoom(); }
        function setZoom(v) { currentZoom = parseInt(v); applyZoom(); }
        function applyZoom() {
            document.getElementById('zoomSlider').value = currentZoom;
            document.getElementById('zoomLevel').textContent = currentZoom + '%';
            const docDisplay = document.getElementById('documentDisplay');
            docDisplay.style.transform = `scale(${currentZoom/100}) rotate(${currentRotation}deg)`;
            docDisplay.style.transformOrigin = 'top center';
            // Also adjust container if PDF pages
            const pdfContainer = document.getElementById('pdfContainer');
            if (pdfContainer) {
                pdfContainer.style.transform = `scale(${currentZoom/100})`;
                pdfContainer.style.transformOrigin = 'top center';
            }
        }
        function rotateDoc() {
            currentRotation = (currentRotation + 90) % 360;
            applyZoom();
        }
        function toggleFullscreen() {
            const el = document.getElementById('previewContent');
            if (!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }

        // Highlight Mode
        function setHighlightMode(type) {
            const btns = document.querySelectorAll('.highlight-btn');
            btns.forEach(b => b.classList.remove('active'));
            const menuBtns = document.querySelectorAll('.highlighter-menu button');
            menuBtns.forEach(b => b.classList.remove('active'));
            
            if (highlightMode === type) {
                highlightMode = null;
            } else {
                highlightMode = type;
                const toolbarBtn = document.querySelector(`.highlight-btn[data-color="${type}"]`);
                if (toolbarBtn) toolbarBtn.classList.add('active');
                const menuBtn = document.querySelector(`.highlighter-menu button[data-color="${type}"]`);
                if (menuBtn) menuBtn.classList.add('active');
            }
            // Close dropdown after selection
            const dropdown = document.getElementById('highlighterDropdownMenu');
            if (dropdown) dropdown.style.display = 'none';
        }

        // Toggle highlighter dropdown menu
        function toggleHighlighterDropdown() {
            const dropdown = document.getElementById('highlighterDropdownMenu');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.highlighter-dropdown')) {
                const dropdown = document.getElementById('highlighterDropdownMenu');
                if (dropdown) dropdown.style.display = 'none';
            }
        });

        // Copy selected text to clipboard
        function copySelectedText() {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            
            if (text.length > 0) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('üìã Copied to clipboard!', 'success');
                }).catch(err => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('üìã Copied to clipboard!', 'success');
                });
            } else {
                showToast('No text selected. Select text first, then click copy.', 'error');
            }
        }

        // Text Selection & Highlighting
        function setupTextSelection() {
            const docText = document.getElementById('docText');
            if (!docText) return;

            docText.addEventListener('mouseup', (e) => {
                const selection = window.getSelection();
                const text = selection.toString().trim();
                
                if (text.length > 0) {
                    if (highlightMode) {
                        applyHighlight(selection, highlightMode, text);
                    } else {
                        showSelectionTooltip(e, selection, text);
                    }
                } else {
                    hideSelectionTooltip();
                }
            });
        }

        function showSelectionTooltip(e, selection, text) {
            const tooltip = document.getElementById('selectionTooltip');
            tooltip.classList.add('active');
            tooltip.style.left = e.pageX + 'px';
            tooltip.style.top = (e.pageY - 50) + 'px';
            tooltip.dataset.text = text;
        }

        function hideSelectionTooltip() {
            document.getElementById('selectionTooltip').classList.remove('active');
        }

        function highlightSelection(type) {
            const tooltip = document.getElementById('selectionTooltip');
            const text = tooltip.dataset.text;
            const selection = window.getSelection();
            
            if (text && selection.rangeCount > 0) {
                applyHighlight(selection, type, text);
            }
            hideSelectionTooltip();
        }

        function applyHighlight(selection, type, text) {
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.className = `hl-${type}`;
            
            fieldCounters[type]++;
            const num = fieldCounters[type];
            
            const marker = document.createElement('span');
            marker.className = `footnote-marker ${type}`;
            marker.textContent = num;
            marker.onclick = () => scrollToField(type, num);
            
            range.surroundContents(span);
            span.appendChild(marker);
            
            addFieldItem(type, text, num);
            selection.removeAllRanges();
        }

        function addFieldItem(type, value, num) {
            const labels = {
                date: 'Date',
                party: 'Party/Name',
                amount: 'Amount',
                address: 'Address',
                note: 'Note'
            };

            const container = document.getElementById(`${type}Fields`);
            const id = `${type}-${num}`;
            
            const html = `
                <div class="field-item ${type}" id="${id}">
                    <span class="field-number ${type}">${num}</span>
                    <div class="field-content">
                        <div class="field-label">${labels[type]} #${num}</div>
                        <input type="text" class="field-input" value="${escapeHtml(value)}" 
                               onchange="updateFieldValue('${type}', ${num}, this.value)">
                    </div>
                    <div class="field-actions">
                        <button class="field-action-btn" onclick="scrollToHighlight('${type}', ${num})" title="Show in document">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="field-action-btn delete" onclick="deleteField('${type}', ${num})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            
            // Update count
            document.getElementById(`${type}Count`).textContent = fieldCounters[type];
            
            // Store data
            extractedData[type + 's'].push({ num, value, id });
        }

        function updateFieldValue(type, num, value) {
            const item = extractedData[type + 's'].find(i => i.num === num);
            if (item) item.value = value;
        }

        function deleteField(type, num) {
            const el = document.getElementById(`${type}-${num}`);
            if (el) el.remove();
            
            extractedData[type + 's'] = extractedData[type + 's'].filter(i => i.num !== num);
            
            // Remove highlight from document
            const markers = document.querySelectorAll(`.footnote-marker.${type}`);
            markers.forEach(m => {
                if (m.textContent == num) {
                    const parent = m.parentElement;
                    if (parent && parent.classList.contains(`hl-${type}`)) {
                        parent.replaceWith(...parent.childNodes);
                    }
                }
            });
            
            // Update count
            const count = document.querySelectorAll(`#${type}Fields .field-item`).length;
            document.getElementById(`${type}Count`).textContent = count;
        }

        function scrollToField(type, num) {
            const el = document.getElementById(`${type}-${num}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function scrollToHighlight(type, num) {
            const markers = document.querySelectorAll(`.footnote-marker.${type}`);
            markers.forEach(m => {
                if (m.textContent == num) {
                    m.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    m.parentElement.style.animation = 'pulse 0.5s ease 3';
                }
            });
        }

        function toggleFieldGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            } else {
                content.style.display = 'none';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            }
        }

        function collapseAllGroups() {
            document.querySelectorAll('.field-group-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.field-group-header i').forEach(i => i.classList.replace('fa-chevron-down', 'fa-chevron-up'));
        }

        // Document Processing - World-Class OCR Engine
        async function processDocument() {
            if (!selectedFile) return;

            const loading = document.getElementById('loadingOverlay');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            loading.classList.add('active');

            try {
                let text = '';
                const isImage = selectedFile.type?.startsWith('image/') || 
                               /\.(jpg|jpeg|png|gif|bmp|tiff|webp)$/i.test(selectedFile.name);
                const isPDF = selectedFile.type === 'application/pdf' || 
                             selectedFile.name?.toLowerCase().endsWith('.pdf');
                
                // Step 1: Get text content
                document.getElementById('loadingText').textContent = 'Reading document...';
                document.getElementById('loadingStep').textContent = 'Preparing file';
                
                if (selectedFile.fromVault) {
                    // Fetch from vault
                    const textResponse = await fetch(`/api/documents/${selectedFile.id}/text`, { credentials: 'include' });
                    if (textResponse.ok) {
                        const data = await textResponse.json();
                        text = data.text || data.content || '';
                    }
                } else if (isImage || isPDF) {
                    // Use OCR for images and PDFs
                    text = await performOCR(selectedFile);
                } else {
                    // Read as text
                    text = await readFileAsText(selectedFile);
                }
                
                // Step 2: If we got text, analyze it
                if (text && text.length >= 10) {
                    document.getElementById('loadingText').textContent = 'Analyzing document...';
                    document.getElementById('loadingStep').textContent = 'AI Recognition';
                    progressBar.style.display = 'none';
                    
                    // Display text in preview if not already showing
                    const docText = document.getElementById('docText');
                    if (!docText || !docText.textContent) {
                        const display = document.getElementById('documentDisplay');
                        display.innerHTML = `<div class="document-text" id="docText">${escapeHtml(text)}</div>`;
                        setupTextSelection();
                    }
                    
                    // Try server-side recognition first
                    try {
                        const response = await fetch('/api/recognition/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: text,
                                filename: selectedFile.name,
                                include_handwriting: false
                            }),
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            displayExtractedData(transformRecognitionResult(result));
                            const entityCount = result.entities?.length || 0;
                            showToast(`‚ú® Found ${entityCount} items with ${Math.round(result.confidence_score * 100)}% confidence`, 'success');
                            return;
                        }
                    } catch (apiErr) {
                        console.warn('Recognition API unavailable:', apiErr);
                    }
                    
                    // Fallback to local extraction
                    const mockData = generateMockExtraction(text);
                    displayExtractedData(mockData);
                    showToast('Document analyzed (local mode)', 'success');
                } else {
                    showToast('Could not extract text. Try a clearer image or add highlights manually.', 'error');
                }
                
            } catch (err) {
                console.error('Processing error:', err);
                showToast('Processing failed. Please try again.', 'error');
            } finally {
                loading.classList.remove('active');
                progressBar.style.display = 'none';
            }
        }

        // World-Class OCR - Multi-engine approach
        async function performOCR(file) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            
            document.getElementById('loadingText').textContent = 'üî• OCR Processing...';
            document.getElementById('loadingStep').textContent = 'Initializing OCR engine';
            
            try {
                // Try server-side OCR first (Azure AI / advanced processing)
                const formData = new FormData();
                formData.append('file', file);
                formData.append('quality', 'best');
                formData.append('layout_hint', 'legal');
                
                document.getElementById('loadingStep').textContent = 'Uploading to AI engine...';
                progressFill.style.width = '20%';
                
                const response = await fetch('/api/ocr/analyze', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    progressFill.style.width = '100%';
                    
                    if (result.text && result.text.length > 10) {
                        document.getElementById('loadingStep').textContent = `Done! Confidence: ${Math.round(result.confidence * 100)}%`;
                        showToast(`üî• OCR Complete: ${result.engine} (${Math.round(result.confidence * 100)}% confidence)`, 'success');
                        return result.text;
                    }
                }
            } catch (serverErr) {
                console.warn('Server OCR unavailable, using client-side:', serverErr);
            }
            
            // Fallback to client-side Tesseract.js
            document.getElementById('loadingStep').textContent = 'Loading client-side OCR...';
            progressFill.style.width = '30%';
            
            try {
                // Initialize Tesseract if needed
                await initTesseract();
                
                if (!tesseractWorker) {
                    throw new Error('Tesseract not available');
                }
                
                document.getElementById('loadingStep').textContent = 'Processing image...';
                
                // Read file as data URL
                const dataUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                // Perform OCR
                const result = await tesseractWorker.recognize(dataUrl);
                progressFill.style.width = '100%';
                
                if (result.data.text && result.data.text.length > 10) {
                    const confidence = Math.round(result.data.confidence);
                    document.getElementById('loadingStep').textContent = `Done! Confidence: ${confidence}%`;
                    showToast(`üìù Client OCR Complete: Tesseract.js (${confidence}% confidence)`, 'success');
                    return result.data.text;
                }
                
            } catch (clientErr) {
                console.error('Client OCR failed:', clientErr);
            }
            
            return '';
        }

        async function readFileAsText(file) {
            return new Promise((resolve) => {
                if (file.type?.startsWith('text/') || /\.(txt|md)$/i.test(file.name)) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsText(file);
                } else {
                    resolve('');
                }
            });
        }

        function transformRecognitionResult(result) {
            // Transform API response to briefcase format
            const data = {
                documentType: result.document_type || 'other',
                dates: [],
                parties: [],
                amounts: [],
                addresses: []
            };
            
            // Map entities to appropriate categories
            (result.entities || []).forEach(entity => {
                const item = {
                    value: entity.value,
                    label: entity.type,
                    confidence: entity.confidence
                };
                
                switch(entity.type?.toLowerCase()) {
                    case 'date':
                    case 'deadline':
                    case 'notice_date':
                    case 'expiration':
                        data.dates.push(item);
                        break;
                    case 'person':
                    case 'organization':
                    case 'landlord':
                    case 'tenant':
                    case 'attorney':
                    case 'party':
                        data.parties.push(item);
                        break;
                    case 'money':
                    case 'amount':
                    case 'rent':
                    case 'fee':
                    case 'deposit':
                        data.amounts.push(item);
                        break;
                    case 'address':
                    case 'location':
                    case 'property':
                        data.addresses.push(item);
                        break;
                }
            });
            
            // Also extract from tone analysis if available
            if (result.tone) {
                if (result.tone.sender?.name) {
                    data.parties.push({ 
                        value: result.tone.sender.name, 
                        label: result.tone.sender.role || 'Sender' 
                    });
                }
                if (result.tone.recipient?.name) {
                    data.parties.push({ 
                        value: result.tone.recipient.name, 
                        label: result.tone.recipient.role || 'Recipient' 
                    });
                }
                if (result.tone.days_to_respond) {
                    data.dates.push({
                        value: `${result.tone.days_to_respond} days to respond`,
                        label: 'Deadline'
                    });
                }
            }
            
            return data;
        }

        function generateMockExtraction(text) {
            // Smart mock extraction based on text content
            const data = {
                documentType: 'other',
                dates: [],
                parties: [],
                amounts: [],
                addresses: []
            };
            
            // Try to detect document type from content
            const textLower = (text || '').toLowerCase();
            if (textLower.includes('eviction') || textLower.includes('vacate')) {
                data.documentType = 'eviction';
            } else if (textLower.includes('lease') || textLower.includes('rental agreement')) {
                data.documentType = 'lease';
            } else if (textLower.includes('notice')) {
                data.documentType = 'notice';
            }
            
            // Extract dates (basic patterns)
            const datePatterns = text.match(/\b(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}\b/gi) || [];
            const isoDatePatterns = text.match(/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g) || [];
            [...datePatterns, ...isoDatePatterns].slice(0, 4).forEach((d, i) => {
                data.dates.push({ value: d, label: i === 0 ? 'Date Found' : `Date ${i+1}` });
            });
            
            // Extract money amounts
            const amounts = text.match(/\$[\d,]+(?:\.\d{2})?/g) || [];
            amounts.slice(0, 4).forEach((a, i) => {
                data.amounts.push({ value: a, label: i === 0 ? 'Amount' : `Amount ${i+1}` });
            });
            
            // If no real extraction, provide demo data
            if (data.dates.length === 0) {
                data.dates.push({ value: 'December 15, 2025', label: 'Demo Date' });
            }
            if (data.parties.length === 0) {
                data.parties.push({ value: 'Property Management', label: 'Demo Party' });
            }
            if (data.amounts.length === 0) {
                data.amounts.push({ value: '$1,200.00', label: 'Demo Amount' });
            }
            
            return data;
        }

        function displayExtractedData(data) {
            // Update document type
            if (data.documentType) {
                document.getElementById('docTypeSelect').value = data.documentType;
            }

            // Add each extracted item
            data.dates?.forEach(d => { fieldCounters.date++; addFieldItem('date', d.value, fieldCounters.date); });
            data.parties?.forEach(p => { fieldCounters.party++; addFieldItem('party', p.value, fieldCounters.party); });
            data.amounts?.forEach(a => { fieldCounters.amount++; addFieldItem('amount', a.value, fieldCounters.amount); });
            data.addresses?.forEach(a => { fieldCounters.address++; addFieldItem('address', a.value, fieldCounters.address); });
        }

        // Vault
        function openVaultModal() {
            document.getElementById('vaultModal').classList.add('active');
            loadVaultDocuments();
        }

        function closeVaultModal() {
            document.getElementById('vaultModal').classList.remove('active');
        }

        async function loadVaultDocuments() {
            const vaultList = document.getElementById('vaultList');
            vaultList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl mb-3"></i><p>Loading documents...</p></div>';
            
            try {
                // Try the documents API first
                let docs = [];
                const response = await fetch('/api/documents/', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    docs = Array.isArray(data) ? data : (data.documents || []);
                }
                
                // If no docs from API, check localStorage
                if (docs.length === 0) {
                    const localDocs = JSON.parse(localStorage.getItem('semptify_documents') || '[]');
                    docs = localDocs;
                }
                
                renderVaultList(docs);
            } catch (err) {
                console.error('Vault load error:', err);
                // Try localStorage fallback
                try {
                    const localDocs = JSON.parse(localStorage.getItem('semptify_documents') || '[]');
                    if (localDocs.length > 0) {
                        renderVaultList(localDocs);
                    } else {
                        vaultList.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-folder-open text-4xl mb-3"></i><p>No documents in vault</p><p class="text-sm mt-2">Upload a document to get started</p></div>';
                    }
                } catch {
                    vaultList.innerHTML = '<div class="text-center text-red-400 py-8"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>Error loading vault</p></div>';
                }
            }
        }

        function renderVaultList(docs) {
            const vaultList = document.getElementById('vaultList');
            if (!docs || docs.length === 0) {
                vaultList.innerHTML = '<div class="text-center py-8 text-gray-400"><i class="fas fa-folder-open text-4xl mb-3"></i><p>No documents in vault</p><p class="text-sm mt-2">Upload a document to get started</p></div>';
                return;
            }
            
            const typeIcons = {
                lease: 'fa-file-contract',
                eviction: 'fa-exclamation-triangle',
                notice: 'fa-bell',
                receipt: 'fa-receipt',
                court: 'fa-gavel',
                letter: 'fa-envelope',
                photo: 'fa-image',
                other: 'fa-file-alt'
            };
            
            vaultList.innerHTML = docs.map(d => {
                const filename = d.original_filename || d.filename || d.name || 'Document';
                const docType = d.document_type || d.doc_type || 'other';
                const icon = typeIcons[docType] || 'fa-file-alt';
                const date = d.uploaded_at ? new Date(d.uploaded_at).toLocaleDateString() : '';
                
                return `
                    <div class="vault-item" onclick="selectVaultDoc('${d.id}', '${escapeHtml(filename)}', '${docType}')">
                        <i class="fas ${icon} text-blue-400 text-2xl"></i>
                        <div class="flex-1">
                            <div class="font-medium">${escapeHtml(filename)}</div>
                            <div class="text-xs text-gray-400">${docType} ${date ? '‚Ä¢ ' + date : ''}</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </div>
                `;
            }).join('');
        }

        function selectVaultDoc(id, filename, docType) {
            selectedFile = { id, name: filename, fromVault: true };
            document.getElementById('fileNameDisplay').textContent = filename;
            document.getElementById('analyzeBtn').disabled = false;
            if (docType) document.getElementById('docTypeSelect').value = docType;
            closeVaultModal();
            loadVaultPreview(id);
        }

        async function loadVaultPreview(id) {
            const display = document.getElementById('documentDisplay');
            const empty = document.getElementById('emptyPreview');
            empty.style.display = 'none';
            display.style.display = 'block';
            display.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-400"></i><p class="mt-3 text-gray-400">Loading document...</p></div>';
            
            // Reset annotations for new document
            documentAnnotations = {
                documentId: id,
                originalHash: null,
                annotations: [],
                showAnnotations: true
            };
            
            try {
                // Try to get document content
                const contentResponse = await fetch(`/api/documents/${id}/content`, { credentials: 'include' });
                if (contentResponse.ok) {
                    const contentType = contentResponse.headers.get('content-type');
                    const blob = await contentResponse.blob();
                    
                    if (contentType?.startsWith('image/')) {
                        const url = URL.createObjectURL(blob);
                        // Wrap image for annotation layer
                        const wrapper = document.createElement('div');
                        wrapper.className = 'pdf-page';
                        wrapper.id = 'imagePage1';
                        wrapper.style.display = 'inline-block';
                        
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'Document';
                        img.style.display = 'block';
                        img.style.maxWidth = '100%';
                        
                        wrapper.appendChild(img);
                        display.innerHTML = '';
                        display.appendChild(wrapper);
                        
                        img.onload = () => {
                            addAnnotationLayer(wrapper, 1);
                            loadAnnotationsFromStorage();
                        };
                    } else if (contentType === 'application/pdf') {
                        // Use PDF.js for multi-page rendering (includes annotation layers)
                        const arrayBuffer = await blob.arrayBuffer();
                        await renderPDFFromData(arrayBuffer, display);
                    } else {
                        const text = await blob.text();
                        display.innerHTML = `<div class="document-text" id="docText">${escapeHtml(text)}</div>`;
                        setupTextSelection();
                    }
                    return;
                }
                
                // Fallback: try text endpoint
                const textResponse = await fetch(`/api/documents/${id}/text`, { credentials: 'include' });
                if (textResponse.ok) {
                    const data = await textResponse.json();
                    const text = data.text || data.content || 'Document content not available';
                    display.innerHTML = `<div class="document-text" id="docText">${escapeHtml(text)}</div>`;
                    setupTextSelection();
                    return;
                }
                
                display.innerHTML = '<div class="text-center py-8 text-yellow-400"><i class="fas fa-file-alt text-4xl mb-3"></i><p>Preview not available</p><p class="text-sm text-gray-400 mt-2">Click Analyze to process this document</p></div>';
            } catch (err) {
                console.error('Preview load error:', err);
                display.innerHTML = '<div class="text-center py-8 text-red-400"><i class="fas fa-exclamation-circle text-2xl mb-2"></i><p>Error loading preview</p></div>';
            }
        }

        function openCloudPicker() {
            alert('Cloud storage picker coming soon');
        }

        // Save Functions - Annotations stored SEPARATELY from original document
        function saveDocument() {
            const data = {
                id: selectedFile?.id || `briefcase-${Date.now()}`,
                documentType: document.getElementById('docTypeSelect').value,
                extractedData: extractedData,
                filename: selectedFile?.name,
                savedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('briefcaseDocument', JSON.stringify(data));
            
            // Save annotations separately - NEVER modifies original
            saveAnnotationsToStorage();
            
            // Also save extraction to document-specific key
            if (selectedFile?.id) {
                localStorage.setItem(`extraction-${selectedFile.id}`, JSON.stringify(extractedData));
            }
            
            showToast('Document saved!', 'success');
        }

        async function saveToVault() {
            if (!selectedFile) {
                showToast('No document selected', 'error');
                return;
            }
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');
            document.getElementById('loadingText').textContent = 'Saving to vault...';
            document.getElementById('loadingStep').textContent = 'Uploading document';
            
            try {
                const formData = new FormData();
                
                if (!selectedFile.fromVault && selectedFile instanceof File) {
                    formData.append('file', selectedFile);
                } else if (selectedFile.fromVault) {
                    // Update existing vault document with new extraction
                    const updateResponse = await fetch(`/api/documents/${selectedFile.id}/update`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            document_type: document.getElementById('docTypeSelect').value,
                            extracted_data: extractedData
                        }),
                        credentials: 'include'
                    });
                    
                    if (updateResponse.ok) {
                        showToast('Vault document updated!', 'success');
                    } else {
                        // Save locally if API fails
                        localStorage.setItem(`extraction-${selectedFile.id}`, JSON.stringify(extractedData));
                        showToast('Saved locally!', 'success');
                    }
                    return;
                }
                
                formData.append('document_type', document.getElementById('docTypeSelect').value);
                
                const response = await fetch('/api/documents/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    selectedFile.id = result.id;
                    selectedFile.fromVault = true;
                    
                    // Save extraction data
                    localStorage.setItem(`extraction-${result.id}`, JSON.stringify(extractedData));
                    
                    showToast('Saved to vault!', 'success');
                } else {
                    // Fallback: save to localStorage
                    const localDocs = JSON.parse(localStorage.getItem('semptify_documents') || '[]');
                    const newDoc = {
                        id: `local-${Date.now()}`,
                        filename: selectedFile.name,
                        document_type: document.getElementById('docTypeSelect').value,
                        uploaded_at: new Date().toISOString(),
                        extracted_data: extractedData
                    };
                    localDocs.push(newDoc);
                    localStorage.setItem('semptify_documents', JSON.stringify(localDocs));
                    showToast('Saved locally!', 'success');
                }
            } catch (err) {
                console.error('Save error:', err);
                // Fallback to localStorage
                const localDocs = JSON.parse(localStorage.getItem('semptify_documents') || '[]');
                const newDoc = {
                    id: `local-${Date.now()}`,
                    filename: selectedFile.name,
                    document_type: document.getElementById('docTypeSelect').value,
                    uploaded_at: new Date().toISOString(),
                    extracted_data: extractedData
                };
                localDocs.push(newDoc);
                localStorage.setItem('semptify_documents', JSON.stringify(localDocs));
                showToast('Saved locally!', 'success');
            } finally {
                loading.classList.remove('active');
            }
        }

        // =====================================================================
        // DOCUMENT PROCESSING ENGINE - Color-Coded Extraction with Transparency
        // Shows WHAT was found, WHERE, and HOW it was detected
        // 14-COLOR EXTRACTION SYSTEM
        // =====================================================================
        
        const EXTRACTION_CODES = {
            // ORIGINAL 8 COLORS
            DT: { name: 'Dates & Deadlines', color: 'var(--hl-date)', icon: 'üìÖ', category: 'date' },
            PT: { name: 'Parties & Names', color: 'var(--hl-party)', icon: 'üë§', category: 'party' },
            '$': { name: 'Money & Amounts', color: 'var(--hl-amount)', icon: 'üí∞', category: 'amount' },
            AD: { name: 'Addresses', color: 'var(--hl-address)', icon: 'üìç', category: 'address' },
            LG: { name: 'Legal Terms', color: 'var(--hl-legal)', icon: '‚öñÔ∏è', category: 'legal' },
            NT: { name: 'Notes & Footnotes', color: 'var(--hl-note)', icon: 'üìù', category: 'note' },
            FM: { name: 'Form Fields', color: 'var(--hl-form)', icon: 'üìã', category: 'form' },
            EV: { name: 'Events & Actions', color: 'var(--hl-event)', icon: 'üìÜ', category: 'event' },
            // NEW 6 COLORS FOR ENHANCED SYSTEM
            DL: { name: 'Critical Deadline', color: 'var(--hl-deadline)', icon: 'üö®', category: 'deadline' },
            WS: { name: 'Witness/Testimony', color: 'var(--hl-witness)', icon: 'üëÅÔ∏è', category: 'witness' },
            VL: { name: 'Violation/Issue', color: 'var(--hl-violation)', icon: '‚ö†Ô∏è', category: 'violation' },
            ED: { name: 'Evidence', color: 'var(--hl-evidence)', icon: 'üîç', category: 'evidence' },
            QT: { name: 'Quoted Text', color: 'var(--hl-quote)', icon: 'üí¨', category: 'quote' },
            TL: { name: 'Timeline Key', color: 'var(--hl-timeline)', icon: 'üïê', category: 'timeline' }
        };
        
        // Event status options for timeline coordination
        const EVENT_STATUSES = {
            start: { label: 'Start', icon: '‚ñ∂Ô∏è', desc: 'Initiates a process' },
            continued: { label: 'Continued', icon: '‚è©', desc: 'Extends/continues process' },
            finish: { label: 'Finish', icon: '‚èπÔ∏è', desc: 'Concludes process' },
            reported: { label: 'Reported', icon: 'üì¢', desc: 'Issue/violation reported' },
            invited: { label: 'Invited', icon: 'üì®', desc: 'Meeting/hearing scheduled' },
            attended: { label: 'Attended', icon: '‚úÖ', desc: 'Event was attended' },
            missed: { label: 'Missed', icon: '‚ùå', desc: 'Event was missed/no-show' },
            served: { label: 'Served', icon: 'üì§', desc: 'Document was served' },
            received: { label: 'Received', icon: 'üì•', desc: 'Document was received' },
            filed: { label: 'Filed', icon: 'üìÅ', desc: 'Document filed with court' },
            responded: { label: 'Responded', icon: '‚Ü©Ô∏è', desc: 'Response submitted' },
            pending: { label: 'Pending', icon: '‚è≥', desc: 'Awaiting action' },
            resolved: { label: 'Resolved', icon: '‚úîÔ∏è', desc: 'Issue resolved' },
            escalated: { label: 'Escalated', icon: '‚¨ÜÔ∏è', desc: 'Escalated to higher level' },
            used: { label: 'Used', icon: 'üìé', desc: 'Used as evidence' }
        };
        
        const DETECTION_METHODS = {
            PATTERN: { label: 'Pattern Match', desc: 'Matched regex pattern', badge: 'pattern' },
            KEYWORD: { label: 'Keyword', desc: 'Known keyword found', badge: 'keyword' },
            CONTEXT: { label: 'Context', desc: 'Inferred from context', badge: 'context' },
            AI: { label: 'AI', desc: 'AI/ML recognition', badge: 'ai' },
            MANUAL: { label: 'Manual', desc: 'User marked', badge: 'manual' },
            FORM_FIELD: { label: 'Form Field', desc: 'Form field extracted', badge: 'pattern' }
        };
        
        // Processing results with full transparency
        let processingResults = {
            documentId: null,
            filename: null,
            processedAt: null,
            extractions: [],  // Array of extraction objects with detection info
            formFields: [],   // Extracted form data
            linkedEvents: []  // Date-to-event links
        };
        
        // Generate extraction ID with code prefix
        function generateExtractionId(code, num) {
            return `${code}-${num}`;
        }
        
        // Add extraction with detection method
        function addExtraction(data) {
            const code = getCodeForCategory(data.category);
            const num = processingResults.extractions.filter(e => e.code === code).length + 1;
            
            const extraction = {
                id: generateExtractionId(code, num),
                code: code,
                num: num,
                category: data.category,
                value: data.value,
                rawValue: data.rawValue || data.value,
                confidence: data.confidence || 1.0,
                detectionMethod: data.detectionMethod || 'MANUAL',
                detectionContext: data.detectionContext || '',
                page: data.page || 1,
                position: data.position || null,  // { x, y, width, height }
                linkedTo: data.linkedTo || null,  // For date-event linking
                formFieldName: data.formFieldName || null,
                timestamp: new Date().toISOString()
            };
            
            processingResults.extractions.push(extraction);
            
            // Render annotation with detection badge
            if (extraction.position) {
                renderExtractionAnnotation(extraction);
            }
            
            // Add to field panel
            addFieldItemWithDetection(extraction);
            
            return extraction;
        }
        
        function getCodeForCategory(category) {
            const codeMap = {
                // Original 8
                'date': 'DT', 'party': 'PT', 'amount': '$', 'address': 'AD',
                'legal': 'LG', 'note': 'NT', 'form': 'FM', 'event': 'EV',
                // New 6
                'deadline': 'DL', 'witness': 'WS', 'violation': 'VL',
                'evidence': 'ED', 'quote': 'QT', 'timeline': 'TL'
            };
            return codeMap[category] || 'NT';
        }
        
        // Render extraction annotation with detection method badge
        function renderExtractionAnnotation(extraction) {
            const layer = document.getElementById(`annotationLayer-${extraction.page}`);
            if (!layer) return;
            
            const highlight = document.createElement('div');
            highlight.className = `annotation-highlight ${extraction.category}`;
            highlight.id = `extraction-${extraction.id}`;
            highlight.dataset.extractionId = extraction.id;
            
            if (extraction.position) {
                highlight.style.left = extraction.position.x + '%';
                highlight.style.top = extraction.position.y + '%';
                highlight.style.width = extraction.position.width + '%';
                highlight.style.height = extraction.position.height + '%';
            }
            
            highlight.title = `${extraction.code}-${extraction.num}: ${extraction.value}`;
            
            // Marker with code
            const marker = document.createElement('span');
            marker.className = `annotation-marker ${extraction.category}`;
            marker.textContent = `${extraction.code}-${extraction.num}`;
            highlight.appendChild(marker);
            
            // Detection method badge
            const method = DETECTION_METHODS[extraction.detectionMethod];
            if (method) {
                const badge = document.createElement('span');
                badge.className = `detection-badge ${method.badge}`;
                badge.textContent = method.label;
                badge.title = method.desc;
                highlight.appendChild(badge);
            }
            
            // Click to highlight in panel
            highlight.addEventListener('click', (e) => {
                e.stopPropagation();
                highlightInPanel(extraction.id);
            });
            
            layer.appendChild(highlight);
        }
        
        // Add field item with detection info shown
        function addFieldItemWithDetection(extraction) {
            const container = document.getElementById(`${extraction.category}Fields`);
            if (!container) return;
            
            const method = DETECTION_METHODS[extraction.detectionMethod] || {};
            const codeInfo = EXTRACTION_CODES[extraction.code] || {};
            
            const html = `
                <div class="field-item ${extraction.category}" id="field-${extraction.id}" data-extraction-id="${extraction.id}">
                    <span class="extraction-code" style="background: ${codeInfo.color}; color: white;">
                        ${extraction.code}-${extraction.num}
                    </span>
                    <div class="field-content">
                        <div class="field-label" style="display: flex; align-items: center; gap: 0.5rem;">
                            ${codeInfo.icon || ''} ${extraction.category} 
                            <span class="detection-badge ${method.badge || ''}" style="position: static; font-size: 8px;">
                                ${method.label || extraction.detectionMethod}
                            </span>
                            ${extraction.confidence < 1 ? `<span style="color: #f97316; font-size: 8px;">${Math.round(extraction.confidence * 100)}%</span>` : ''}
                        </div>
                        <input type="text" class="field-input" value="${escapeHtml(extraction.value)}" 
                               onchange="updateExtractionValue('${extraction.id}', this.value)">
                        ${extraction.detectionContext ? `<div class="text-xs text-gray-500 mt-1">üìç ${escapeHtml(extraction.detectionContext)}</div>` : ''}
                        ${extraction.formFieldName ? `<div class="text-xs text-pink-400 mt-1">üìã Form: ${escapeHtml(extraction.formFieldName)}</div>` : ''}
                    </div>
                    <div class="field-actions">
                        <button class="field-action-btn" onclick="scrollToExtraction('${extraction.id}')" title="Show in document">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${extraction.category === 'date' ? `
                        <button class="field-action-btn" onclick="linkDateToEvent('${extraction.id}')" title="Link to Event" style="background: rgba(6, 182, 212, 0.3);">
                            <i class="fas fa-link"></i>
                        </button>
                        ` : ''}
                        <button class="field-action-btn delete" onclick="deleteExtraction('${extraction.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
            
            // Update count
            const count = document.querySelectorAll(`#${extraction.category}Fields .field-item`).length;
            document.getElementById(`${extraction.category}Count`).textContent = count;
        }
        
        function updateExtractionValue(id, value) {
            const ext = processingResults.extractions.find(e => e.id === id);
            if (ext) {
                ext.value = value;
                ext.detectionMethod = 'MANUAL';  // User edited = manual now
            }
        }
        
        function deleteExtraction(id) {
            const idx = processingResults.extractions.findIndex(e => e.id === id);
            if (idx === -1) return;
            
            const ext = processingResults.extractions[idx];
            processingResults.extractions.splice(idx, 1);
            
            // Remove from DOM
            document.getElementById(`field-${id}`)?.remove();
            document.getElementById(`extraction-${id}`)?.remove();
            
            // Update count
            const count = document.querySelectorAll(`#${ext.category}Fields .field-item`).length;
            document.getElementById(`${ext.category}Count`).textContent = count;
        }
        
        function scrollToExtraction(id) {
            const el = document.getElementById(`extraction-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.animation = 'pulse 0.5s ease 3';
            }
        }
        
        function highlightInPanel(id) {
            const el = document.getElementById(`field-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.background = 'rgba(59, 130, 246, 0.3)';
                setTimeout(() => el.style.background = '', 2000);
            }
        }
        
        function linkDateToEvent(dateId) {
            const ext = processingResults.extractions.find(e => e.id === dateId);
            if (!ext) return;
            
            const eventTitle = prompt(`Link date "${ext.value}" to event:\nEnter event description:`);
            if (eventTitle) {
                ext.linkedTo = eventTitle;
                processingResults.linkedEvents.push({
                    dateId: dateId,
                    dateValue: ext.value,
                    eventTitle: eventTitle,
                    linkedAt: new Date().toISOString()
                });
                
                // Add to extracted dates for timeline
                extractedData.dates.push({
                    value: ext.value,
                    label: eventTitle,
                    linkedFrom: dateId
                });
                
                showToast(`üìÜ Linked: ${ext.value} ‚Üí ${eventTitle}`, 'success');
            }
        }
        
        // =====================================================================
        // FORM DATA EXTRACTION - Detects and extracts form fields
        // =====================================================================
        
        const FORM_FIELD_PATTERNS = [
            // Common form fields
            { pattern: /(?:Name|Full Name|Tenant Name|Landlord Name)\s*[:\-_]?\s*(.+?)(?:\n|$)/gi, field: 'Name', category: 'party' },
            { pattern: /(?:Address|Property Address|Street Address)\s*[:\-_]?\s*(.+?)(?:\n|$)/gi, field: 'Address', category: 'address' },
            { pattern: /(?:Date|Move.?in Date|Lease Start|Start Date)\s*[:\-_]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\w+\s+\d{1,2},?\s+\d{4})/gi, field: 'Date', category: 'date' },
            { pattern: /(?:Rent|Monthly Rent|Amount Due|Total)\s*[:\-_]?\s*\$?([\d,]+\.?\d{0,2})/gi, field: 'Amount', category: 'amount' },
            { pattern: /(?:Phone|Telephone|Cell)\s*[:\-_]?\s*([\d\-\(\)\s\.]+)/gi, field: 'Phone', category: 'party' },
            { pattern: /(?:Email|E-mail)\s*[:\-_]?\s*([\w\.\-]+@[\w\.\-]+\.\w+)/gi, field: 'Email', category: 'party' },
            { pattern: /(?:Unit|Apt|Apartment|Suite)\s*[#:\-_]?\s*(\w+)/gi, field: 'Unit', category: 'address' },
            { pattern: /(?:Case|Case No|Case Number)\s*[#:\-_]?\s*([\w\-]+)/gi, field: 'Case Number', category: 'legal' },
            { pattern: /(?:Deposit|Security Deposit)\s*[:\-_]?\s*\$?([\d,]+\.?\d{0,2})/gi, field: 'Deposit', category: 'amount' },
            { pattern: /(?:Due Date|Payment Due|Due By)\s*[:\-_]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\w+\s+\d{1,2},?\s+\d{4})/gi, field: 'Due Date', category: 'date' },
        ];
        
        function extractFormData(text) {
            const results = [];
            
            FORM_FIELD_PATTERNS.forEach(fp => {
                let match;
                const regex = new RegExp(fp.pattern.source, fp.pattern.flags);
                
                while ((match = regex.exec(text)) !== null) {
                    const value = match[1]?.trim();
                    if (value && value.length > 1) {
                        results.push({
                            category: fp.category,
                            value: value,
                            formFieldName: fp.field,
                            detectionMethod: 'FORM_FIELD',
                            detectionContext: `Form field: ${fp.field}`,
                            confidence: 0.95
                        });
                    }
                }
            });
            
            // Store form fields separately
            processingResults.formFields = results.map(r => ({
                field: r.formFieldName,
                value: r.value,
                category: r.category
            }));
            
            return results;
        }
        
        // =====================================================================
        // PATTERN-BASED EXTRACTION - Shows detection method
        // =====================================================================
        
        const EXTRACTION_PATTERNS = {
            dates: [
                { pattern: /\b(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}\b/gi, method: 'PATTERN', context: 'Month DD, YYYY format' },
                { pattern: /\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g, method: 'PATTERN', context: 'MM/DD/YYYY format' },
                { pattern: /\b\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}\b/g, method: 'PATTERN', context: 'YYYY-MM-DD format' },
                { pattern: /(?:due|by|before|after|on or about|dated)\s+(.+?)(?:\.|,|\n)/gi, method: 'CONTEXT', context: 'Deadline context' }
            ],
            amounts: [
                { pattern: /\$[\d,]+(?:\.\d{2})?/g, method: 'PATTERN', context: 'Dollar amount' },
                { pattern: /(?:rent|fee|deposit|payment|amount|total|due|owed|balance)\s*(?:of|is|:)?\s*\$?([\d,]+\.?\d{0,2})/gi, method: 'CONTEXT', context: 'Money context' }
            ],
            addresses: [
                { pattern: /\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Boulevard|Blvd|Road|Rd|Drive|Dr|Lane|Ln|Court|Ct|Way|Circle|Cir)\.?\s*(?:#?\d*\w*)?,?\s*(?:[\w\s]+,?\s*)?(?:CA|California|NY|TX|FL|IL|PA|OH|GA|NC|MI|NJ|VA|WA|AZ|MA|TN|IN|MO|MD|WI|CO|MN|SC|AL|LA|KY|OR|OK|CT|UT|IA|NV|AR|MS|KS|NM|NE|WV|ID|HI|NH|ME|MT|RI|DE|SD|ND|AK|DC|VT|WY)\s*\d{5}(?:-\d{4})?/gi, method: 'PATTERN', context: 'Full address with ZIP' },
                { pattern: /\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Boulevard|Blvd|Road|Rd|Drive|Dr|Lane|Ln|Court|Ct|Way|Circle|Cir)\.?(?:\s*(?:#|Apt|Unit|Suite)?\s*[\dA-Za-z]+)?/gi, method: 'PATTERN', context: 'Street address' }
            ],
            parties: [
                { pattern: /(?:Dear|To:|From:|Tenant:|Landlord:|Owner:|Plaintiff:|Defendant:|Re:)\s*([A-Z][a-zA-Z\s,\.]+?)(?:\n|,|;|\()/gi, method: 'CONTEXT', context: 'Role-based name' },
                { pattern: /(?:signed|executed|witnessed)\s+by\s+([A-Z][a-zA-Z\s]+)/gi, method: 'CONTEXT', context: 'Signature context' }
            ],
            legal: [
                { pattern: /(?:Section|¬ß)\s*\d+(?:\.\d+)*(?:\([a-zA-Z0-9]+\))*/gi, method: 'PATTERN', context: 'Section reference' },
                { pattern: /(?:Code|Civil Code|Penal Code|CCP|CRC)\s*(?:Section|¬ß)?\s*\d+/gi, method: 'PATTERN', context: 'Legal code' },
                { pattern: /\b(?:unlawful detainer|eviction|notice to quit|notice to pay|breach|default|violation)\b/gi, method: 'KEYWORD', context: 'Legal term' }
            ]
        };
        
        function runPatternExtraction(text) {
            const extractions = [];
            
            // Run all pattern categories
            Object.entries(EXTRACTION_PATTERNS).forEach(([category, patterns]) => {
                patterns.forEach(p => {
                    let match;
                    const regex = new RegExp(p.pattern.source, p.pattern.flags);
                    
                    while ((match = regex.exec(text)) !== null) {
                        const value = match[1] || match[0];
                        if (value && value.trim().length > 1) {
                            // Avoid duplicates
                            const exists = extractions.some(e => 
                                e.category === category && 
                                e.value.toLowerCase() === value.trim().toLowerCase()
                            );
                            
                            if (!exists) {
                                extractions.push({
                                    category: category === 'amounts' ? 'amount' : 
                                              category === 'dates' ? 'date' : 
                                              category === 'addresses' ? 'address' :
                                              category === 'parties' ? 'party' : category,
                                    value: value.trim(),
                                    detectionMethod: p.method,
                                    detectionContext: p.context,
                                    confidence: p.method === 'PATTERN' ? 0.95 : 0.85
                                });
                            }
                        }
                    }
                });
            });
            
            return extractions;
        }
        
        // =====================================================================
        // EDITABLE FILENAME - User can rename document
        // =====================================================================
        
        function enableFilenameEdit() {
            const display = document.getElementById('fileNameDisplay');
            const currentName = display.textContent || 'Document';
            
            display.innerHTML = `
                <input type="text" id="filenameInput" value="${escapeHtml(currentName)}" 
                       class="bg-transparent border-b border-blue-500 text-white px-1 focus:outline-none"
                       style="min-width: 150px;"
                       onkeydown="if(event.key==='Enter') saveFilename()"
                       onblur="saveFilename()">
                <button onclick="saveFilename()" class="ml-2 text-green-400 hover:text-green-300">
                    <i class="fas fa-check"></i>
                </button>
            `;
            
            document.getElementById('filenameInput').focus();
            document.getElementById('filenameInput').select();
        }
        
        function saveFilename() {
            const input = document.getElementById('filenameInput');
            if (!input) return;
            
            const newName = input.value.trim() || 'Document';
            
            // Update selectedFile
            if (selectedFile) {
                selectedFile.displayName = newName;
                processingResults.filename = newName;
            }
            
            // Update display
            const display = document.getElementById('fileNameDisplay');
            display.innerHTML = `
                <span onclick="enableFilenameEdit()" class="cursor-pointer hover:text-blue-400" title="Click to rename">
                    ${escapeHtml(newName)} <i class="fas fa-edit text-xs ml-1 opacity-50"></i>
                </span>
            `;
            
            showToast('üìù Filename updated', 'success');
        }
        
        // Make filename editable on load
        function setupFilenameEdit() {
            const display = document.getElementById('fileNameDisplay');
            if (display && display.textContent !== 'No document selected') {
                const name = display.textContent;
                display.innerHTML = `
                    <span onclick="enableFilenameEdit()" class="cursor-pointer hover:text-blue-400" title="Click to rename">
                        ${escapeHtml(name)} <i class="fas fa-edit text-xs ml-1 opacity-50"></i>
                    </span>
                `;
            }
        }
        
        // =====================================================================
        // COLOR KEY LEGEND - Shows what each color means
        // =====================================================================
        
        function showColorKeyLegend() {
            // Remove existing
            document.getElementById('colorKeyLegend')?.remove();
            
            const legend = document.createElement('div');
            legend.className = 'color-key-legend';
            legend.id = 'colorKeyLegend';
            
            legend.innerHTML = Object.entries(EXTRACTION_CODES).map(([code, info]) => `
                <div class="color-key-item">
                    <div class="color-key-dot" style="background: ${info.color};"></div>
                    <span class="color-key-code">${code}</span>
                    <span>${info.icon}</span>
                </div>
            `).join('') + `
                <button onclick="hideColorKeyLegend()" class="text-gray-400 hover:text-white ml-2">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(legend);
        }
        
        function hideColorKeyLegend() {
            document.getElementById('colorKeyLegend')?.remove();
        }
        
        // Show legend when processing starts
        function toggleColorKeyLegend() {
            const legend = document.getElementById('colorKeyLegend');
            if (legend) {
                hideColorKeyLegend();
            } else {
                showColorKeyLegend();
            }
        }
        
        // =====================================================================
        // ENHANCED PROCESS DOCUMENT - Uses transparent extraction
        // =====================================================================
        
        async function processDocumentWithTransparency() {
            if (!selectedFile) return;
            
            // Initialize processing results
            processingResults = {
                documentId: selectedFile.id || `doc-${Date.now()}`,
                filename: selectedFile.displayName || selectedFile.name,
                processedAt: new Date().toISOString(),
                extractions: [],
                formFields: [],
                linkedEvents: []
            };
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');
            
            try {
                let text = '';
                
                // Get document text (same as before)
                document.getElementById('loadingText').textContent = 'Reading document...';
                document.getElementById('loadingStep').textContent = 'Extracting text';
                
                if (selectedFile.fromVault) {
                    const textResponse = await fetch(`/api/documents/${selectedFile.id}/text`, { credentials: 'include' });
                    if (textResponse.ok) {
                        const data = await textResponse.json();
                        text = data.text || data.content || '';
                    }
                } else {
                    const isImage = selectedFile.type?.startsWith('image/') || /\.(jpg|jpeg|png|gif|bmp|tiff|webp)$/i.test(selectedFile.name);
                    const isPDF = selectedFile.type === 'application/pdf' || selectedFile.name?.toLowerCase().endsWith('.pdf');
                    
                    if (isImage || isPDF) {
                        text = await performOCR(selectedFile);
                    } else {
                        text = await readFileAsText(selectedFile);
                    }
                }
                
                if (text && text.length >= 10) {
                    document.getElementById('loadingText').textContent = 'Analyzing with transparency...';
                    document.getElementById('loadingStep').textContent = 'Showing detection methods';
                    
                    // Show color key legend
                    showColorKeyLegend();
                    
                    // 1. Extract form data first
                    const formExtractions = extractFormData(text);
                    formExtractions.forEach(fe => addExtraction(fe));
                    
                    // 2. Run pattern extraction
                    const patternExtractions = runPatternExtraction(text);
                    patternExtractions.forEach(pe => addExtraction(pe));
                    
                    // 3. Try AI extraction if available
                    try {
                        const response = await fetch('/api/recognition/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: text,
                                filename: selectedFile.name,
                                include_handwriting: false
                            }),
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            
                            // Add AI extractions with AI method
                            (result.entities || []).forEach(entity => {
                                const category = mapEntityToCategory(entity.type);
                                if (category) {
                                    // Check if not already extracted
                                    const exists = processingResults.extractions.some(e =>
                                        e.category === category &&
                                        e.value.toLowerCase() === entity.value.toLowerCase()
                                    );
                                    
                                    if (!exists) {
                                        addExtraction({
                                            category: category,
                                            value: entity.value,
                                            detectionMethod: 'AI',
                                            detectionContext: `AI confidence: ${Math.round(entity.confidence * 100)}%`,
                                            confidence: entity.confidence
                                        });
                                    }
                                }
                            });
                        }
                    } catch (aiErr) {
                        console.warn('AI extraction unavailable:', aiErr);
                    }
                    
                    // Setup filename editing
                    setupFilenameEdit();
                    
                    // Summary
                    const total = processingResults.extractions.length;
                    const byMethod = {};
                    processingResults.extractions.forEach(e => {
                        byMethod[e.detectionMethod] = (byMethod[e.detectionMethod] || 0) + 1;
                    });
                    
                    let methodSummary = Object.entries(byMethod)
                        .map(([m, c]) => `${c} ${DETECTION_METHODS[m]?.label || m}`)
                        .join(', ');
                    
                    showToast(`‚ú® Found ${total} items (${methodSummary})`, 'success');
                    
                } else {
                    showToast('Could not extract text. Try adding highlights manually.', 'error');
                }
                
            } catch (err) {
                console.error('Processing error:', err);
                showToast('Processing failed. Please try again.', 'error');
            } finally {
                loading.classList.remove('active');
            }
        }
        
        function mapEntityToCategory(entityType) {
            const typeMap = {
                'date': 'date', 'deadline': 'date', 'notice_date': 'date', 'expiration': 'date',
                'person': 'party', 'organization': 'party', 'landlord': 'party', 'tenant': 'party',
                'money': 'amount', 'amount': 'amount', 'rent': 'amount', 'fee': 'amount',
                'address': 'address', 'location': 'address', 'property': 'address'
            };
            return typeMap[entityType?.toLowerCase()];
        }
        
        // Override the old processDocument to use new transparent version
        const originalProcessDocument = processDocument;
        processDocument = processDocumentWithTransparency;

        // =====================================================================
        // Timeline Integration - Send extracted dates to Timeline Builder
        // =====================================================================
        
        let timelineEvents = [];
        
        function openTimelineModal() {
            const modal = document.getElementById('timelineModal');
            modal.classList.add('active');
            populateTimelineDates();
        }
        
        function closeTimelineModal() {
            document.getElementById('timelineModal').classList.remove('active');
        }
        
        function populateTimelineDates() {
            const list = document.getElementById('timelineDatesList');
            timelineEvents = [];
            
            // Get all extracted dates
            const dates = extractedData.dates || [];
            
            if (dates.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-6 text-gray-400">
                        <i class="fas fa-calendar-times text-3xl mb-3"></i>
                        <p>No dates extracted yet</p>
                        <p class="text-sm mt-2">Analyze your document to find dates, or add custom events below</p>
                    </div>
                `;
                return;
            }
            
            // Map document type to event type
            const docType = document.getElementById('docTypeSelect').value;
            const eventTypeMap = {
                'lease': 'notice',
                'eviction': 'court',
                'notice': 'notice',
                'receipt': 'payment',
                'repair': 'maintenance',
                'court': 'court',
                'letter': 'communication',
                'other': 'other'
            };
            const defaultEventType = eventTypeMap[docType] || 'other';
            
            list.innerHTML = dates.map((d, i) => {
                const dateValue = d.value || d;
                const label = d.label || `Date ${i + 1}`;
                timelineEvents.push({
                    id: i,
                    date: dateValue,
                    title: `${label} - ${selectedFile?.name || 'Document'}`,
                    type: defaultEventType,
                    selected: true
                });
                
                return `
                    <div class="timeline-event-item" data-index="${i}">
                        <input type="checkbox" id="tlDate${i}" checked onchange="toggleTimelineEvent(${i})">
                        <div class="event-date">${escapeHtml(dateValue)}</div>
                        <input type="text" class="event-label flex-1 px-2 py-1 bg-transparent border-b border-gray-600 text-white text-sm" 
                               value="${escapeHtml(label)}" 
                               onchange="updateTimelineEventTitle(${i}, this.value)"
                               placeholder="Event description">
                        <select class="event-type-select" onchange="updateTimelineEventType(${i}, this.value)">
                            <option value="notice" ${defaultEventType === 'notice' ? 'selected' : ''}>üìã Notice</option>
                            <option value="payment" ${defaultEventType === 'payment' ? 'selected' : ''}>üí∞ Payment</option>
                            <option value="maintenance" ${defaultEventType === 'maintenance' ? 'selected' : ''}>üîß Maintenance</option>
                            <option value="communication" ${defaultEventType === 'communication' ? 'selected' : ''}>‚úâÔ∏è Communication</option>
                            <option value="court" ${defaultEventType === 'court' ? 'selected' : ''}>‚öñÔ∏è Court</option>
                            <option value="other" ${defaultEventType === 'other' ? 'selected' : ''}>üìå Other</option>
                        </select>
                    </div>
                `;
            }).join('');
        }
        
        function toggleTimelineEvent(index) {
            if (timelineEvents[index]) {
                timelineEvents[index].selected = !timelineEvents[index].selected;
            }
        }
        
        function updateTimelineEventTitle(index, title) {
            if (timelineEvents[index]) {
                timelineEvents[index].title = title;
            }
        }
        
        function updateTimelineEventType(index, type) {
            if (timelineEvents[index]) {
                timelineEvents[index].type = type;
            }
        }
        
        function addCustomTimelineEvent() {
            const dateInput = document.getElementById('customEventDate');
            const titleInput = document.getElementById('customEventTitle');
            
            const date = dateInput.value.trim();
            const title = titleInput.value.trim();
            
            if (!date) {
                showToast('Please enter a date', 'error');
                return;
            }
            
            // Add to dates extracted data
            const num = extractedData.dates.length + 1;
            extractedData.dates.push({ value: date, label: title || 'Custom Event', num });
            
            // Add to field display
            fieldCounters.date++;
            addFieldItem('date', date, fieldCounters.date);
            
            // Refresh timeline modal
            populateTimelineDates();
            
            // Clear inputs
            dateInput.value = '';
            titleInput.value = '';
            
            showToast('Event added!', 'success');
        }
        
        async function sendToTimeline() {
            const selectedEvents = timelineEvents.filter(e => e.selected);
            
            if (selectedEvents.length === 0) {
                showToast('No events selected', 'error');
                return;
            }
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');
            document.getElementById('loadingText').textContent = 'Adding to timeline...';
            document.getElementById('loadingStep').textContent = `Sending ${selectedEvents.length} events`;
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const event of selectedEvents) {
                try {
                    // Parse the date to ISO format
                    const isoDate = parseToISODate(event.date);
                    
                    const response = await fetch('/api/timeline/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event_type: event.type,
                            title: event.title,
                            description: `Extracted from: ${selectedFile?.name || 'Document'}`,
                            event_date: isoDate,
                            document_id: selectedFile?.id || null,
                            is_evidence: false
                        }),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.warn('Failed to add event:', await response.text());
                    }
                } catch (err) {
                    errorCount++;
                    console.error('Timeline API error:', err);
                }
            }
            
            loading.classList.remove('active');
            closeTimelineModal();
            
            if (successCount > 0) {
                showToast(`‚úÖ Added ${successCount} event${successCount > 1 ? 's' : ''} to timeline!`, 'success');
            }
            if (errorCount > 0) {
                showToast(`‚ö†Ô∏è ${errorCount} event${errorCount > 1 ? 's' : ''} failed to add`, 'error');
            }
            
            // Also save to localStorage for Timeline Builder
            saveEventsToLocalStorage(selectedEvents);
        }
        
        function parseToISODate(dateStr) {
            // Try to parse various date formats
            const str = dateStr.trim();
            
            // Try native Date parsing first
            let date = new Date(str);
            if (!isNaN(date.getTime())) {
                return date.toISOString();
            }
            
            // Try common formats
            // "December 15, 2025" or "Dec 15, 2025"
            const monthMatch = str.match(/^(Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\s+(\d{1,2}),?\s+(\d{4})$/i);
            if (monthMatch) {
                const months = { jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5, jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11 };
                const m = months[monthMatch[1].substring(0, 3).toLowerCase()];
                const d = parseInt(monthMatch[2]);
                const y = parseInt(monthMatch[3]);
                return new Date(y, m, d).toISOString();
            }
            
            // "12/15/2025" or "12-15-2025"
            const slashMatch = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
            if (slashMatch) {
                let y = parseInt(slashMatch[3]);
                if (y < 100) y += 2000;
                return new Date(y, parseInt(slashMatch[1]) - 1, parseInt(slashMatch[2])).toISOString();
            }
            
            // "2025-12-15"
            const isoMatch = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
            if (isoMatch) {
                return new Date(parseInt(isoMatch[1]), parseInt(isoMatch[2]) - 1, parseInt(isoMatch[3])).toISOString();
            }
            
            // Fallback: use today's date with a note
            console.warn('Could not parse date:', str, '- using current date');
            return new Date().toISOString();
        }
        
        function saveEventsToLocalStorage(events) {
            // Save events for Timeline Builder to pick up
            const existingEvents = JSON.parse(localStorage.getItem('briefcase_timeline_events') || '[]');
            
            const newEvents = events.map(e => ({
                id: `briefcase-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                date: parseToISODate(e.date),
                title: e.title,
                type: e.type,
                source: 'briefcase',
                documentName: selectedFile?.name || 'Unknown',
                documentId: selectedFile?.id || null,
                createdAt: new Date().toISOString()
            }));
            
            localStorage.setItem('briefcase_timeline_events', JSON.stringify([...existingEvents, ...newEvents]));
        }
        
        function openTimelineBuilder() {
            // Save current events first
            const selectedEvents = timelineEvents.filter(e => e.selected);
            if (selectedEvents.length > 0) {
                saveEventsToLocalStorage(selectedEvents);
            }
            
            // Open Timeline Builder in new tab
            window.open('/static/timeline-builder.html', '_blank');
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle mr-2"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleMobilePanel(panel) {
            if (panel === 'file') document.getElementById('filePanel').classList.toggle('mobile-open');
            if (panel === 'fields') document.getElementById('fieldsPanel').classList.toggle('mobile-open');
        }

        function updateScanOptions() {
            // Could auto-adjust scan options based on doc type
        }

        // Hide tooltip on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.selection-tooltip') && !e.target.closest('.document-text')) {
                hideSelectionTooltip();
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof SemptifyNav !== 'undefined') SemptifyNav.init();
        });
    </script>

    <!-- Floating Help Button -->
    <a href="/static/briefcase-help.html" class="help-float" title="Help & Instructions">
        <i class="fas fa-question"></i>
    </a>

    <!-- Legal Vocabulary Panel -->
    <script src="/static/js/legal-vocabulary.js"></script>
</body>
</html>
