<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funding & Tax Credit Search - Semptify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--bg-card);
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--bg-card);
            border-radius: 12px;
        }
        
        .card-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--bg-primary);
            border-radius: 12px 12px 0 0 !important;
        }
        
        .card-header h5,
        .card-header p,
        .card-header small {
            color: var(--text-primary) !important;
        }
        
        .form-label {
            color: var(--text-primary) !important;
            font-weight: 500;
        }
        
        .form-control, .form-select {
            background: var(--bg-card);
            border: 1px solid #475569;
            color: var(--text-primary);
        }
        
        .form-control:focus, .form-select:focus {
            background: var(--bg-card);
            border-color: var(--accent);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
        }
        
        .form-control::placeholder {
            color: var(--text-secondary);
        }
        
        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }
        
        .btn-outline-primary {
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .btn-outline-primary:hover {
            background: var(--accent);
            color: white;
        }
        
        .nav-tabs {
            border-bottom: 1px solid var(--bg-card);
        }
        
        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--text-primary);
            border-bottom-color: var(--text-secondary);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--accent);
            background: transparent;
            border-bottom-color: var(--accent);
        }
        
        .result-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .program-badge {
            font-size: 0.75rem;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .badge-lihtc { background: #10b981; color: white; }
        .badge-nmtc { background: #3b82f6; color: white; }
        .badge-htc { background: #8b5cf6; color: white; }
        .badge-oz { background: #f59e0b; color: black; }
        .badge-hud { background: #ef4444; color: white; }
        .badge-179d { background: #06b6d4; color: black; }
        .badge-ra { background: #ec4899; color: white; }
        
        .status-active { color: var(--success); }
        .status-pending { color: var(--warning); }
        .status-expired { color: var(--danger); }
        
        .search-type-btn {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            background: var(--bg-card);
            border: 2px solid transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .search-type-btn:hover {
            border-color: var(--accent);
        }
        
        .search-type-btn.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .search-type-btn i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--accent);
        }
        
        .qualification-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-primary);
        }
        
        .qualification-item:last-child {
            border-bottom: none;
        }
        
        .qual-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
        }
        
        .qual-met { background: var(--success); }
        .qual-not-met { background: var(--danger); }
        .qual-partial { background: var(--warning); }
        
        .property-detail {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-primary);
        }
        
        .property-detail:last-child {
            border-bottom: none;
        }
        
        .property-detail-label {
            color: var(--text-secondary);
        }
        
        .property-detail-value {
            font-weight: 600;
        }
        
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .hidden { display: none !important; }
        
        .filter-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.75rem;
            background: var(--bg-card);
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-chip:hover {
            background: var(--accent);
        }
        
        .filter-chip.active {
            background: var(--accent);
        }
        
        .stats-card {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: 10px;
        }
        
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }
        
        .stats-card p {
            color: var(--text-secondary);
            margin: 0;
        }
        
        .detail-modal .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--bg-card);
        }
        
        .detail-modal .modal-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--bg-primary);
        }
        
        .detail-modal .modal-header h5 {
            color: var(--text-primary);
        }
        
        .detail-modal .btn-close {
            filter: invert(1);
        }
        
        .county-select {
            cursor: pointer;
        }
        
        .county-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Site-wide header -->
    <script src="/static/js/header.js"></script>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-check me-2"></i>Semptify
            </a>
            <div class="d-flex align-items-center">
                <span class="text-secondary me-3">Funding & Tax Credit Search</span>
                <a href="/dashboard.html" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Dashboard
                </a>
            </div>
        </div>
    </nav>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-overlay hidden">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Searching...</span>
            </div>
            <p class="mt-3 text-secondary">Searching funding programs...</p>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Search Panel -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-1"><i class="bi bi-search me-2"></i>Search Funding Programs</h5>
                        <p class="mb-0 text-secondary" style="font-size: 0.9rem;">Find LIHTC, NMTC, HUD, and other programs</p>
                    </div>
                    <div class="card-body">
                        <!-- Search Type Selection -->
                        <div class="mb-4">
                            <label class="form-label">Search By</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="search-type-btn active" onclick="setSearchType('address')" id="btn-address">
                                        <i class="bi bi-geo-alt"></i>
                                        <span>Address</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="search-type-btn" onclick="setSearchType('company')" id="btn-company">
                                        <i class="bi bi-building"></i>
                                        <span>Company</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="search-type-btn" onclick="setSearchType('broker')" id="btn-broker">
                                        <i class="bi bi-person-badge"></i>
                                        <span>Broker</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Input -->
                        <div class="mb-3" id="search-address-group">
                            <label class="form-label">Property Address</label>
                            <input type="text" class="form-control" id="searchAddress" placeholder="Enter address or city...">
                            <small class="text-secondary">Search by street address, city, or zip code</small>
                        </div>
                        
                        <div class="mb-3 hidden" id="search-company-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="searchCompany" placeholder="Enter company name...">
                            <small class="text-secondary">Search by landlord, developer, or owner name</small>
                        </div>
                        
                        <div class="mb-3 hidden" id="search-broker-group">
                            <label class="form-label">Broker Name</label>
                            <input type="text" class="form-control" id="searchBroker" placeholder="Enter broker name...">
                            <small class="text-secondary">Search by real estate broker or consultant</small>
                        </div>
                        
                        <!-- County Filter -->
                        <div class="mb-3">
                            <label class="form-label">County (Minnesota)</label>
                            <select class="form-select county-select" id="countyFilter">
                                <option value="">All Counties</option>
                                <option value="hennepin">Hennepin County</option>
                                <option value="ramsey">Ramsey County</option>
                                <option value="dakota">Dakota County</option>
                                <option value="anoka">Anoka County</option>
                                <option value="washington">Washington County</option>
                            </select>
                        </div>
                        
                        <!-- Program Type Filter -->
                        <div class="mb-3">
                            <label class="form-label">Program Types</label>
                            <div id="programFilters">
                                <span class="filter-chip active" data-program="all" onclick="toggleProgramFilter(this)">All Programs</span>
                                <span class="filter-chip" data-program="lihtc" onclick="toggleProgramFilter(this)">LIHTC</span>
                                <span class="filter-chip" data-program="nmtc" onclick="toggleProgramFilter(this)">NMTC</span>
                                <span class="filter-chip" data-program="htc" onclick="toggleProgramFilter(this)">Historic</span>
                                <span class="filter-chip" data-program="oz" onclick="toggleProgramFilter(this)">Opp Zone</span>
                                <span class="filter-chip" data-program="hud" onclick="toggleProgramFilter(this)">HUD</span>
                                <span class="filter-chip" data-program="179d" onclick="toggleProgramFilter(this)">179D</span>
                            </div>
                        </div>
                        
                        <!-- Search Button -->
                        <button class="btn btn-primary w-100 py-2" onclick="performSearch()">
                            <i class="bi bi-search me-2"></i>Search Programs
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Program Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stats-card">
                                    <h3 id="totalPrograms">8</h3>
                                    <p>Programs</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card">
                                    <h3 id="totalProperties">0</h3>
                                    <p>Properties</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- All Programs List -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Available Programs</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadAllPrograms()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                        <div id="programsList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1"><i class="bi bi-collection me-2"></i>Search Results</h5>
                                <p class="mb-0 text-secondary" style="font-size: 0.9rem;" id="resultCount">Search for properties with funding programs</p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="exportResults()">
                                    <i class="bi bi-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- No Results State -->
                        <div id="noResults" class="text-center py-5">
                            <i class="bi bi-building" style="font-size: 4rem; color: var(--text-secondary);"></i>
                            <h5 class="mt-3">Search for Funding Programs</h5>
                            <p class="text-secondary">Enter an address, company, or broker name to find properties with LIHTC, NMTC, HUD, and other funding programs.</p>
                        </div>
                        
                        <!-- Results List -->
                        <div id="resultsContainer" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Property Detail Modal -->
    <div class="modal fade detail-modal" id="propertyDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPropertyTitle">Property Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalPropertyBody">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="checkQualifications()">
                        <i class="bi bi-check-circle me-1"></i>Check Qualifications
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Program Detail Modal -->
    <div class="modal fade detail-modal" id="programDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProgramTitle">Program Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalProgramBody">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let currentSearchType = 'address';
        let currentResults = [];
        let selectedPrograms = ['all'];
        let allPrograms = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadAllPrograms();
            
            // Enter key handlers
            document.getElementById('searchAddress').addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('searchCompany').addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('searchBroker').addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
        });
        
        // Set search type
        function setSearchType(type) {
            currentSearchType = type;
            
            // Update buttons
            document.querySelectorAll('.search-type-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
            
            // Show/hide input groups
            document.getElementById('search-address-group').classList.toggle('hidden', type !== 'address');
            document.getElementById('search-company-group').classList.toggle('hidden', type !== 'company');
            document.getElementById('search-broker-group').classList.toggle('hidden', type !== 'broker');
        }
        
        // Toggle program filter
        function toggleProgramFilter(chip) {
            const program = chip.dataset.program;
            
            if (program === 'all') {
                selectedPrograms = ['all'];
                document.querySelectorAll('.filter-chip').forEach(c => {
                    c.classList.toggle('active', c.dataset.program === 'all');
                });
            } else {
                // Remove 'all' from selection
                selectedPrograms = selectedPrograms.filter(p => p !== 'all');
                document.querySelector('.filter-chip[data-program="all"]').classList.remove('active');
                
                // Toggle this program
                if (selectedPrograms.includes(program)) {
                    selectedPrograms = selectedPrograms.filter(p => p !== program);
                    chip.classList.remove('active');
                } else {
                    selectedPrograms.push(program);
                    chip.classList.add('active');
                }
                
                // If nothing selected, select 'all'
                if (selectedPrograms.length === 0) {
                    selectedPrograms = ['all'];
                    document.querySelector('.filter-chip[data-program="all"]').classList.add('active');
                }
            }
        }
        
        // Load all programs
        async function loadAllPrograms() {
            try {
                const response = await fetch('/api/funding/programs');
                const data = await response.json();
                allPrograms = data.programs || [];
                renderProgramsList(allPrograms);
                document.getElementById('totalPrograms').textContent = allPrograms.length;
            } catch (error) {
                console.error('Failed to load programs:', error);
            }
        }
        
        // Render programs list
        function renderProgramsList(programs) {
            const container = document.getElementById('programsList');
            
            if (!programs || programs.length === 0) {
                container.innerHTML = '<div class="p-3 text-center text-secondary">No programs found</div>';
                return;
            }
            
            container.innerHTML = programs.map(p => `
                <div class="d-flex align-items-center p-3 border-bottom" style="border-color: var(--bg-card) !important; cursor: pointer;" onclick="showProgramDetail('${p.id}')">
                    <span class="program-badge badge-${p.id.split('_')[0]}">${p.id.split('_')[0].toUpperCase()}</span>
                    <div class="ms-3 flex-grow-1">
                        <div class="fw-semibold">${p.name}</div>
                        <small class="text-secondary">${p.agency}</small>
                    </div>
                    <i class="bi bi-chevron-right text-secondary"></i>
                </div>
            `).join('');
        }
        
        // Perform search
        async function performSearch() {
            showLoading(true);
            
            try {
                let endpoint = '';
                let params = new URLSearchParams();
                
                const county = document.getElementById('countyFilter').value;
                if (county) params.append('county', county);
                
                // Add program filter
                if (!selectedPrograms.includes('all')) {
                    selectedPrograms.forEach(p => params.append('program_types', p));
                }
                
                switch (currentSearchType) {
                    case 'address':
                        const address = document.getElementById('searchAddress').value;
                        if (!address) {
                            alert('Please enter an address');
                            showLoading(false);
                            return;
                        }
                        params.append('address', address);
                        endpoint = '/api/funding/search/address';
                        break;
                        
                    case 'company':
                        const company = document.getElementById('searchCompany').value;
                        if (!company) {
                            alert('Please enter a company name');
                            showLoading(false);
                            return;
                        }
                        params.append('company', company);
                        endpoint = '/api/funding/search/company';
                        break;
                        
                    case 'broker':
                        const broker = document.getElementById('searchBroker').value;
                        if (!broker) {
                            alert('Please enter a broker name');
                            showLoading(false);
                            return;
                        }
                        params.append('broker', broker);
                        endpoint = '/api/funding/search/broker';
                        break;
                }
                
                const response = await fetch(`${endpoint}?${params.toString()}`);
                const data = await response.json();
                
                currentResults = data.results || [];
                renderResults(currentResults, data.total || 0);
                
            } catch (error) {
                console.error('Search failed:', error);
                alert('Search failed. Please try again.');
            } finally {
                showLoading(false);
            }
        }
        
        // Render results
        function renderResults(results, total) {
            const container = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            const resultCount = document.getElementById('resultCount');
            
            document.getElementById('totalProperties').textContent = total;
            
            if (!results || results.length === 0) {
                container.classList.add('hidden');
                noResults.classList.remove('hidden');
                noResults.innerHTML = `
                    <i class="bi bi-search" style="font-size: 4rem; color: var(--text-secondary);"></i>
                    <h5 class="mt-3">No Results Found</h5>
                    <p class="text-secondary">Try adjusting your search criteria or filters.</p>
                `;
                resultCount.textContent = 'No properties found';
                return;
            }
            
            noResults.classList.add('hidden');
            container.classList.remove('hidden');
            resultCount.textContent = `Found ${total} properties with funding programs`;
            
            container.innerHTML = results.map(property => `
                <div class="result-card" onclick="showPropertyDetail('${encodeURIComponent(property.address)}')">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">${property.address}</h6>
                            <small class="text-secondary">
                                <i class="bi bi-building me-1"></i>${property.owner || 'Unknown Owner'}
                                ${property.county ? `<span class="ms-2"><i class="bi bi-geo me-1"></i>${property.county} County</span>` : ''}
                            </small>
                        </div>
                        <span class="status-${property.status || 'active'}">
                            <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>
                            ${(property.status || 'Active').charAt(0).toUpperCase() + (property.status || 'active').slice(1)}
                        </span>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-1 mb-2">
                        ${(property.programs || []).map(prog => {
                            const progType = prog.toLowerCase().split(' ')[0];
                            return `<span class="program-badge badge-${progType}">${prog}</span>`;
                        }).join('')}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            ${property.units ? `<small class="text-secondary me-3"><i class="bi bi-door-closed me-1"></i>${property.units} units</small>` : ''}
                            ${property.total_credits ? `<small class="text-secondary"><i class="bi bi-currency-dollar me-1"></i>$${(property.total_credits / 1000000).toFixed(1)}M in credits</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showPropertyDetail('${encodeURIComponent(property.address)}')">
                            <i class="bi bi-arrow-right"></i> Details
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Show property detail
        async function showPropertyDetail(encodedAddress) {
            const address = decodeURIComponent(encodedAddress);
            
            try {
                // Try to enrich the property data
                const response = await fetch(`/api/funding/enrich/${encodeURIComponent(address)}`);
                const data = await response.json();
                
                const property = data.property || currentResults.find(r => r.address === address) || { address };
                
                document.getElementById('modalPropertyTitle').textContent = property.address;
                document.getElementById('modalPropertyBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">Property Information</h6>
                            <div class="property-detail">
                                <span class="property-detail-label">Address</span>
                                <span class="property-detail-value">${property.address}</span>
                            </div>
                            <div class="property-detail">
                                <span class="property-detail-label">Owner</span>
                                <span class="property-detail-value">${property.owner || 'Unknown'}</span>
                            </div>
                            <div class="property-detail">
                                <span class="property-detail-label">County</span>
                                <span class="property-detail-value">${property.county || 'Unknown'}</span>
                            </div>
                            <div class="property-detail">
                                <span class="property-detail-label">Units</span>
                                <span class="property-detail-value">${property.units || 'N/A'}</span>
                            </div>
                            <div class="property-detail">
                                <span class="property-detail-label">Year Built</span>
                                <span class="property-detail-value">${property.year_built || 'Unknown'}</span>
                            </div>
                            <div class="property-detail">
                                <span class="property-detail-label">Status</span>
                                <span class="property-detail-value status-${property.status || 'active'}">${(property.status || 'Active').charAt(0).toUpperCase() + (property.status || 'active').slice(1)}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">Funding Programs</h6>
                            ${(property.programs || []).map(prog => `
                                <div class="d-flex align-items-center p-2 mb-2" style="background: var(--bg-card); border-radius: 8px;">
                                    <span class="program-badge badge-${prog.toLowerCase().split(' ')[0]}">${prog}</span>
                                </div>
                            `).join('') || '<p class="text-secondary">No funding programs found</p>'}
                            
                            ${property.total_credits ? `
                                <div class="mt-3 p-3" style="background: var(--bg-card); border-radius: 8px;">
                                    <h6 class="text-secondary mb-1">Total Credits</h6>
                                    <h4 class="mb-0" style="color: var(--success);">$${(property.total_credits / 1000000).toFixed(2)}M</h4>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${property.broker ? `
                        <hr class="my-3" style="border-color: var(--bg-card);">
                        <h6 class="text-secondary mb-3">Broker Information</h6>
                        <div class="d-flex align-items-center p-3" style="background: var(--bg-card); border-radius: 8px;">
                            <i class="bi bi-person-badge" style="font-size: 2rem; color: var(--accent);"></i>
                            <div class="ms-3">
                                <div class="fw-semibold">${property.broker}</div>
                                <small class="text-secondary">Real Estate Broker</small>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                // Store current address for qualification check
                window.currentPropertyAddress = property.address;
                
                new bootstrap.Modal(document.getElementById('propertyDetailModal')).show();
                
            } catch (error) {
                console.error('Failed to load property detail:', error);
            }
        }
        
        // Check qualifications
        async function checkQualifications() {
            if (!window.currentPropertyAddress) return;
            
            try {
                const response = await fetch(`/api/funding/qualify/${encodeURIComponent(window.currentPropertyAddress)}`);
                const data = await response.json();
                
                const qualifications = data.qualifications || [];
                
                const qualHtml = qualifications.map(q => `
                    <div class="qualification-item">
                        <div class="qual-status ${q.meets_requirements ? 'qual-met' : 'qual-not-met'}">
                            <i class="bi bi-${q.meets_requirements ? 'check' : 'x'}" style="color: white;"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">${q.program_name}</div>
                            <small class="text-secondary">${q.notes || (q.meets_requirements ? 'Qualifies for this program' : 'Does not meet requirements')}</small>
                        </div>
                        <span class="program-badge badge-${q.program_id.split('_')[0]}">${q.program_id.split('_')[0].toUpperCase()}</span>
                    </div>
                `).join('');
                
                document.getElementById('modalPropertyBody').innerHTML += `
                    <hr class="my-3" style="border-color: var(--bg-card);">
                    <h6 class="text-secondary mb-3">Program Qualifications</h6>
                    <div class="p-3" style="background: var(--bg-card); border-radius: 8px;">
                        ${qualHtml || '<p class="text-secondary mb-0">No qualification data available</p>'}
                    </div>
                `;
                
            } catch (error) {
                console.error('Failed to check qualifications:', error);
            }
        }
        
        // Show program detail
        async function showProgramDetail(programId) {
            const program = allPrograms.find(p => p.id === programId);
            if (!program) return;
            
            try {
                const response = await fetch(`/api/funding/programs/${programId}`);
                const data = await response.json();
                const fullProgram = data.program || program;
                
                document.getElementById('modalProgramTitle').textContent = fullProgram.name;
                document.getElementById('modalProgramBody').innerHTML = `
                    <div class="mb-3">
                        <span class="program-badge badge-${programId.split('_')[0]}">${programId.split('_')[0].toUpperCase()}</span>
                    </div>
                    
                    <p>${fullProgram.description}</p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-2">Administering Agency</h6>
                            <p class="mb-0">${fullProgram.agency}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-2">Credit Type</h6>
                            <p class="mb-0">${fullProgram.credit_type || 'Tax Credit'}</p>
                        </div>
                    </div>
                    
                    ${fullProgram.requirements ? `
                        <hr class="my-3" style="border-color: var(--bg-card);">
                        <h6 class="text-secondary mb-3">Requirements</h6>
                        <ul class="mb-0">
                            ${fullProgram.requirements.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    ${fullProgram.benefits ? `
                        <hr class="my-3" style="border-color: var(--bg-card);">
                        <h6 class="text-secondary mb-3">Benefits</h6>
                        <ul class="mb-0">
                            ${fullProgram.benefits.map(b => `<li>${b}</li>`).join('')}
                        </ul>
                    ` : ''}
                `;
                
                new bootstrap.Modal(document.getElementById('programDetailModal')).show();
                
            } catch (error) {
                console.error('Failed to load program detail:', error);
            }
        }
        
        // Export results
        function exportResults() {
            if (!currentResults || currentResults.length === 0) {
                alert('No results to export');
                return;
            }
            
            const csv = [
                ['Address', 'Owner', 'County', 'Units', 'Programs', 'Status', 'Total Credits'].join(','),
                ...currentResults.map(r => [
                    `"${r.address || ''}"`,
                    `"${r.owner || ''}"`,
                    `"${r.county || ''}"`,
                    r.units || '',
                    `"${(r.programs || []).join('; ')}"`,
                    r.status || '',
                    r.total_credits || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `funding_search_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
